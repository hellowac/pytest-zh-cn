<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../search.html" /><link rel="next" title="如何用属性标记测试函数" href="mark.html" /><link rel="prev" title="如何在测试中编写和报告断言" href="assert.html" />
        <link rel="canonical" href="https://docs.pytest.org/en/stable/how-to/fixtures.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>如何使用 fixture - pytest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments_pytest.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/pytest-custom.css?v=eb7c59a4" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">pytest documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/pytest1.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">入门</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">操作指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 操作指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="usage.html">如何调用 pytest</a></li>
<li class="toctree-l2"><a class="reference internal" href="assert.html">如何在测试中编写和报告断言</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">如何使用 fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="mark.html">如何用属性标记测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="parametrize.html">如何参数化fixtures和测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="tmp_path.html">如何在测试中使用临时目录和文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="monkeypatch.html">如何使用 猴子补丁/mock 模块和环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="doctest.html">如何运行文档测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="cache.html">如何重新运行失败的测试并在测试运行之间保持状态</a></li>
<li class="toctree-l2"><a class="reference internal" href="failures.html">如何处理测试失败</a></li>
<li class="toctree-l2"><a class="reference internal" href="output.html">管理 pytest 的输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">如何管理日志记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-stdout-stderr.html">如何捕获 stdout/stderr 输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-warnings.html">如何捕获警告</a></li>
<li class="toctree-l2"><a class="reference internal" href="skipping.html">如何使用 skip 和 xfail 处理无法成功的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">如何安装和使用插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_plugins.html">编写插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_hook_functions.html">编写钩子函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="existingtestsuite.html">如何将 pytest 与现有测试套件结合使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="unittest.html">如何在 pytest 中使用基于 unittest 的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="xunit_setup.html">如何实现 xunit 样式的设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="bash-completion.html">如何设置 bash 补全</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">参考指南</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 参考指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/reference.html">API 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/fixtures.html">Fixtures 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/customize.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/exit-codes.html">退出码</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/plugin_list.html">Pytest 插件列表</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../explanation/index.html">解答</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 解答</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanation/anatomy.html">测试剖析</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/fixtures.html">关于 fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/goodpractices.html">良好的集成实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/pythonpath.html">pytest 导入机制和 <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> / <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/ci.html">CI Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/flaky.html">不稳定的测试</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../example/index.html">示例和自定义技巧</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 示例和自定义技巧</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../example/reportingdemo.html">使用 pytest 的 Python 故障报告演示</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/simple.html">基本模式和示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/parametrize.html">参数化测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/markers.html">使用自定义标记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/special.html">可以查看所有收集到的测试的会话fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/pythoncollection.html">改变标准 (Python) 测试的发现机制</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/nonpython.html">使用非 Python 测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/customdirectory.html">使用自定义目录收集器</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">关于项目</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html">向后兼容政策</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#id2">历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#python">Python版本支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sponsor.html">赞助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tidelift.html">pytest 企业版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">许可</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">联系渠道</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">游泳的链接</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/pytest/">pytest @ PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/">pytest @ GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/issues">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://media.readthedocs.org/pdf/pytest/latest/pytest.pdf">PDF Documentation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="fixture">
<span id="how-to-fixtures"></span><h1>如何使用 fixture<a class="headerlink" href="#fixture" title="Link to this heading">¶</a></h1>
<p><strong>How to use fixtures</strong></p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../explanation/fixtures.html#about-fixtures"><span class="std std-ref">关于 fixtures</span></a></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../reference/fixtures.html#reference-fixtures"><span class="std std-ref">Fixtures 参考</span></a></p>
</div>
<section id="fixtures">
<h2>“请求” fixtures<a class="headerlink" href="#fixtures" title="Link to this heading">¶</a></h2>
<p><strong>“Requesting” fixtures</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>基本上，测试函数通过将所需的 fixture 声明为参数来请求它们。</p>
<p>当 pytest 准备运行测试时，它会查看该测试函数的参数签名，然后搜索与这些参数同名的 fixture。一旦 pytest 找到这些 fixture，它会运行它们，捕获它们的返回值（如果有的话），并将这些对象作为参数传递给测试函数。</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>At a basic level, test functions request fixtures they require by declaring
them as arguments.</p>
<p>When pytest goes to run a test, it looks at the parameters in that test
function’s signature, and then searches for fixtures that have the same names as
those parameters. Once pytest finds them, it runs those fixtures, captures what
they returned (if anything), and passes those objects into the test function as
arguments.</p>
</div></div>
<section id="id1">
<h3>快速示例<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p><strong>Quick example</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">class</span> <span class="nc">Fruit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">cube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubed</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">FruitSalad</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fruit_bowl</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fruit</span> <span class="o">=</span> <span class="n">fruit_bowl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cube_fruit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cube_fruit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fruit</span><span class="p">:</span>
            <span class="n">fruit</span><span class="o">.</span><span class="n">cube</span><span class="p">()</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fruit_bowl</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">),</span> <span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">fruit_salad</span> <span class="o">=</span> <span class="n">FruitSalad</span><span class="p">(</span><span class="o">*</span><span class="n">fruit_bowl</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">fruit</span><span class="o">.</span><span class="n">cubed</span> <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="n">fruit_salad</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>
</pre></div>
</div>
<p>在这个例子中， <code class="docutils literal notranslate"><span class="pre">test_fruit_salad</span></code> “<strong>请求(requests)</strong>” 了 <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> （即 <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">test_fruit_salad(fruit_bowl):</span></code> ），当 pytest 看到这一点时，它会执行 <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> fixture 函数，并将其返回的对象作为 <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> 参数传递给 <code class="docutils literal notranslate"><span class="pre">test_fruit_salad</span></code>。</p>
<p>如果我们手动执行这个过程，以下是大致发生的事情：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fruit_bowl</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">),</span> <span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">fruit_salad</span> <span class="o">=</span> <span class="n">FruitSalad</span><span class="p">(</span><span class="o">*</span><span class="n">fruit_bowl</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">fruit</span><span class="o">.</span><span class="n">cubed</span> <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="n">fruit_salad</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>


<span class="c1"># Arrange</span>
<span class="n">bowl</span> <span class="o">=</span> <span class="n">fruit_bowl</span><span class="p">()</span>
<span class="n">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="o">=</span><span class="n">bowl</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">class</span> <span class="nc">Fruit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">cube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubed</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">FruitSalad</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fruit_bowl</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fruit</span> <span class="o">=</span> <span class="n">fruit_bowl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cube_fruit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cube_fruit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fruit</span><span class="p">:</span>
            <span class="n">fruit</span><span class="o">.</span><span class="n">cube</span><span class="p">()</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fruit_bowl</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">),</span> <span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">fruit_salad</span> <span class="o">=</span> <span class="n">FruitSalad</span><span class="p">(</span><span class="o">*</span><span class="n">fruit_bowl</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">fruit</span><span class="o">.</span><span class="n">cubed</span> <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="n">fruit_salad</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">test_fruit_salad</span></code> “<strong>requests</strong>” <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> (i.e.
<code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">test_fruit_salad(fruit_bowl):</span></code>), and when pytest sees this, it will
execute the <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> fixture function and pass the object it returns into
<code class="docutils literal notranslate"><span class="pre">test_fruit_salad</span></code> as the <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> argument.</p>
<p>Here’s roughly
what’s happening if we were to do it by hand:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fruit_bowl</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">),</span> <span class="n">Fruit</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">fruit_salad</span> <span class="o">=</span> <span class="n">FruitSalad</span><span class="p">(</span><span class="o">*</span><span class="n">fruit_bowl</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">fruit</span><span class="o">.</span><span class="n">cubed</span> <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="n">fruit_salad</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>


<span class="c1"># Arrange</span>
<span class="n">bowl</span> <span class="o">=</span> <span class="n">fruit_bowl</span><span class="p">()</span>
<span class="n">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="o">=</span><span class="n">bowl</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="fixture-fixture">
<h3>fixture 可以 <strong>请求</strong> 其他 fixture<a class="headerlink" href="#fixture-fixture" title="Link to this heading">¶</a></h3>
<p>Fixtures can <strong>request</strong> other fixtures</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>pytest 的一个最大优势是其极其灵活的 fixture 系统。它允许我们将测试的复杂要求简化为更简单和更有组织的函数，我们只需让每个函数描述其依赖的内容。我们稍后会详细讨论这一点，但现在，这里有一个快速示例，演示 fixture 如何使用其他 fixture：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>注意，这与上面的例子相同，但变化很小。pytest 中的 fixtures <strong>请求</strong> fixtures，就像测试一样。所有相同的 <strong>请求</strong> 规则适用于 fixtures，就像适用于测试一样。以下是这个例子如果我们手动执行将如何进行：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>


<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_string</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>One of pytest’s greatest strengths is its extremely flexible fixture system. It
allows us to boil down complex requirements for tests into more simple and
organized functions, where we only need to have each one describe the things
they are dependent on. We’ll get more into this further down, but for now,
here’s a quick example to demonstrate how fixtures can use other fixtures:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Notice that this is the same example from above, but very little changed. The
fixtures in pytest <strong>request</strong> fixtures just like tests. All the same
<strong>requesting</strong> rules apply to fixtures that do for tests. Here’s how this
example would work if we did it by hand:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>


<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_string</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id2">
<h3>Fixtures 可重复使用<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p><strong>Fixtures are reusable</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>pytest 的 fixture 系统之所以强大，部分原因在于它允许我们定义一个通用的设置步骤，可以反复使用，就像普通函数一样。两个不同的测试可以请求相同的 fixture，而 pytest 会为每个测试提供该 fixture 的独立结果。</p>
<p>这对于确保测试之间互不影响极为有用。我们可以利用这一系统确保每个测试都获得自己的一份新数据，并从干净的状态开始，以便提供一致、可重复的结果。</p>
<p>以下是如何使用这一特性的一例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_int</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>在这里，每个测试都获得自己的一份 <code class="docutils literal notranslate"><span class="pre">list</span></code> 对象，这意味着 <code class="docutils literal notranslate"><span class="pre">order</span></code> fixture 被执行了两次（ <code class="docutils literal notranslate"><span class="pre">first_entry</span></code> fixture 也是如此）。如果我们手动执行，代码看起来会像这样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_int</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>


<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_string</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>

<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_int</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>One of the things that makes pytest’s fixture system so powerful, is that it
gives us the ability to define a generic setup step that can be reused over and
over, just like a normal function would be used. Two different tests can request
the same fixture and have pytest give each test their own result from that
fixture.</p>
<p>This is extremely useful for making sure tests aren’t affected by each other. We
can use this system to make sure each test gets its own fresh batch of data and
is starting from a clean state so it can provide consistent, repeatable results.</p>
<p>Here’s an example of how this can come in handy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_int</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>Each test here is being given its own copy of that <code class="docutils literal notranslate"><span class="pre">list</span></code> object,
which means the <code class="docutils literal notranslate"><span class="pre">order</span></code> fixture is getting executed twice (the same
is true for the <code class="docutils literal notranslate"><span class="pre">first_entry</span></code> fixture). If we were to do this by hand as
well, it would look something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_int</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>


<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_string</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>

<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_int</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id3">
<h3>一个 测试/fixture 可以一次**请求**多个fixture<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p>A test/fixture can <strong>request</strong> more than one fixture at a time</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>测试和 fixtures 并不局限于一次 <strong>请求</strong> 一个 fixture。它们可以请求任意数量的 fixtures。以下是另一个简短的示例来演示这一点:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">second_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">2</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">second_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">second_entry</span><span class="p">]</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">expected_list</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">expected_list</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="n">expected_list</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>Tests and fixtures aren’t limited to <strong>requesting</strong> a single fixture at a time.
They can request as many as they like. Here’s another quick example to
demonstrate:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">second_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">2</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">second_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">second_entry</span><span class="p">]</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">expected_list</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">expected_list</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="n">expected_list</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id4">
<h3>fixtures 可以在每个测试中被 <strong>请求</strong> 多次（返回值会被缓存）<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>Fixtures can be <strong>requested</strong> more than once per test (return values are cached)</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>fixtures 也可以在同一个测试中被 <strong>请求</strong> 多次，pytest 不会再次执行它们。这意味着我们可以在多个依赖于它们的 fixtures 中（甚至在测试本身中） <strong>请求</strong> fixtures，而这些 fixtures 不会被执行多次。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="c1"># Act</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">append_first</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_entry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_string_only</span><span class="p">(</span><span class="n">append_first</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>
</pre></div>
</div>
<p>如果一个 <strong>请求</strong> 的 fixture 每次在测试中被 <strong>请求</strong> 时都会执行一次，那么这个测试将会失败，因为 <code class="docutils literal notranslate"><span class="pre">append_first</span></code> 和 <code class="docutils literal notranslate"><span class="pre">test_string_only</span></code> 都会将 <code class="docutils literal notranslate"><span class="pre">order</span></code> 视为一个空列表（即 <code class="docutils literal notranslate"><span class="pre">[]</span></code>），但是由于 <code class="docutils literal notranslate"><span class="pre">order</span></code> 的返回值在第一次调用后被缓存（以及执行它可能产生的任何副作用），所以测试和 <code class="docutils literal notranslate"><span class="pre">append_first</span></code> 引用了同一个对象，因此测试看到了 <code class="docutils literal notranslate"><span class="pre">append_first</span></code> 对该对象所做的影响。</p>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>Fixtures can also be <strong>requested</strong> more than once during the same test, and
pytest won’t execute them again for that test. This means we can <strong>request</strong>
fixtures in multiple fixtures that are dependent on them (and even again in the
test itself) without those fixtures being executed more than once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="c1"># Act</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">append_first</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_entry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_string_only</span><span class="p">(</span><span class="n">append_first</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>
</pre></div>
</div>
<p>If a <strong>requested</strong> fixture was executed once for every time it was <strong>requested</strong>
during a test, then this test would fail because both <code class="docutils literal notranslate"><span class="pre">append_first</span></code> and
<code class="docutils literal notranslate"><span class="pre">test_string_only</span></code> would see <code class="docutils literal notranslate"><span class="pre">order</span></code> as an empty list (i.e. <code class="docutils literal notranslate"><span class="pre">[]</span></code>), but
since the return value of <code class="docutils literal notranslate"><span class="pre">order</span></code> was cached (along with any side effects
executing it may have had) after the first time it was called, both the test and
<code class="docutils literal notranslate"><span class="pre">append_first</span></code> were referencing the same object, and the test saw the effect
<code class="docutils literal notranslate"><span class="pre">append_first</span></code> had on that object.</p>
</div></div>
</section>
</section>
<section id="fixtures-fixtures">
<span id="autouse-fixtures"></span><span id="autouse"></span><h2>自动使用的 fixtures（不需要显式请求的 fixtures）<a class="headerlink" href="#fixtures-fixtures" title="Link to this heading">¶</a></h2>
<p><strong>Autouse fixtures (fixtures you don’t have to request)</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p>有时您可能希望有一个（或多个）您知道所有测试都将依赖的 fixture。“自动使用” fixtures 是一种方便的方法，可以使所有测试自动 <strong>请求</strong> 它们。这可以减少许多冗余的 <strong>请求</strong>，甚至可以提供更高级的 fixture 使用方式（稍后会详细介绍）。</p>
<p>我们可以通过在 fixture 装饰器中传递 <code class="docutils literal notranslate"><span class="pre">autouse=True</span></code> 来将 fixture 设为自动使用的 fixture。以下是它们如何使用的简单示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">append_first</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_entry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_string_only</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string_and_int</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>在这个例子中，<code class="docutils literal notranslate"><span class="pre">append_first</span></code> fixture 是一个自动使用的 fixture。因为它是自动执行的，所以两个测试都受到影响，即使它们都没有显式 <strong>请求</strong> 它。这并不意味着它们 <em>不能</em> 被 <strong>请求</strong>；只是说这不是 <em>必要的</em>。</p>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>Sometimes you may want to have a fixture (or even several) that you know all
your tests will depend on. “Autouse” fixtures are a convenient way to make all
tests automatically <strong>request</strong> them. This can cut out a
lot of redundant <strong>requests</strong>, and can even provide more advanced fixture usage
(more on that further down).</p>
<p>We can make a fixture an autouse fixture by passing in <code class="docutils literal notranslate"><span class="pre">autouse=True</span></code> to the
fixture’s decorator. Here’s a simple example for how they can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">append_first</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_entry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_string_only</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string_and_int</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>In this example, the <code class="docutils literal notranslate"><span class="pre">append_first</span></code> fixture is an autouse fixture. Because it
happens automatically, both tests are affected by it, even though neither test
<strong>requested</strong> it. That doesn’t mean they <em>can’t</em> be <strong>requested</strong> though; just
that it isn’t <em>necessary</em>.</p>
</div></div>
</section>
<section id="scope-fixture">
<span id="smtpshared"></span><h2>Scope: 跨类、模块、包或会话共享fixture<a class="headerlink" href="#scope-fixture" title="Link to this heading">¶</a></h2>
<p><strong>Scope: sharing fixtures across classes, modules, packages or session</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><p>依赖网络访问的 fixtures 通常会受到连接性的影响，并且创建时通常会耗费较长时间。扩展前面的例子，我们可以在 <a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;pytest.fixture</span></code></a> 调用中添加 <code class="docutils literal notranslate"><span class="pre">scope=&quot;module&quot;</span></code> 参数，以使 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture 函数（负责创建到预先存在的 SMTP 服务器的连接）仅在每个测试 <em>模块</em> 中调用一次（默认情况下是每个测试 <em>函数</em> 调用一次）。这样，测试模块中的多个测试函数将各自接收相同的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture 实例，从而节省时间。 <code class="docutils literal notranslate"><span class="pre">scope</span></code> 的可选值包括： <code class="docutils literal notranslate"><span class="pre">function</span></code>、<code class="docutils literal notranslate"><span class="pre">class</span></code>、<code class="docutils literal notranslate"><span class="pre">module</span></code>、<code class="docutils literal notranslate"><span class="pre">package</span></code> 或 <code class="docutils literal notranslate"><span class="pre">session</span></code>。</p>
<p>下一个例子将 fixture 函数放入一个单独的 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件中，以便目录中多个测试模块的测试可以访问该 fixture 函数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_module.py</span>


<span class="k">def</span> <span class="nf">test_ehlo</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s2">&quot;smtp.gmail.com&quot;</span> <span class="ow">in</span> <span class="n">msg</span>
    <span class="k">assert</span> <span class="mi">0</span>  <span class="c1"># for demo purposes</span>


<span class="k">def</span> <span class="nf">test_noop</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">noop</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="mi">0</span>  <span class="c1"># for demo purposes</span>
</pre></div>
</div>
<p>在这里，<code class="docutils literal notranslate"><span class="pre">test_ehlo</span></code> 需要 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture 的值。pytest 将发现并调用标记为 <a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;pytest.fixture</span></code></a> 的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture 函数。运行测试的输出如下所示：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest test_module.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 2 items

test_module.py <span class=" -Color -Color-Red">FF</span>                                                    <span class=" -Color -Color-Red">[100%]</span>

================================= FAILURES =================================
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________________ test_ehlo _________________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0001&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
        assert b&quot;smtp.gmail.com&quot; in msg
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:7: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________________ test_noop _________________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0001&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop</span> - assert 0
<span class=" -Color -Color-Red">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Red">2 failed</span><span class=" -Color -Color-Red"> in 0.12s =============================</span>
</pre></div>
</div>
<p>您可以看到两个 <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">0</span></code> 失败，更重要的是，您还可以看到 <strong>完全相同</strong> 的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 对象被传递到两个测试函数中，因为 pytest 在 traceback 中显示了传入参数的值。因此，使用 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 的两个测试函数运行的速度与单个测试相当，因为它们重用了相同的实例。</p>
<p>如果您决定希望具有会话范围的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 实例，只需声明它即可：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">():</span>
    <span class="c1"># 返回的 fixture 值将被共享给</span>
    <span class="c1"># 所有请求它的测试</span>
    <span class="o">...</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><p>Fixtures requiring network access depend on connectivity and are
usually time-expensive to create.  Extending the previous example, we
can add a <code class="docutils literal notranslate"><span class="pre">scope=&quot;module&quot;</span></code> parameter to the
<a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;pytest.fixture</span></code></a> invocation
to cause a <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture function, responsible to create a connection to a preexisting SMTP server, to only be invoked
once per test <em>module</em> (the default is to invoke once per test <em>function</em>).
Multiple test functions in a test module will thus
each receive the same <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture instance, thus saving time.
Possible values for <code class="docutils literal notranslate"><span class="pre">scope</span></code> are: <code class="docutils literal notranslate"><span class="pre">function</span></code>, <code class="docutils literal notranslate"><span class="pre">class</span></code>, <code class="docutils literal notranslate"><span class="pre">module</span></code>, <code class="docutils literal notranslate"><span class="pre">package</span></code> or <code class="docutils literal notranslate"><span class="pre">session</span></code>.</p>
<p>The next example puts the fixture function into a separate <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file
so that tests from multiple test modules in the directory can
access the fixture function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_module.py</span>


<span class="k">def</span> <span class="nf">test_ehlo</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s2">&quot;smtp.gmail.com&quot;</span> <span class="ow">in</span> <span class="n">msg</span>
    <span class="k">assert</span> <span class="mi">0</span>  <span class="c1"># for demo purposes</span>


<span class="k">def</span> <span class="nf">test_noop</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">noop</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="mi">0</span>  <span class="c1"># for demo purposes</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">test_ehlo</span></code> needs the <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture value.  pytest
will discover and call the <a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;pytest.fixture</span></code></a>
marked <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture function.  Running the test looks like this:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest test_module.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 2 items

test_module.py <span class=" -Color -Color-Red">FF</span>                                                    <span class=" -Color -Color-Red">[100%]</span>

================================= FAILURES =================================
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________________ test_ehlo _________________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0001&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
        assert b&quot;smtp.gmail.com&quot; in msg
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:7: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________________ test_noop _________________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0001&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop</span> - assert 0
<span class=" -Color -Color-Red">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Red">2 failed</span><span class=" -Color -Color-Red"> in 0.12s =============================</span>
</pre></div>
</div>
<p>You see the two <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">0</span></code> failing and more importantly you can also see
that the <strong>exactly same</strong> <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> object was passed into the
two test functions because pytest shows the incoming argument values in the
traceback.  As a result, the two test functions using <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> run
as quick as a single one because they reuse the same instance.</p>
<p>If you decide that you rather want to have a session-scoped <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code>
instance, you can simply declare it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">():</span>
    <span class="c1"># the returned fixture value will be shared for</span>
    <span class="c1"># all tests requesting it</span>
    <span class="o">...</span>
</pre></div>
</div>
</div></div>
<section id="fixture-scope">
<h3>Fixture 的 scope<a class="headerlink" href="#fixture-scope" title="Link to this heading">¶</a></h3>
<p><strong>Fixture scopes</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-8-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-8-8-0" name="8-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-8-8-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-8-8-1" name="8-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-8-8-0" class="sphinx-tabs-panel" id="panel-8-8-0" name="8-0" role="tabpanel" tabindex="0"><p>Fixtures 在首次被测试请求时创建，并根据其 <code class="docutils literal notranslate"><span class="pre">scope</span></code> 进行销毁：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">function</span></code>: 默认范围，fixture 在测试结束时被销毁。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">class</span></code>: fixture 在类中最后一个测试的拆卸期间被销毁。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">module</span></code>: fixture 在模块中最后一个测试的拆卸期间被销毁。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">package</span></code>: fixture 在定义该 fixture 的包中最后一个测试的拆卸期间被销毁，包括其子包和子目录。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">session</span></code>: fixture 在测试会话结束时被销毁。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pytest 仅缓存一个 fixture 的实例，这意味着在使用参数化 fixture 时，pytest 可能会在给定范围内多次调用该 fixture。</p>
</div>
</div><div aria-labelledby="tab-8-8-1" class="sphinx-tabs-panel" hidden="true" id="panel-8-8-1" name="8-1" role="tabpanel" tabindex="0"><p>Fixtures are created when first requested by a test, and are destroyed based on their <code class="docutils literal notranslate"><span class="pre">scope</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">function</span></code>: the default scope, the fixture is destroyed at the end of the test.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">class</span></code>: the fixture is destroyed during teardown of the last test in the class.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">module</span></code>: the fixture is destroyed during teardown of the last test in the module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">package</span></code>: the fixture is destroyed during teardown of the last test in the package where the fixture is defined, including sub-packages and sub-directories within it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">session</span></code>: the fixture is destroyed at the end of the test session.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pytest only caches one instance of a fixture at a time, which
means that when using a parametrized fixture, pytest may invoke a fixture more than once in
the given scope.</p>
</div>
</div></div>
</section>
<section id="scope">
<span id="dynamic-scope"></span><h3>动态 scope<a class="headerlink" href="#scope" title="Link to this heading">¶</a></h3>
<p><strong>Dynamic scope</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-9-9-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-9-9-0" name="9-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-9-9-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-9-9-1" name="9-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-9-9-0" class="sphinx-tabs-panel" id="panel-9-9-0" name="9-0" role="tabpanel" tabindex="0"><div class="versionadded">
<p><span class="versionmodified added">Added in version 5.2.</span></p>
</div>
<p>在某些情况下，您可能希望在不更改代码的情况下更改 fixture 的作用域。为此，可以将一个可调用对象传递给 <code class="docutils literal notranslate"><span class="pre">scope</span></code>。该可调用对象必须返回一个有效范围的字符串，并且只会在 fixture 定义期间执行一次。它将接收两个关键字参数——<code class="docutils literal notranslate"><span class="pre">fixture_name</span></code> （作为字符串）和 <code class="docutils literal notranslate"><span class="pre">config</span></code> （包含配置对象）。</p>
<p>这在处理需要时间进行设置的 fixtures 时特别有用，例如启动 Docker 容器。您可以使用命令行参数来控制不同环境下生成的容器的作用域。请参见以下示例。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">determine_scope</span><span class="p">(</span><span class="n">fixture_name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;--keep-containers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;session&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;function&quot;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">determine_scope</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">docker_container</span><span class="p">():</span>
    <span class="k">yield</span> <span class="n">spawn_container</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-9-9-1" class="sphinx-tabs-panel" hidden="true" id="panel-9-9-1" name="9-1" role="tabpanel" tabindex="0"><div class="versionadded">
<p><span class="versionmodified added">Added in version 5.2.</span></p>
</div>
<p>In some cases, you might want to change the scope of the fixture without changing the code.
To do that, pass a callable to <code class="docutils literal notranslate"><span class="pre">scope</span></code>. The callable must return a string with a valid scope
and will be executed only once - during the fixture definition. It will be called with two
keyword arguments - <code class="docutils literal notranslate"><span class="pre">fixture_name</span></code> as a string and <code class="docutils literal notranslate"><span class="pre">config</span></code> with a configuration object.</p>
<p>This can be especially useful when dealing with fixtures that need time for setup, like spawning
a docker container. You can use the command-line argument to control the scope of the spawned
containers for different environments. See the example below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">determine_scope</span><span class="p">(</span><span class="n">fixture_name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;--keep-containers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;session&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;function&quot;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">determine_scope</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">docker_container</span><span class="p">():</span>
    <span class="k">yield</span> <span class="n">spawn_container</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="cleanup-teardown-fixture">
<span id="finalization"></span><h2>清理(Cleanup)/收尾(Teardown)（即 Fixture 最终化）<a class="headerlink" href="#cleanup-teardown-fixture" title="Link to this heading">¶</a></h2>
<p><strong>Teardown/Cleanup (AKA Fixture finalization)</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-10-10-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-10-10-0" name="10-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-10-10-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-10-10-1" name="10-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-10-10-0" class="sphinx-tabs-panel" id="panel-10-10-0" name="10-0" role="tabpanel" tabindex="0"><p>当我们运行测试时，我们希望确保它们能够自我清理，以免影响其他测试（同时也避免留下大量测试数据来膨胀系统）。pytest 中的 fixtures 提供了一个非常有用的清理系统，使我们能够定义每个 fixture 自我清理所需的具体步骤。</p>
<p>该系统可以通过两种方式进行利用。</p>
</div><div aria-labelledby="tab-10-10-1" class="sphinx-tabs-panel" hidden="true" id="panel-10-10-1" name="10-1" role="tabpanel" tabindex="0"><p>When we run our tests, we’ll want to make sure they clean up after themselves so
they don’t mess with any other tests (and also so that we don’t leave behind a
mountain of test data to bloat the system). Fixtures in pytest offer a very
useful teardown system, which allows us to define the specific steps necessary
for each fixture to clean up after itself.</p>
<p>This system can be leveraged in two ways.</p>
</div></div>
<section id="yield-fixtures">
<span id="id5"></span><h3>1. <code class="docutils literal notranslate"><span class="pre">yield</span></code> fixtures (推荐方式)<a class="headerlink" href="#yield-fixtures" title="Link to this heading">¶</a></h3>
<p><strong>1.</strong> <code class="docutils literal notranslate"><span class="pre">yield</span></code> <strong>fixtures (recommended)</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-11-11-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-11-11-0" name="11-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-11-11-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-11-11-1" name="11-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-11-11-0" class="sphinx-tabs-panel" id="panel-11-11-0" name="11-0" role="tabpanel" tabindex="0"><p>“Yield” fixtures 使用 <code class="docutils literal notranslate"><span class="pre">yield</span></code> 而不是 <code class="docutils literal notranslate"><span class="pre">return</span></code>。通过这些 fixtures，我们可以运行一些代码并将对象传递回请求的 fixture/test，就像其他 fixtures 一样。唯一的区别是：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">return</span></code> 被替换为 <code class="docutils literal notranslate"><span class="pre">yield</span></code>。</p></li>
<li><p>该 fixture 的任何清理代码都放在 <code class="docutils literal notranslate"><span class="pre">yield</span></code> 之后。</p></li>
</ol>
<p>一旦 pytest 确定了 fixtures 的线性顺序，它会运行每个 fixture，直到返回或 yield，然后继续处理列表中的下一个 fixture，执行相同的操作。</p>
<p>测试完成后，pytest 会按 <em>相反的顺序</em> 回到 fixtures 列表，取出每个 yield 的 fixture，运行 <code class="docutils literal notranslate"><span class="pre">yield</span></code> 语句 <em>之后</em> 的代码。</p>
<p>作为一个简单的例子，考虑这个基本的电子邮件模块：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of emaillib.py</span>
<span class="k">class</span> <span class="nc">MailAdminClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MailUser</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="c1"># 执行一些清理</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MailUser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Email</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
</pre></div>
</div>
<p>假设我们想测试从一个用户发送电子邮件到另一个用户。我们必须首先创建每个用户，然后从一个用户发送电子邮件到另一个用户，最后断言另一个用户的收件箱收到了该消息。如果我们希望在测试运行后进行清理，我们可能需要确保在删除该用户之前清空另一个用户的邮箱，否则系统可能会报错。</p>
<p>这看起来像这样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mail_admin</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MailAdminClient</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">sending_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">receiving_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">sending_user</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Hey!&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;How&#39;s it going?&quot;</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>因为 <code class="docutils literal notranslate"><span class="pre">receiving_user</span></code> 是设置期间运行的最后一个 fixture，所以它是在清理期间第一个运行的。</p>
<p>即使在清理方面的顺序正确，也不能保证安全清理。这在 <a class="reference internal" href="#safe-teardowns"><span class="std std-ref">安全的收尾</span></a> 中有更详细的说明。</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class=" -Color -Color-Green">.</span>                                                                    <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-11-11-1" class="sphinx-tabs-panel" hidden="true" id="panel-11-11-1" name="11-1" role="tabpanel" tabindex="0"><p>“Yield” fixtures <code class="docutils literal notranslate"><span class="pre">yield</span></code> instead of <code class="docutils literal notranslate"><span class="pre">return</span></code>. With these
fixtures, we can run some code and pass an object back to the requesting
fixture/test, just like with the other fixtures. The only differences are:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">return</span></code> is swapped out for <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p></li>
<li><p>Any teardown code for that fixture is placed <em>after</em> the <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p></li>
</ol>
<p>Once pytest figures out a linear order for the fixtures, it will run each one up
until it returns or yields, and then move on to the next fixture in the list to
do the same thing.</p>
<p>Once the test is finished, pytest will go back down the list of fixtures, but in
the <em>reverse order</em>, taking each one that yielded, and running the code inside
it that was <em>after</em> the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement.</p>
<p>As a simple example, consider this basic email module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of emaillib.py</span>
<span class="k">class</span> <span class="nc">MailAdminClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MailUser</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="c1"># do some cleanup</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MailUser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Email</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
</pre></div>
</div>
<p>Let’s say we want to test sending email from one user to another. We’ll have to
first make each user, then send the email from one user to the other, and
finally assert that the other user received that message in their inbox. If we
want to clean up after the test runs, we’ll likely have to make sure the other
user’s mailbox is emptied before deleting that user, otherwise the system may
complain.</p>
<p>Here’s what that might look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mail_admin</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MailAdminClient</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">sending_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">receiving_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">sending_user</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Hey!&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;How&#39;s it going?&quot;</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>Because <code class="docutils literal notranslate"><span class="pre">receiving_user</span></code> is the last fixture to run during setup, it’s the first to run
during teardown.</p>
<p>There is a risk that even having the order right on the teardown side of things
doesn’t guarantee a safe cleanup. That’s covered in a bit more detail in
<a class="reference internal" href="#safe-teardowns"><span class="std std-ref">安全的收尾</span></a>.</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class=" -Color -Color-Green">.</span>                                                                    <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
</div></div>
<section id="yield-fixture">
<h4>处理 yield fixture 的错误<a class="headerlink" href="#yield-fixture" title="Link to this heading">¶</a></h4>
<p><strong>Handling errors for yield fixture</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-12-12-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-12-12-0" name="12-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-12-12-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-12-12-1" name="12-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-12-12-0" class="sphinx-tabs-panel" id="panel-12-12-0" name="12-0" role="tabpanel" tabindex="0"><p>如果一个 yield fixture 在 yield 之前抛出异常，pytest 不会尝试在该 yield fixture 的 <code class="docutils literal notranslate"><span class="pre">yield</span></code> 语句之后运行清理代码。不过，对于已经成功运行的每个 fixture，pytest 仍会按正常方式尝试进行清理。</p>
</div><div aria-labelledby="tab-12-12-1" class="sphinx-tabs-panel" hidden="true" id="panel-12-12-1" name="12-1" role="tabpanel" tabindex="0"><p>If a yield fixture raises an exception before yielding, pytest won’t try to run
the teardown code after that yield fixture’s <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement. But, for every
fixture that has already run successfully for that test, pytest will still
attempt to tear them down as it normally would.</p>
</div></div>
</section>
</section>
<section id="id6">
<h3>2. 直接添加终结器<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<p><strong>2. Adding finalizers directly</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-13-13-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-13-13-0" name="13-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-13-13-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-13-13-1" name="13-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-13-13-0" class="sphinx-tabs-panel" id="panel-13-13-0" name="13-0" role="tabpanel" tabindex="0"><p>虽然 yield fixtures 被认为是更简洁和直接的选择，但还有另一种选择，即直接将“终结器”函数添加到测试的 <a class="reference internal" href="#request-context">request-context</a> 对象中。它带来的效果与 yield fixtures 类似，但需要更多的冗长代码。</p>
<p>为了使用这种方法，我们必须在需要添加清理代码的 fixture 中请求 <a class="reference internal" href="#request-context">request-context</a> 对象（就像请求其他 fixture 一样），然后将包含清理代码的可调用对象传递给其 <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> 方法。</p>
<p>我们需要小心，因为 pytest 一旦添加了终结器，就会运行它，即使该 fixture 在添加终结器后抛出了异常。因此，为了确保在不需要时不运行终结器代码，我们应该仅在 fixture 做了需要清理的操作后添加终结器。</p>
<p>以下是使用 <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> 方法的前一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mail_admin</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MailAdminClient</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">sending_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">receiving_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">():</span>
        <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">delete_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="n">sending_user</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">_email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Hey!&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;How&#39;s it going?&quot;</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">_email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">empty_mailbox</span><span class="p">():</span>
        <span class="n">receiving_user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>

    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">empty_mailbox</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_email</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>这个示例比 yield fixtures 长一些，复杂一些，但在紧急情况下提供了一些细微的灵活性。</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class=" -Color -Color-Green">.</span>                                                                    <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-13-13-1" class="sphinx-tabs-panel" hidden="true" id="panel-13-13-1" name="13-1" role="tabpanel" tabindex="0"><p>While yield fixtures are considered to be the cleaner and more straightforward
option, there is another choice, and that is to add “finalizer” functions
directly to the test’s <a class="reference internal" href="#request-context">request-context</a> object. It brings a similar result as
yield fixtures, but requires a bit more verbosity.</p>
<p>In order to use this approach, we have to request the <a class="reference internal" href="#request-context">request-context</a> object
(just like we would request another fixture) in the fixture we need to add
teardown code for, and then pass a callable, containing that teardown code, to
its <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> method.</p>
<p>We have to be careful though, because pytest will run that finalizer once it’s
been added, even if that fixture raises an exception after adding the finalizer.
So to make sure we don’t run the finalizer code when we wouldn’t need to, we
would only add the finalizer once the fixture would have done something that
we’d need to teardown.</p>
<p>Here’s how the previous example would look using the <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mail_admin</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MailAdminClient</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">sending_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">receiving_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">():</span>
        <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">delete_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="n">sending_user</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">_email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Hey!&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;How&#39;s it going?&quot;</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">_email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">empty_mailbox</span><span class="p">():</span>
        <span class="n">receiving_user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>

    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">empty_mailbox</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_email</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>It’s a bit longer than yield fixtures and a bit more complex, but it
does offer some nuances for when you’re in a pinch.</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class=" -Color -Color-Green">.</span>                                                                    <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
</div></div>
<section id="id7">
<h4>注意终结器的顺序<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h4>
<p><strong>Note on finalizer order</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-14-14-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-14-14-0" name="14-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-14-14-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-14-14-1" name="14-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-14-14-0" class="sphinx-tabs-panel" id="panel-14-14-0" name="14-0" role="tabpanel" tabindex="0"><p>终结器以先进后出的顺序执行。对于 yield fixtures，首先运行的清理代码来自最右侧的 fixture，即最后一个测试参数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_finalizers.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">test_bar</span><span class="p">(</span><span class="n">fix_w_yield1</span><span class="p">,</span> <span class="n">fix_w_yield2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_bar&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_yield1</span><span class="p">():</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after_yield_1&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_yield2</span><span class="p">():</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after_yield_2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s test_finalizers.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 1 item

test_finalizers.py test_bar
.after_yield_2
after_yield_1


<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>对于终结器，第一个运行的 fixture 是对 <code class="docutils literal notranslate"><span class="pre">request.addfinalizer</span></code> 的最后一次调用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_finalizers.py</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_finalizers</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="s2">&quot;finalizer_2&quot;</span><span class="p">))</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="s2">&quot;finalizer_1&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_bar</span><span class="p">(</span><span class="n">fix_w_finalizers</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s test_finalizers.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 1 item

test_finalizers.py test_bar
.finalizer_1
finalizer_2


<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>这是因为 yield fixtures 在幕后使用 <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code>: 当 fixture 执行时，<code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> 注册一个恢复生成器的函数，而这个函数会调用清理代码。</p>
</div><div aria-labelledby="tab-14-14-1" class="sphinx-tabs-panel" hidden="true" id="panel-14-14-1" name="14-1" role="tabpanel" tabindex="0"><p>Finalizers are executed in a first-in-last-out order.
For yield fixtures, the first teardown code to run is from the right-most fixture, i.e. the last test parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_finalizers.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">test_bar</span><span class="p">(</span><span class="n">fix_w_yield1</span><span class="p">,</span> <span class="n">fix_w_yield2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_bar&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_yield1</span><span class="p">():</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after_yield_1&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_yield2</span><span class="p">():</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after_yield_2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s test_finalizers.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 1 item

test_finalizers.py test_bar
.after_yield_2
after_yield_1


<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>For finalizers, the first fixture to run is last call to <code class="docutils literal notranslate"><span class="pre">request.addfinalizer</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_finalizers.py</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_finalizers</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="s2">&quot;finalizer_2&quot;</span><span class="p">))</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="s2">&quot;finalizer_1&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_bar</span><span class="p">(</span><span class="n">fix_w_finalizers</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s test_finalizers.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 1 item

test_finalizers.py test_bar
.finalizer_1
finalizer_2


<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>This is so because yield fixtures use <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> behind the scenes: when the fixture executes, <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> registers a function that resumes the generator, which in turn calls the teardown code.</p>
</div></div>
</section>
</section>
</section>
<section id="safe-teardowns">
<span id="id8"></span><h2>安全的收尾<a class="headerlink" href="#safe-teardowns" title="Link to this heading">¶</a></h2>
<p><strong>Safe teardowns</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-15-15-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-15-15-0" name="15-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-15-15-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-15-15-1" name="15-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-15-15-0" class="sphinx-tabs-panel" id="panel-15-15-0" name="15-0" role="tabpanel" tabindex="0"><p>pytest 的 fixture 系统是 <em>非常</em> 强大的，但它仍然是由计算机运行的，因此无法安全地拆解我们扔给它的所有内容。如果我们不小心，错误可能会在错误的位置留下测试数据，这可能会迅速引发进一步的问题。</p>
<p>例如，考虑以下测试（基于上面的邮件示例）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">setup</span><span class="p">():</span>
    <span class="n">mail_admin</span> <span class="o">=</span> <span class="n">MailAdminClient</span><span class="p">()</span>
    <span class="n">sending_user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="n">receiving_user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Hey!&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;How&#39;s it going?&quot;</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span>
    <span class="n">receiving_user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">sending_user</span><span class="p">)</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">receiving_user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">setup</span><span class="p">):</span>
    <span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="n">setup</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>这个版本更加紧凑，但也更难以阅读，fixture 名称不够描述性，并且这些 fixtures 不易于重用。</p>
<p>还有一个更严重的问题是，如果 setup 中的任何步骤引发异常，清理代码将不会运行。</p>
<p>一种选择可能是使用 <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> 方法，而不是 yield fixtures，但这可能会变得非常复杂且难以维护（而且不再紧凑）。</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class=" -Color -Color-Green">.</span>                                                                    <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-15-15-1" class="sphinx-tabs-panel" hidden="true" id="panel-15-15-1" name="15-1" role="tabpanel" tabindex="0"><p>The fixture system of pytest is <em>very</em> powerful, but it’s still being run by a
computer, so it isn’t able to figure out how to safely teardown everything we
throw at it. If we aren’t careful, an error in the wrong spot might leave stuff
from our tests behind, and that can cause further issues pretty quickly.</p>
<p>For example, consider the following tests (based off of the mail example from
above):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">setup</span><span class="p">():</span>
    <span class="n">mail_admin</span> <span class="o">=</span> <span class="n">MailAdminClient</span><span class="p">()</span>
    <span class="n">sending_user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="n">receiving_user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Hey!&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;How&#39;s it going?&quot;</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span>
    <span class="n">receiving_user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">sending_user</span><span class="p">)</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">receiving_user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">setup</span><span class="p">):</span>
    <span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="n">setup</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>This version is a lot more compact, but it’s also harder to read, doesn’t have a
very descriptive fixture name, and none of the fixtures can be reused easily.</p>
<p>There’s also a more serious issue, which is that if any of those steps in the
setup raise an exception, none of the teardown code will run.</p>
<p>One option might be to go with the <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> method instead of yield
fixtures, but that might get pretty complex and difficult to maintain (and it
wouldn’t be compact anymore).</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class=" -Color -Color-Green">.</span>                                                                    <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
</div></div>
<section id="safe-fixture-structure">
<span id="id9"></span><h3>安全的 fixture 结构<a class="headerlink" href="#safe-fixture-structure" title="Link to this heading">¶</a></h3>
<p><strong>Safe fixture structure</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-16-16-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-16-16-0" name="16-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-16-16-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-16-16-1" name="16-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-16-16-0" class="sphinx-tabs-panel" id="panel-16-16-0" name="16-0" role="tabpanel" tabindex="0"><p>pytest 的安全且简单的 fixture 结构要求每个 fixture 仅执行一个状态更改操作，并将其与清理代码打包在一起，正如 <a class="reference internal" href="#yield-fixtures"><span class="std std-ref">上面的电子邮件示例</span></a> 所示。</p>
<p>状态更改操作失败但仍然修改状态的机会是微不足道的，因为大多数操作通常是基于 <a class="reference external" href="https://en.wikipedia.org/wiki/Transaction_processing">transaction</a> 的（至少在可能留下状态的测试级别）。因此，如果我们确保任何成功的状态更改操作都通过将其移动到单独的 fixture 函数并将其与其他可能失败的状态更改操作分开来进行清理，那么我们的测试将有最佳的机会让测试环境保持原样。</p>
<p>例如，假设我们有一个带登录页面的网站，并且可以访问一个管理 API 来生成用户。对于我们的测试，我们想要：</p>
<ol class="arabic simple">
<li><p>通过该管理 API 创建一个用户</p></li>
<li><p>使用 Selenium 启动浏览器</p></li>
<li><p>转到我们网站的登录页面</p></li>
<li><p>作为我们创建的用户登录</p></li>
<li><p>断言他们的名字在登录页面的标题中</p></li>
</ol>
<p>我们不希望将该用户留在系统中，也不希望留下浏览器会话在运行，因此我们需要确保创建这些内容的 fixtures 能够进行清理。</p>
<p>以下是可能的实现方式：</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在这个例子中，某些 fixtures（例如 <code class="docutils literal notranslate"><span class="pre">base_url</span></code> 和
<code class="docutils literal notranslate"><span class="pre">admin_credentials</span></code>）假定在其他地方存在。因此现在，我们假设它们存在，暂时不对此进行关注。</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">Chrome</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">src.utils.pages</span> <span class="kn">import</span> <span class="n">LoginPage</span><span class="p">,</span> <span class="n">LandingPage</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">AdminApiClient</span>
<span class="kn">from</span> <span class="nn">src.utils.data_types</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">admin_client</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">admin_credentials</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AdminApiClient</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="o">**</span><span class="n">admin_credentials</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">admin_client</span><span class="p">):</span>
    <span class="n">_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Susan&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;testuser-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;P4$$word&quot;</span><span class="p">)</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">_user</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">_driver</span> <span class="o">=</span> <span class="n">Chrome</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">_driver</span>
    <span class="n">_driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;/login&quot;</span><span class="p">))</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">LoginPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">landing_page</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LandingPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_name_on_landing_page_after_login</span><span class="p">(</span><span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">header</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;Welcome, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>
</pre></div>
</div>
<p>依赖关系的布局方式使得不清楚 <code class="docutils literal notranslate"><span class="pre">user</span></code> fixture 是否会在 <code class="docutils literal notranslate"><span class="pre">driver</span></code> fixture 之前执行。但这没关系，因为这些是原子操作，因此无论哪个先运行都无关紧要，因为测试的事件序列仍然是 <a class="reference external" href="https://en.wikipedia.org/wiki/Linearizability">linearizable</a>。重要的是，无论哪个先执行，如果一个在抛出异常而另一个没有，两个都不会留下任何东西。如果 <code class="docutils literal notranslate"><span class="pre">driver</span></code> 在 <code class="docutils literal notranslate"><span class="pre">user</span></code> 之前执行，而 <code class="docutils literal notranslate"><span class="pre">user</span></code> 抛出异常，驱动程序仍然会退出，并且用户从未被创建。而如果 <code class="docutils literal notranslate"><span class="pre">driver</span></code> 抛出了异常，那么驱动程序将永远不会启动，用户也不会被创建。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>另外，虽然 <code class="docutils literal notranslate"><span class="pre">user</span></code> fixture 并不 <em>实际</em> 需要在 <code class="docutils literal notranslate"><span class="pre">driver</span></code> fixture 之前发生，但如果我们让 <code class="docutils literal notranslate"><span class="pre">driver</span></code> 请求 <code class="docutils literal notranslate"><span class="pre">user</span></code>，在创建用户抛出异常的情况下，这可能会节省一些时间，因为它不会尝试启动驱动程序，而这是一项相对昂贵的操作。</p>
</div>
</div><div aria-labelledby="tab-16-16-1" class="sphinx-tabs-panel" hidden="true" id="panel-16-16-1" name="16-1" role="tabpanel" tabindex="0"><p>The safest and simplest fixture structure requires limiting fixtures to only
making one state-changing action each, and then bundling them together with
their teardown code, as <a class="reference internal" href="#yield-fixtures"><span class="std std-ref">the email examples above</span></a> showed.</p>
<p>The chance that a state-changing operation can fail but still modify state is
negligible, as most of these operations tend to be <a class="reference external" href="https://en.wikipedia.org/wiki/Transaction_processing">transaction</a>-based (at least at the
level of testing where state could be left behind). So if we make sure that any
successful state-changing action gets torn down by moving it to a separate
fixture function and separating it from other, potentially failing
state-changing actions, then our tests will stand the best chance at leaving
the test environment the way they found it.</p>
<p>For an example, let’s say we have a website with a login page, and we have
access to an admin API where we can generate users. For our test, we want to:</p>
<ol class="arabic simple">
<li><p>Create a user through that admin API</p></li>
<li><p>Launch a browser using Selenium</p></li>
<li><p>Go to the login page of our site</p></li>
<li><p>Log in as the user we created</p></li>
<li><p>Assert that their name is in the header of the landing page</p></li>
</ol>
<p>We wouldn’t want to leave that user in the system, nor would we want to leave
that browser session running, so we’ll want to make sure the fixtures that
create those things clean up after themselves.</p>
<p>Here’s what that might look like:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this example, certain fixtures (i.e. <code class="docutils literal notranslate"><span class="pre">base_url</span></code> and
<code class="docutils literal notranslate"><span class="pre">admin_credentials</span></code>) are implied to exist elsewhere. So for now, let’s
assume they exist, and we’re just not looking at them.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">Chrome</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">src.utils.pages</span> <span class="kn">import</span> <span class="n">LoginPage</span><span class="p">,</span> <span class="n">LandingPage</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">AdminApiClient</span>
<span class="kn">from</span> <span class="nn">src.utils.data_types</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">admin_client</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">admin_credentials</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AdminApiClient</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="o">**</span><span class="n">admin_credentials</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">admin_client</span><span class="p">):</span>
    <span class="n">_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Susan&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;testuser-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;P4$$word&quot;</span><span class="p">)</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">_user</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">_driver</span> <span class="o">=</span> <span class="n">Chrome</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">_driver</span>
    <span class="n">_driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;/login&quot;</span><span class="p">))</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">LoginPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">landing_page</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LandingPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_name_on_landing_page_after_login</span><span class="p">(</span><span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">header</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;Welcome, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>
</pre></div>
</div>
<p>The way the dependencies are laid out means it’s unclear if the <code class="docutils literal notranslate"><span class="pre">user</span></code>
fixture would execute before the <code class="docutils literal notranslate"><span class="pre">driver</span></code> fixture. But that’s ok, because
those are atomic operations, and so it doesn’t matter which one runs first
because the sequence of events for the test is still <a class="reference external" href="https://en.wikipedia.org/wiki/Linearizability">linearizable</a>. But what <em>does</em> matter is
that, no matter which one runs first, if the one raises an exception while the
other would not have, neither will have left anything behind. If <code class="docutils literal notranslate"><span class="pre">driver</span></code>
executes before <code class="docutils literal notranslate"><span class="pre">user</span></code>, and <code class="docutils literal notranslate"><span class="pre">user</span></code> raises an exception, the driver will
still quit, and the user was never made. And if <code class="docutils literal notranslate"><span class="pre">driver</span></code> was the one to raise
the exception, then the driver would never have been started and the user would
never have been made.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While the <code class="docutils literal notranslate"><span class="pre">user</span></code> fixture doesn’t <em>actually</em> need to happen before the
<code class="docutils literal notranslate"><span class="pre">driver</span></code> fixture, if we made <code class="docutils literal notranslate"><span class="pre">driver</span></code> request <code class="docutils literal notranslate"><span class="pre">user</span></code>, it might save
some time in the event that making the user raises an exception, since it
won’t bother trying to start the driver, which is a fairly expensive
operation.</p>
</div>
</div></div>
</section>
</section>
<section id="assert">
<h2>安全地运行多个 <code class="docutils literal notranslate"><span class="pre">assert</span></code> 语句<a class="headerlink" href="#assert" title="Link to this heading">¶</a></h2>
<p><strong>Running multiple</strong> <code class="docutils literal notranslate"><span class="pre">assert</span></code> <strong>statements safely</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-17-17-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-17-17-0" name="17-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-17-17-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-17-17-1" name="17-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-17-17-0" class="sphinx-tabs-panel" id="panel-17-17-0" name="17-0" role="tabpanel" tabindex="0"><p>有时您可能希望在完成所有设置后运行多个断言，这很有意义，因为在更复杂的系统中，单个操作可能会引发多个行为。pytest 提供了一种方便的方法来处理这种情况，它结合了我们迄今为止讨论的许多内容。</p>
<p>所需的操作是提升到更大的作用域，然后将 <strong>act</strong> 步骤定义为一个自动使用的 fixture，最后确保所有 fixtures 都针对更高的作用域。</p>
<p>让我们从 <a class="reference internal" href="#safe-fixture-structure"><span class="std std-ref">上面的例子</span></a> 中提取一个例子，并稍作修改。假设除了检查标题中的欢迎消息外，我们还想检查登出按钮和指向用户个人资料的链接。</p>
<p>让我们看看如何构建这个结构，以便我们可以运行多个断言，而不必重复所有步骤。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在这个例子中，某些 fixtures（例如 <code class="docutils literal notranslate"><span class="pre">base_url</span></code> 和
<code class="docutils literal notranslate"><span class="pre">admin_credentials</span></code>）假定在其他地方存在。因此现在，我们假设它们存在，暂时不对此进行关注。</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of tests/end_to_end/test_login.py</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">Chrome</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">src.utils.pages</span> <span class="kn">import</span> <span class="n">LoginPage</span><span class="p">,</span> <span class="n">LandingPage</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">AdminApiClient</span>
<span class="kn">from</span> <span class="nn">src.utils.data_types</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">admin_client</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">admin_credentials</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AdminApiClient</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="o">**</span><span class="n">admin_credentials</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">admin_client</span><span class="p">):</span>
    <span class="n">_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Susan&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;testuser-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;P4$$word&quot;</span><span class="p">)</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">_user</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">_driver</span> <span class="o">=</span> <span class="n">Chrome</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">_driver</span>
    <span class="n">_driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">landing_page</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LandingPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestLandingPageSuccess</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;/login&quot;</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">LoginPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_name_in_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">header</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;Welcome, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>

    <span class="k">def</span> <span class="nf">test_sign_out_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">sign_out_button</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_profile_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">profile_href</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/profile?id=</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">profile_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">profile_link</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">profile_href</span>
</pre></div>
</div>
<p>请注意，方法的签名中只引用 <code class="docutils literal notranslate"><span class="pre">self</span></code> 作为一种形式。没有状态与实际的测试类相关联，就像在 <code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> 框架中那样。所有内容都由 pytest fixture 系统管理。</p>
<p>每个方法只需请求实际需要的 fixtures，而不必担心顺序。这是因为 <strong>act</strong> fixture 是一个自动使用的 fixture，并且确保了所有其他 fixtures 在它之前执行。没有更多的状态变化需要发生，因此测试可以自由进行任意数量的非状态变化查询，而不必担心干扰其他测试。</p>
<p><code class="docutils literal notranslate"><span class="pre">login</span></code> fixture 也在类中定义，因为并非模块中的每个其他测试都期望成功登录，并且 <strong>act</strong> 可能需要针对另一个测试类以不同方式处理。例如，如果我们想编写另一个关于提交错误凭据的测试场景，我们可以通过在测试文件中添加类似以下内容来处理：</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>假设此页面对象（即 <code class="docutils literal notranslate"><span class="pre">LoginPage</span></code>）在识别到登录表单上的文本表明错误凭据后会引发一个自定义异常 <code class="docutils literal notranslate"><span class="pre">BadCredentialsException</span></code>。</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestLandingPageBadCredentials</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">faux_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">_user</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">_user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;badpass&quot;</span>
        <span class="k">return</span> <span class="n">_user</span>

    <span class="k">def</span> <span class="nf">test_raises_bad_credentials_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_page</span><span class="p">,</span> <span class="n">faux_user</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">BadCredentialsException</span><span class="p">):</span>
            <span class="n">login_page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">faux_user</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-17-17-1" class="sphinx-tabs-panel" hidden="true" id="panel-17-17-1" name="17-1" role="tabpanel" tabindex="0"><p>Sometimes you may want to run multiple asserts after doing all that setup, which
makes sense as, in more complex systems, a single action can kick off multiple
behaviors. pytest has a convenient way of handling this and it combines a bunch
of what we’ve gone over so far.</p>
<p>All that’s needed is stepping up to a larger scope, then having the <strong>act</strong>
step defined as an autouse fixture, and finally, making sure all the fixtures
are targeting that higher level scope.</p>
<p>Let’s pull <a class="reference internal" href="#safe-fixture-structure"><span class="std std-ref">an example from above</span></a>, and tweak it a
bit. Let’s say that in addition to checking for a welcome message in the header,
we also want to check for a sign out button, and a link to the user’s profile.</p>
<p>Let’s take a look at how we can structure that so we can run multiple asserts
without having to repeat all those steps again.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this example, certain fixtures (i.e. <code class="docutils literal notranslate"><span class="pre">base_url</span></code> and
<code class="docutils literal notranslate"><span class="pre">admin_credentials</span></code>) are implied to exist elsewhere. So for now, let’s
assume they exist, and we’re just not looking at them.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of tests/end_to_end/test_login.py</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">Chrome</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">src.utils.pages</span> <span class="kn">import</span> <span class="n">LoginPage</span><span class="p">,</span> <span class="n">LandingPage</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">AdminApiClient</span>
<span class="kn">from</span> <span class="nn">src.utils.data_types</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">admin_client</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">admin_credentials</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AdminApiClient</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="o">**</span><span class="n">admin_credentials</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">admin_client</span><span class="p">):</span>
    <span class="n">_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Susan&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;testuser-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;P4$$word&quot;</span><span class="p">)</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">_user</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">_driver</span> <span class="o">=</span> <span class="n">Chrome</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">_driver</span>
    <span class="n">_driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">landing_page</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LandingPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestLandingPageSuccess</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;/login&quot;</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">LoginPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_name_in_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">header</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;Welcome, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>

    <span class="k">def</span> <span class="nf">test_sign_out_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">sign_out_button</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_profile_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">profile_href</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/profile?id=</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">profile_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">profile_link</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">profile_href</span>
</pre></div>
</div>
<p>Notice that the methods are only referencing <code class="docutils literal notranslate"><span class="pre">self</span></code> in the signature as a
formality. No state is tied to the actual test class as it might be in the
<code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> framework. Everything is managed by the pytest fixture
system.</p>
<p>Each method only has to request the fixtures that it actually needs without
worrying about order. This is because the <strong>act</strong> fixture is an autouse fixture,
and it made sure all the other fixtures executed before it. There’s no more
changes of state that need to take place, so the tests are free to make as many
non-state-changing queries as they want without risking stepping on the toes of
the other tests.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">login</span></code> fixture is defined inside the class as well, because not every one
of the other tests in the module will be expecting a successful login, and the <strong>act</strong> may need to
be handled a little differently for another test class. For example, if we
wanted to write another test scenario around submitting bad credentials, we
could handle it by adding something like this to the test file:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s assumed that the page object for this (i.e. <code class="docutils literal notranslate"><span class="pre">LoginPage</span></code>) raises a
custom exception, <code class="docutils literal notranslate"><span class="pre">BadCredentialsException</span></code>, when it recognizes text
signifying that on the login form after attempting to log in.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestLandingPageBadCredentials</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">faux_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">_user</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">_user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;badpass&quot;</span>
        <span class="k">return</span> <span class="n">_user</span>

    <span class="k">def</span> <span class="nf">test_raises_bad_credentials_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_page</span><span class="p">,</span> <span class="n">faux_user</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">BadCredentialsException</span><span class="p">):</span>
            <span class="n">login_page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">faux_user</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="request-context">
<span id="id12"></span><h2>Fixtures 可以检查请求的测试上下文<a class="headerlink" href="#request-context" title="Link to this heading">¶</a></h2>
<p><strong>Fixtures can introspect the requesting test context</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-18-18-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-18-18-0" name="18-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-18-18-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-18-18-1" name="18-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-18-18-0" class="sphinx-tabs-panel" id="panel-18-18-0" name="18-0" role="tabpanel" tabindex="0"><p>Fixture 函数可以接受 <a class="reference internal" href="../reference/reference.html#id74" title="_pytest.fixtures.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> 对象，以 introspect “请求” 测试函数、类或模块的上下文。进一步扩展之前的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture 示例，让我们从使用我们 fixture 的测试模块中读取一个可选的服务器 URL：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;smtpserver&quot;</span><span class="p">,</span> <span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">)</span>
    <span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">smtp_connection</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finalizing </span><span class="si">{</span><span class="n">smtp_connection</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">smtp_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>我们使用 <code class="docutils literal notranslate"><span class="pre">request.module</span></code> 属性可选地从测试模块中获取 <code class="docutils literal notranslate"><span class="pre">smtpserver</span></code> 属性。如果我们再次执行，基本上没有改变：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s -q --tb=no test_module.py
FFfinalizing &lt;smtplib.SMTP object at 0xdeadbeef0002&gt; (smtp.gmail.com)

<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop</span> - assert 0
<span class=" -Color -Color-Bold -Color-Bold-Red">2 failed</span><span class=" -Color -Color-Red"> in 0.12s</span>
</pre></div>
</div>
<p>让我们快速创建另一个测试模块，实际上在其模块命名空间中设置服务器 URL:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_anothersmtp.py</span>

<span class="n">smtpserver</span> <span class="o">=</span> <span class="s2">&quot;mail.python.org&quot;</span>  <span class="c1"># 将由 smtp fixture 读取</span>


<span class="k">def</span> <span class="nf">test_showhelo</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">helo</span><span class="p">()</span>
</pre></div>
</div>
<p>运行它：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -qq --tb=short test_anothersmtp.py
<span class=" -Color -Color-Red">F</span>                                                                    <span class=" -Color -Color-Red">[100%]</span>
================================= FAILURES =================================
<span class=" -Color -Color-Bold -Color-Bold-Red">______________________________ test_showhelo _______________________________</span>
<span class=" -Color -Color-Bold -Color-Bold-Red">test_anothersmtp.py</span>:6: in test_showhelo
    assert 0, smtp_connection.helo()
<span class=" -Color -Color-Bold -Color-Bold-Red">E   AssertionError: (250, b&#39;mail.python.org&#39;)</span>
<span class=" -Color -Color-Bold -Color-Bold-Red">E   assert 0</span>
------------------------- Captured stdout teardown -------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0003&gt; (mail.python.org)
<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_anothersmtp.py::<span class=" -Color -Color-Bold">test_showhelo</span> - AssertionError: (250, b&#39;mail....
</pre></div>
</div>
<p>瞧！ <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture 函数从模块命名空间中获取了我们的邮件服务器名称。</p>
</div><div aria-labelledby="tab-18-18-1" class="sphinx-tabs-panel" hidden="true" id="panel-18-18-1" name="18-1" role="tabpanel" tabindex="0"><p>Fixture functions can accept the <a class="reference internal" href="../reference/reference.html#id74" title="_pytest.fixtures.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> object
to introspect the “requesting” test function, class or module context.
Further extending the previous <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture example, let’s
read an optional server URL from the test module which uses our fixture:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;smtpserver&quot;</span><span class="p">,</span> <span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">)</span>
    <span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">smtp_connection</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finalizing </span><span class="si">{</span><span class="n">smtp_connection</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">smtp_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>We use the <code class="docutils literal notranslate"><span class="pre">request.module</span></code> attribute to optionally obtain an
<code class="docutils literal notranslate"><span class="pre">smtpserver</span></code> attribute from the test module.  If we just execute
again, nothing much has changed:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s -q --tb=no test_module.py
FFfinalizing &lt;smtplib.SMTP object at 0xdeadbeef0002&gt; (smtp.gmail.com)

<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop</span> - assert 0
<span class=" -Color -Color-Bold -Color-Bold-Red">2 failed</span><span class=" -Color -Color-Red"> in 0.12s</span>
</pre></div>
</div>
<p>Let’s quickly create another test module that actually sets the
server URL in its module namespace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_anothersmtp.py</span>

<span class="n">smtpserver</span> <span class="o">=</span> <span class="s2">&quot;mail.python.org&quot;</span>  <span class="c1"># will be read by smtp fixture</span>


<span class="k">def</span> <span class="nf">test_showhelo</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">helo</span><span class="p">()</span>
</pre></div>
</div>
<p>Running it:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -qq --tb=short test_anothersmtp.py
<span class=" -Color -Color-Red">F</span>                                                                    <span class=" -Color -Color-Red">[100%]</span>
================================= FAILURES =================================
<span class=" -Color -Color-Bold -Color-Bold-Red">______________________________ test_showhelo _______________________________</span>
<span class=" -Color -Color-Bold -Color-Bold-Red">test_anothersmtp.py</span>:6: in test_showhelo
    assert 0, smtp_connection.helo()
<span class=" -Color -Color-Bold -Color-Bold-Red">E   AssertionError: (250, b&#39;mail.python.org&#39;)</span>
<span class=" -Color -Color-Bold -Color-Bold-Red">E   assert 0</span>
------------------------- Captured stdout teardown -------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0003&gt; (mail.python.org)
<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_anothersmtp.py::<span class=" -Color -Color-Bold">test_showhelo</span> - AssertionError: (250, b&#39;mail....
</pre></div>
</div>
<p>voila! The <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture function picked up our mail server name
from the module namespace.</p>
</div></div>
</section>
<section id="using-markers">
<span id="id13"></span><h2>使用标记将数据传递给fixture<a class="headerlink" href="#using-markers" title="Link to this heading">¶</a></h2>
<p><strong>Using markers to pass data to fixtures</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-19-19-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-19-19-0" name="19-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-19-19-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-19-19-1" name="19-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-19-19-0" class="sphinx-tabs-panel" id="panel-19-19-0" name="19-0" role="tabpanel" tabindex="0"><p>使用 <a class="reference internal" href="../reference/reference.html#id74" title="_pytest.fixtures.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> 对象，fixture 还可以访问应用于测试函数的标记。这对于从测试向 fixture 传递数据非常有用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fixt</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">&quot;fixt_data&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 以某种方式处理缺失的标记...</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 使用数据做一些事情</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">fixt_data</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_fixt</span><span class="p">(</span><span class="n">fixt</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">fixt</span> <span class="o">==</span> <span class="mi">42</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-19-19-1" class="sphinx-tabs-panel" hidden="true" id="panel-19-19-1" name="19-1" role="tabpanel" tabindex="0"><p>Using the <a class="reference internal" href="../reference/reference.html#id74" title="_pytest.fixtures.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> object, a fixture can also access
markers which are applied to a test function. This can be useful to pass data
into a fixture from a test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fixt</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">&quot;fixt_data&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Handle missing marker in some way...</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Do something with the data</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">fixt_data</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_fixt</span><span class="p">(</span><span class="n">fixt</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">fixt</span> <span class="o">==</span> <span class="mi">42</span>
</pre></div>
</div>
</div></div>
</section>
<section id="fixture-factory">
<span id="id14"></span><h2>fixture 工厂<a class="headerlink" href="#fixture-factory" title="Link to this heading">¶</a></h2>
<p><strong>Factories as fixtures</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-20-20-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-20-20-0" name="20-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-20-20-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-20-20-1" name="20-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-20-20-0" class="sphinx-tabs-panel" id="panel-20-20-0" name="20-0" role="tabpanel" tabindex="0"><p>“fixture 工厂” 模式可以帮助在单个测试中多次需要 fixture 结果的情况下使用。fixture 不直接返回数据，而是返回一个生成数据的函数。这个函数可以在测试中多次调用。</p>
<p>工厂可以根据需要带有参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">make_customer_record</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_make_customer_record</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">return</span> <span class="n">_make_customer_record</span>


<span class="k">def</span> <span class="nf">test_customer_records</span><span class="p">(</span><span class="n">make_customer_record</span><span class="p">):</span>
    <span class="n">customer_1</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Lisa&quot;</span><span class="p">)</span>
    <span class="n">customer_2</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Mike&quot;</span><span class="p">)</span>
    <span class="n">customer_3</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Meredith&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果工厂创建的数据需要管理，fixture 可以处理这些：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">make_customer_record</span><span class="p">():</span>
    <span class="n">created_records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_make_customer_record</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">created_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">yield</span> <span class="n">_make_customer_record</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">created_records</span><span class="p">:</span>
        <span class="n">record</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_customer_records</span><span class="p">(</span><span class="n">make_customer_record</span><span class="p">):</span>
    <span class="n">customer_1</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Lisa&quot;</span><span class="p">)</span>
    <span class="n">customer_2</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Mike&quot;</span><span class="p">)</span>
    <span class="n">customer_3</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Meredith&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-20-20-1" class="sphinx-tabs-panel" hidden="true" id="panel-20-20-1" name="20-1" role="tabpanel" tabindex="0"><p>The “factory as fixture” pattern can help in situations where the result
of a fixture is needed multiple times in a single test. Instead of returning
data directly, the fixture instead returns a function which generates the data.
This function can then be called multiple times in the test.</p>
<p>Factories can have parameters as needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">make_customer_record</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_make_customer_record</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">return</span> <span class="n">_make_customer_record</span>


<span class="k">def</span> <span class="nf">test_customer_records</span><span class="p">(</span><span class="n">make_customer_record</span><span class="p">):</span>
    <span class="n">customer_1</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Lisa&quot;</span><span class="p">)</span>
    <span class="n">customer_2</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Mike&quot;</span><span class="p">)</span>
    <span class="n">customer_3</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Meredith&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the data created by the factory requires managing, the fixture can take care of that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">make_customer_record</span><span class="p">():</span>
    <span class="n">created_records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_make_customer_record</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">created_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">yield</span> <span class="n">_make_customer_record</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">created_records</span><span class="p">:</span>
        <span class="n">record</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_customer_records</span><span class="p">(</span><span class="n">make_customer_record</span><span class="p">):</span>
    <span class="n">customer_1</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Lisa&quot;</span><span class="p">)</span>
    <span class="n">customer_2</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Mike&quot;</span><span class="p">)</span>
    <span class="n">customer_3</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">&quot;Meredith&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="fixture-parametrize">
<span id="id15"></span><h2>参数化 fixture<a class="headerlink" href="#fixture-parametrize" title="Link to this heading">¶</a></h2>
<p><strong>Parametrizing fixtures</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-21-21-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-21-21-0" name="21-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-21-21-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-21-21-1" name="21-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-21-21-0" class="sphinx-tabs-panel" id="panel-21-21-0" name="21-0" role="tabpanel" tabindex="0"><p>Fixture 函数可以被参数化，这样它们将被多次调用，每次执行依赖于此 fixture 的测试集合。测试函数通常不需要意识到它们正在重新运行。Fixture 参数化有助于为可以以多种方式配置的组件编写详尽的功能测试。</p>
<p>扩展之前的示例，我们可以标记 fixture 创建两个 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture 实例，这将导致使用该 fixture 的所有测试运行两次。fixture 函数通过特殊的 <a class="reference internal" href="../reference/reference.html#id74" title="pytest.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> 对象访问每个参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;mail.python.org&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">smtp_connection</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finalizing </span><span class="si">{</span><span class="n">smtp_connection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">smtp_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>主要变化是使用 <a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;pytest.fixture</span></code></a> 声明 <code class="docutils literal notranslate"><span class="pre">params</span></code>，这是一个值的列表，fixture 函数将为每个值执行并可以通过 <code class="docutils literal notranslate"><span class="pre">request.param</span></code> 访问该值。测试函数代码不需要更改。因此，让我们再运行一次：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_module.py
<span class=" -Color -Color-Red">FFFF</span>                                                                 <span class=" -Color -Color-Red">[100%]</span>
================================= FAILURES =================================
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_ehlo[smtp.gmail.com] _________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
        assert b&quot;smtp.gmail.com&quot; in msg
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:7: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_noop[smtp.gmail.com] _________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_ehlo[mail.python.org] ________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
&gt;       assert b&quot;smtp.gmail.com&quot; in msg
<span class=" -Color -Color-Bold -Color-Bold-Red">E       AssertionError: assert b&#39;smtp.gmail.com&#39; in b&#39;mail.python.org\nPIPELINING\nSIZE 51200000\nETRN\nSTARTTLS\nAUTH DIGEST-MD5 NTLM CRAM-MD5\nENHANCEDSTATUSCODES\n8BITMIME\nDSN\nSMTPUTF8\nCHUNKING&#39;</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:6: AssertionError
-------------------------- Captured stdout setup ---------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_noop[mail.python.org] ________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
------------------------- Captured stdout teardown -------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;
<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo[smtp.gmail.com]</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop[smtp.gmail.com]</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo[mail.python.org]</span> - AssertionError: asser...
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop[mail.python.org]</span> - assert 0
<span class=" -Color -Color-Bold -Color-Bold-Red">4 failed</span><span class=" -Color -Color-Red"> in 0.12s</span>
</pre></div>
</div>
<p>我们看到我们的两个测试函数都运行了两次，针对不同的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 实例。还要注意，使用 <code class="docutils literal notranslate"><span class="pre">mail.python.org</span></code> 连接时，第二个测试在 <code class="docutils literal notranslate"><span class="pre">test_ehlo</span></code> 中失败，因为期望的服务器字符串与实际到达的不同。</p>
<p>pytest 将为参数化 fixture 中的每个 fixture 值构建一个字符串作为测试 ID，例如上述示例中的 <code class="docutils literal notranslate"><span class="pre">test_ehlo[smtp.gmail.com]</span></code> 和 <code class="docutils literal notranslate"><span class="pre">test_ehlo[mail.python.org]</span></code> 。这些 ID 可以与 <code class="docutils literal notranslate"><span class="pre">-k</span></code> 一起使用，以选择要运行的特定用例，并且在某个用例失败时，它们也会标识出特定的用例。使用 <code class="docutils literal notranslate"><span class="pre">--collect-only</span></code> 运行 pytest 将显示生成的 ID。</p>
<p>数字、字符串、布尔值和 <code class="docutils literal notranslate"><span class="pre">None</span></code> 将在测试 ID 中使用其常规字符串表示形式。对于其他对象，pytest 将基于参数名称生成字符串。可以通过使用 <code class="docutils literal notranslate"><span class="pre">ids</span></code> 关键字参数自定义特定 fixture 值的测试 ID 中使用的字符串：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_ids.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spam&quot;</span><span class="p">,</span> <span class="s2">&quot;ham&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_a</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">idfn</span><span class="p">(</span><span class="n">fixture_value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fixture_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;eggs&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="n">idfn</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_b</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>上述内容显示了 <code class="docutils literal notranslate"><span class="pre">ids</span></code> 可以是要使用的字符串列表，也可以是一个函数，该函数将使用 fixture 值调用，并返回要使用的字符串。在后者情况下，如果函数返回 <code class="docutils literal notranslate"><span class="pre">None</span></code> ，则将使用 pytest 的自动生成 ID。</p>
<p>运行上述测试将生成以下测试 ID:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest --collect-only
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 12 items

&lt;Dir fixtures.rst-224&gt;
    &lt;Module test_anothersmtp.py&gt;
    &lt;Function test_showhelo[smtp.gmail.com]&gt;
    &lt;Function test_showhelo[mail.python.org]&gt;
    &lt;Module test_emaillib.py&gt;
    &lt;Function test_email_received&gt;
    &lt;Module test_finalizers.py&gt;
    &lt;Function test_bar&gt;
    &lt;Module test_ids.py&gt;
    &lt;Function test_a[spam]&gt;
    &lt;Function test_a[ham]&gt;
    &lt;Function test_b[eggs]&gt;
    &lt;Function test_b[1]&gt;
    &lt;Module test_module.py&gt;
    &lt;Function test_ehlo[smtp.gmail.com]&gt;
    &lt;Function test_noop[smtp.gmail.com]&gt;
    &lt;Function test_ehlo[mail.python.org]&gt;
    &lt;Function test_noop[mail.python.org]&gt;

======================= 12 tests collected in 0.12s ========================
</pre></div>
</div>
</div><div aria-labelledby="tab-21-21-1" class="sphinx-tabs-panel" hidden="true" id="panel-21-21-1" name="21-1" role="tabpanel" tabindex="0"><p>Fixture functions can be parametrized in which case they will be called
multiple times, each time executing the set of dependent tests, i.e. the
tests that depend on this fixture.  Test functions usually do not need
to be aware of their re-running.  Fixture parametrization helps to
write exhaustive functional tests for components which themselves can be
configured in multiple ways.</p>
<p>Extending the previous example, we can flag the fixture to create two
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture instances which will cause all tests using the fixture
to run twice.  The fixture function gets access to each parameter
through the special <a class="reference internal" href="../reference/reference.html#id74" title="pytest.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;mail.python.org&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">smtp_connection</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finalizing </span><span class="si">{</span><span class="n">smtp_connection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">smtp_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The main change is the declaration of <code class="docutils literal notranslate"><span class="pre">params</span></code> with
<a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;pytest.fixture</span></code></a>, a list of values
for each of which the fixture function will execute and can access
a value via <code class="docutils literal notranslate"><span class="pre">request.param</span></code>.  No test function code needs to change.
So let’s just do another run:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_module.py
<span class=" -Color -Color-Red">FFFF</span>                                                                 <span class=" -Color -Color-Red">[100%]</span>
================================= FAILURES =================================
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_ehlo[smtp.gmail.com] _________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
        assert b&quot;smtp.gmail.com&quot; in msg
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:7: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_noop[smtp.gmail.com] _________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_ehlo[mail.python.org] ________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
&gt;       assert b&quot;smtp.gmail.com&quot; in msg
<span class=" -Color -Color-Bold -Color-Bold-Red">E       AssertionError: assert b&#39;smtp.gmail.com&#39; in b&#39;mail.python.org\nPIPELINING\nSIZE 51200000\nETRN\nSTARTTLS\nAUTH DIGEST-MD5 NTLM CRAM-MD5\nENHANCEDSTATUSCODES\n8BITMIME\nDSN\nSMTPUTF8\nCHUNKING&#39;</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:6: AssertionError
-------------------------- Captured stdout setup ---------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;
<span class=" -Color -Color-Bold -Color-Bold-Red">________________________ test_noop[mail.python.org] ________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
------------------------- Captured stdout teardown -------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;
<span class=" -Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo[smtp.gmail.com]</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop[smtp.gmail.com]</span> - assert 0
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_ehlo[mail.python.org]</span> - AssertionError: asser...
<span class=" -Color -Color-Red">FAILED</span> test_module.py::<span class=" -Color -Color-Bold">test_noop[mail.python.org]</span> - assert 0
<span class=" -Color -Color-Bold -Color-Bold-Red">4 failed</span><span class=" -Color -Color-Red"> in 0.12s</span>
</pre></div>
</div>
<p>We see that our two test functions each ran twice, against the different
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> instances.  Note also, that with the <code class="docutils literal notranslate"><span class="pre">mail.python.org</span></code>
connection the second test fails in <code class="docutils literal notranslate"><span class="pre">test_ehlo</span></code> because a
different server string is expected than what arrived.</p>
<p>pytest will build a string that is the test ID for each fixture value
in a parametrized fixture, e.g. <code class="docutils literal notranslate"><span class="pre">test_ehlo[smtp.gmail.com]</span></code> and
<code class="docutils literal notranslate"><span class="pre">test_ehlo[mail.python.org]</span></code> in the above examples.  These IDs can
be used with <code class="docutils literal notranslate"><span class="pre">-k</span></code> to select specific cases to run, and they will
also identify the specific case when one is failing.  Running pytest
with <code class="docutils literal notranslate"><span class="pre">--collect-only</span></code> will show the generated IDs.</p>
<p>Numbers, strings, booleans and <code class="docutils literal notranslate"><span class="pre">None</span></code> will have their usual string
representation used in the test ID. For other objects, pytest will
make a string based on the argument name.  It is possible to customise
the string used in a test ID for a certain fixture value by using the
<code class="docutils literal notranslate"><span class="pre">ids</span></code> keyword argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_ids.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spam&quot;</span><span class="p">,</span> <span class="s2">&quot;ham&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_a</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">idfn</span><span class="p">(</span><span class="n">fixture_value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fixture_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;eggs&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="n">idfn</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_b</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The above shows how <code class="docutils literal notranslate"><span class="pre">ids</span></code> can be either a list of strings to use or
a function which will be called with the fixture value and then
has to return a string to use.  In the latter case if the function
returns <code class="docutils literal notranslate"><span class="pre">None</span></code> then pytest’s auto-generated ID will be used.</p>
<p>Running the above tests results in the following test IDs being used:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest --collect-only
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 12 items

&lt;Dir fixtures.rst-224&gt;
    &lt;Module test_anothersmtp.py&gt;
    &lt;Function test_showhelo[smtp.gmail.com]&gt;
    &lt;Function test_showhelo[mail.python.org]&gt;
    &lt;Module test_emaillib.py&gt;
    &lt;Function test_email_received&gt;
    &lt;Module test_finalizers.py&gt;
    &lt;Function test_bar&gt;
    &lt;Module test_ids.py&gt;
    &lt;Function test_a[spam]&gt;
    &lt;Function test_a[ham]&gt;
    &lt;Function test_b[eggs]&gt;
    &lt;Function test_b[1]&gt;
    &lt;Module test_module.py&gt;
    &lt;Function test_ehlo[smtp.gmail.com]&gt;
    &lt;Function test_noop[smtp.gmail.com]&gt;
    &lt;Function test_ehlo[mail.python.org]&gt;
    &lt;Function test_noop[mail.python.org]&gt;

======================= 12 tests collected in 0.12s ========================
</pre></div>
</div>
</div></div>
</section>
<section id="fixture-parametrize-marks">
<span id="id16"></span><h2>与标记一起的参数化 fixture<a class="headerlink" href="#fixture-parametrize-marks" title="Link to this heading">¶</a></h2>
<p><strong>Using marks with parametrized fixtures</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-22-22-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-22-22-0" name="22-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-22-22-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-22-22-1" name="22-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-22-22-0" class="sphinx-tabs-panel" id="panel-22-22-0" name="22-0" role="tabpanel" tabindex="0"><p><a class="reference internal" href="../reference/reference.html#pytest.param" title="pytest.param"><code class="xref py py-func docutils literal notranslate"><span class="pre">pytest.param()</span></code></a> 可以用于在参数化 fixture 的值集合中应用标记，方式与 <a class="reference internal" href="parametrize.html#pytest-mark-parametrize"><span class="std std-ref">&#64;pytest.mark.parametrize</span></a> 一致。</p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_fixture_marks.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pytest</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">marks</span><span class="o">=</span><span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">data_set</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_data</span><span class="p">(</span><span class="n">data_set</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>运行此测试将 <em>跳过</em> 对 <code class="docutils literal notranslate"><span class="pre">data_set</span></code> 值为 <code class="docutils literal notranslate"><span class="pre">2</span></code> 的调用：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest test_fixture_marks.py -v
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class=" -Color -Color-Bold">collecting ...</span> collected 3 items

test_fixture_marks.py::test_data[0] <span class=" -Color -Color-Green">PASSED</span>                           <span class=" -Color -Color-Green">[ 33%]</span>
test_fixture_marks.py::test_data[1] <span class=" -Color -Color-Green">PASSED</span>                           <span class=" -Color -Color-Green">[ 66%]</span>
test_fixture_marks.py::test_data[2] <span class=" -Color -Color-Yellow">SKIPPED</span> (unconditional skip)     <span class=" -Color -Color-Yellow">[100%]</span>

<span class=" -Color -Color-Yellow">======================= </span><span class=" -Color -Color-Green">2 passed</span>, <span class=" -Color -Color-Bold -Color-Bold-Yellow">1 skipped</span><span class=" -Color -Color-Yellow"> in 0.12s =======================</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-22-22-1" class="sphinx-tabs-panel" hidden="true" id="panel-22-22-1" name="22-1" role="tabpanel" tabindex="0"><p><a class="reference internal" href="../reference/reference.html#pytest.param" title="pytest.param"><code class="xref py py-func docutils literal notranslate"><span class="pre">pytest.param()</span></code></a> can be used to apply marks in values sets of parametrized fixtures in the same way
that they can be used with <a class="reference internal" href="parametrize.html#pytest-mark-parametrize"><span class="std std-ref">&#64;pytest.mark.parametrize</span></a>.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_fixture_marks.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pytest</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">marks</span><span class="o">=</span><span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">data_set</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_data</span><span class="p">(</span><span class="n">data_set</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Running this test will <em>skip</em> the invocation of <code class="docutils literal notranslate"><span class="pre">data_set</span></code> with value <code class="docutils literal notranslate"><span class="pre">2</span></code>:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest test_fixture_marks.py -v
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class=" -Color -Color-Bold">collecting ...</span> collected 3 items

test_fixture_marks.py::test_data[0] <span class=" -Color -Color-Green">PASSED</span>                           <span class=" -Color -Color-Green">[ 33%]</span>
test_fixture_marks.py::test_data[1] <span class=" -Color -Color-Green">PASSED</span>                           <span class=" -Color -Color-Green">[ 66%]</span>
test_fixture_marks.py::test_data[2] <span class=" -Color -Color-Yellow">SKIPPED</span> (unconditional skip)     <span class=" -Color -Color-Yellow">[100%]</span>

<span class=" -Color -Color-Yellow">======================= </span><span class=" -Color -Color-Green">2 passed</span>, <span class=" -Color -Color-Bold -Color-Bold-Yellow">1 skipped</span><span class=" -Color -Color-Yellow"> in 0.12s =======================</span>
</pre></div>
</div>
</div></div>
</section>
<section id="interdependent-fixtures">
<span id="id17"></span><h2>模块化：使用 Fixture 函数中的 Fixture<a class="headerlink" href="#interdependent-fixtures" title="Link to this heading">¶</a></h2>
<p><strong>Modularity: using fixtures from a fixture function</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-23-23-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-23-23-0" name="23-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-23-23-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-23-23-1" name="23-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-23-23-0" class="sphinx-tabs-panel" id="panel-23-23-0" name="23-0" role="tabpanel" tabindex="0"><p>除了在测试函数中使用 fixtures，fixture 函数本身也可以使用其他 fixtures。这有助于创建模块化的 fixture 设计，并允许在多个项目中重用框架特定的 fixtures。作为一个简单的例子，我们可以扩展之前的示例，并实例化一个对象 <code class="docutils literal notranslate"><span class="pre">app</span></code>，在其中插入已经定义的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 资源：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_appsetup.py</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smtp_connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtp_connection</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_smtp_connection_exists</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">app</span><span class="o">.</span><span class="n">smtp_connection</span>
</pre></div>
</div>
<p>在这里，我们声明了一个 <code class="docutils literal notranslate"><span class="pre">app</span></code> fixture，它接收之前定义的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture，并用它实例化一个 <code class="docutils literal notranslate"><span class="pre">App</span></code> 对象。让我们运行它：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -v test_appsetup.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class=" -Color -Color-Bold">collecting ...</span> collected 2 items

test_appsetup.py::test_smtp_connection_exists[smtp.gmail.com] <span class=" -Color -Color-Green">PASSED</span> <span class=" -Color -Color-Green">[ 50%]</span>
test_appsetup.py::test_smtp_connection_exists[mail.python.org] <span class=" -Color -Color-Green">PASSED</span> <span class=" -Color -Color-Green">[100%]</span>

<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">2 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>由于 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 的参数化，测试将使用两个不同的 <code class="docutils literal notranslate"><span class="pre">App</span></code> 实例和各自的 smtp 服务器运行两次。<code class="docutils literal notranslate"><span class="pre">app</span></code> fixture 不需要关注 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 的参数化，因为 pytest 将完全分析 fixture 依赖图。</p>
<p>请注意，<code class="docutils literal notranslate"><span class="pre">app</span></code> fixture 的作用域是 <code class="docutils literal notranslate"><span class="pre">module</span></code>，并使用了一个模块作用域的 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture。如果 <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> 在 <code class="docutils literal notranslate"><span class="pre">session</span></code> 范围内缓存，这个示例仍然可以工作：使用“更广泛”作用域的 fixtures 是可以的，但反之则不行：一个会话范围的 fixture 不能以有意义的方式使用一个模块范围的 fixture。</p>
</div><div aria-labelledby="tab-23-23-1" class="sphinx-tabs-panel" hidden="true" id="panel-23-23-1" name="23-1" role="tabpanel" tabindex="0"><p>In addition to using fixtures in test functions, fixture functions
can use other fixtures themselves.  This contributes to a modular design
of your fixtures and allows reuse of framework-specific fixtures across
many projects.  As a simple example, we can extend the previous example
and instantiate an object <code class="docutils literal notranslate"><span class="pre">app</span></code> where we stick the already defined
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> resource into it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_appsetup.py</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smtp_connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtp_connection</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_smtp_connection_exists</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">app</span><span class="o">.</span><span class="n">smtp_connection</span>
</pre></div>
</div>
<p>Here we declare an <code class="docutils literal notranslate"><span class="pre">app</span></code> fixture which receives the previously defined
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture and instantiates an <code class="docutils literal notranslate"><span class="pre">App</span></code> object with it.  Let’s run it:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -v test_appsetup.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class=" -Color -Color-Bold">collecting ...</span> collected 2 items

test_appsetup.py::test_smtp_connection_exists[smtp.gmail.com] <span class=" -Color -Color-Green">PASSED</span> <span class=" -Color -Color-Green">[ 50%]</span>
test_appsetup.py::test_smtp_connection_exists[mail.python.org] <span class=" -Color -Color-Green">PASSED</span> <span class=" -Color -Color-Green">[100%]</span>

<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">2 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>Due to the parametrization of <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code>, the test will run twice with two
different <code class="docutils literal notranslate"><span class="pre">App</span></code> instances and respective smtp servers.  There is no
need for the <code class="docutils literal notranslate"><span class="pre">app</span></code> fixture to be aware of the <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code>
parametrization because pytest will fully analyse the fixture dependency graph.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">app</span></code> fixture has a scope of <code class="docutils literal notranslate"><span class="pre">module</span></code> and uses a
module-scoped <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture.  The example would still work if
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> was cached on a <code class="docutils literal notranslate"><span class="pre">session</span></code> scope: it is fine for fixtures to use
“broader” scoped fixtures but not the other way round:
A session-scoped fixture could not use a module-scoped one in a
meaningful way.</p>
</div></div>
</section>
<section id="automatic-per-resource-grouping">
<span id="id18"></span><h2>根据fixture实例自动对测试进行分组<a class="headerlink" href="#automatic-per-resource-grouping" title="Link to this heading">¶</a></h2>
<p><strong>Automatic grouping of tests by fixture instances</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-24-24-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-24-24-0" name="24-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-24-24-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-24-24-1" name="24-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-24-24-0" class="sphinx-tabs-panel" id="panel-24-24-0" name="24-0" role="tabpanel" tabindex="0"><p>pytest 在测试运行期间最小化活跃 fixtures 的数量。如果你有一个参数化的 fixture，那么所有使用它的测试将首先使用一个实例执行，然后在创建下一个 fixture 实例之前调用清理函数。除此之外，这也简化了测试创建和使用全局状态的应用程序。</p>
<p>以下示例使用两个参数化的 fixtures，其中一个以模块为基础作用域，所有函数都执行 <code class="docutils literal notranslate"><span class="pre">print</span></code> 调用以展示设置/清理流程：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_module.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mod1&quot;</span><span class="p">,</span> <span class="s2">&quot;mod2&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">modarg</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  SETUP modarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  TEARDOWN modarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">otherarg</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  SETUP otherarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  TEARDOWN otherarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_0</span><span class="p">(</span><span class="n">otherarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  RUN test0 with otherarg&quot;</span><span class="p">,</span> <span class="n">otherarg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="n">modarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  RUN test1 with modarg&quot;</span><span class="p">,</span> <span class="n">modarg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="n">otherarg</span><span class="p">,</span> <span class="n">modarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RUN test2 with otherarg </span><span class="si">{</span><span class="n">otherarg</span><span class="si">}</span><span class="s2"> and modarg </span><span class="si">{</span><span class="n">modarg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>让我们在详细模式下运行测试，并查看打印输出：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -v -s test_module.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class=" -Color -Color-Bold">collecting ...</span> collected 8 items

test_module.py::test_0[1]   SETUP otherarg 1
RUN test0 with otherarg 1
PASSED  TEARDOWN otherarg 1

test_module.py::test_0[2]   SETUP otherarg 2
RUN test0 with otherarg 2
PASSED  TEARDOWN otherarg 2

test_module.py::test_1[mod1]   SETUP modarg mod1
RUN test1 with modarg mod1
PASSED
test_module.py::test_2[mod1-1]   SETUP otherarg 1
RUN test2 with otherarg 1 and modarg mod1
PASSED  TEARDOWN otherarg 1

test_module.py::test_2[mod1-2]   SETUP otherarg 2
RUN test2 with otherarg 2 and modarg mod1
PASSED  TEARDOWN otherarg 2

test_module.py::test_1[mod2]   TEARDOWN modarg mod1
SETUP modarg mod2
RUN test1 with modarg mod2
PASSED
test_module.py::test_2[mod2-1]   SETUP otherarg 1
RUN test2 with otherarg 1 and modarg mod2
PASSED  TEARDOWN otherarg 1

test_module.py::test_2[mod2-2]   SETUP otherarg 2
RUN test2 with otherarg 2 and modarg mod2
PASSED  TEARDOWN otherarg 2
TEARDOWN modarg mod2


<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">8 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>可以看到，参数化的模块作用域 <code class="docutils literal notranslate"><span class="pre">modarg</span></code> 资源导致了测试执行的顺序，从而使“活跃”资源的数量最少。 <code class="docutils literal notranslate"><span class="pre">mod1</span></code> 参数化资源的清理函数在设置 <code class="docutils literal notranslate"><span class="pre">mod2</span></code> 资源之前执行。</p>
<p>特别要注意的是，test_0 完全独立并最先完成。然后执行 test_1 使用 <code class="docutils literal notranslate"><span class="pre">mod1</span></code>，接着是 test_2 使用 <code class="docutils literal notranslate"><span class="pre">mod1</span></code>，然后是 test_1 使用 <code class="docutils literal notranslate"><span class="pre">mod2</span></code>，最后是 test_2 使用 <code class="docutils literal notranslate"><span class="pre">mod2</span></code>。</p>
<p><code class="docutils literal notranslate"><span class="pre">otherarg</span></code> 参数化资源（具有函数作用域）在使用它的每个测试之前设置，并在之后清理。</p>
</div><div aria-labelledby="tab-24-24-1" class="sphinx-tabs-panel" hidden="true" id="panel-24-24-1" name="24-1" role="tabpanel" tabindex="0"><p>pytest minimizes the number of active fixtures during test runs.
If you have a parametrized fixture, then all the tests using it will
first execute with one instance and then finalizers are called
before the next fixture instance is created.  Among other things,
this eases testing of applications which create and use global state.</p>
<p>The following example uses two parametrized fixtures, one of which is
scoped on a per-module basis, and all the functions perform <code class="docutils literal notranslate"><span class="pre">print</span></code> calls
to show the setup/teardown flow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_module.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mod1&quot;</span><span class="p">,</span> <span class="s2">&quot;mod2&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">modarg</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  SETUP modarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  TEARDOWN modarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">otherarg</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  SETUP otherarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  TEARDOWN otherarg&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_0</span><span class="p">(</span><span class="n">otherarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  RUN test0 with otherarg&quot;</span><span class="p">,</span> <span class="n">otherarg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="n">modarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  RUN test1 with modarg&quot;</span><span class="p">,</span> <span class="n">modarg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="n">otherarg</span><span class="p">,</span> <span class="n">modarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RUN test2 with otherarg </span><span class="si">{</span><span class="n">otherarg</span><span class="si">}</span><span class="s2"> and modarg </span><span class="si">{</span><span class="n">modarg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s run the tests in verbose mode and with looking at the print-output:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -v -s test_module.py
<span class=" -Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-8.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class=" -Color -Color-Bold">collecting ...</span> collected 8 items

test_module.py::test_0[1]   SETUP otherarg 1
RUN test0 with otherarg 1
PASSED  TEARDOWN otherarg 1

test_module.py::test_0[2]   SETUP otherarg 2
RUN test0 with otherarg 2
PASSED  TEARDOWN otherarg 2

test_module.py::test_1[mod1]   SETUP modarg mod1
RUN test1 with modarg mod1
PASSED
test_module.py::test_2[mod1-1]   SETUP otherarg 1
RUN test2 with otherarg 1 and modarg mod1
PASSED  TEARDOWN otherarg 1

test_module.py::test_2[mod1-2]   SETUP otherarg 2
RUN test2 with otherarg 2 and modarg mod1
PASSED  TEARDOWN otherarg 2

test_module.py::test_1[mod2]   TEARDOWN modarg mod1
SETUP modarg mod2
RUN test1 with modarg mod2
PASSED
test_module.py::test_2[mod2-1]   SETUP otherarg 1
RUN test2 with otherarg 1 and modarg mod2
PASSED  TEARDOWN otherarg 1

test_module.py::test_2[mod2-2]   SETUP otherarg 2
RUN test2 with otherarg 2 and modarg mod2
PASSED  TEARDOWN otherarg 2
TEARDOWN modarg mod2


<span class=" -Color -Color-Green">============================ </span><span class=" -Color -Color-Bold -Color-Bold-Green">8 passed</span><span class=" -Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>You can see that the parametrized module-scoped <code class="docutils literal notranslate"><span class="pre">modarg</span></code> resource caused an
ordering of test execution that lead to the fewest possible “active” resources.
The finalizer for the <code class="docutils literal notranslate"><span class="pre">mod1</span></code> parametrized resource was executed before the
<code class="docutils literal notranslate"><span class="pre">mod2</span></code> resource was setup.</p>
<p>In particular notice that test_0 is completely independent and finishes first.
Then test_1 is executed with <code class="docutils literal notranslate"><span class="pre">mod1</span></code>, then test_2 with <code class="docutils literal notranslate"><span class="pre">mod1</span></code>, then test_1
with <code class="docutils literal notranslate"><span class="pre">mod2</span></code> and finally test_2 with <code class="docutils literal notranslate"><span class="pre">mod2</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">otherarg</span></code> parametrized resource (having function scope) was set up before
and teared down after every test that used it.</p>
</div></div>
</section>
<section id="usefixtures-fixture">
<span id="usefixtures"></span><h2>在类和模块中通过 <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> 使用 fixture<a class="headerlink" href="#usefixtures-fixture" title="Link to this heading">¶</a></h2>
<p><strong>Use fixtures in classes and modules with</strong> <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-25-25-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-25-25-0" name="25-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-25-25-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-25-25-1" name="25-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-25-25-0" class="sphinx-tabs-panel" id="panel-25-25-0" name="25-0" role="tabpanel" tabindex="0"><p>有时测试函数不需要直接访问一个 fixture 对象。
例如，测试可能需要以一个空目录作为当前工作目录，但不关心具体的目录。
以下是如何使用标准的 <a class="reference external" href="https://docs.python.org/3/library/tempfile.html#module-tempfile" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tempfile</span></code></a> 和 pytest fixtures 来实现这一点。
我们将 fixture 的创建分离到一个 <code class="file docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># conftest.py 的内容</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">cleandir</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">newpath</span><span class="p">:</span>
        <span class="n">old_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">newpath</span><span class="p">)</span>
        <span class="k">yield</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">old_cwd</span><span class="p">)</span>
</pre></div>
</div>
<p>并通过 <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> 标记在测试模块中声明其使用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># test_setenv.py 的内容</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;cleandir&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestDirectoryInit</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_cwd_starts_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">==</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;myfile&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_cwd_again_starts_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div>
</div>
<p>由于 <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> 标记，<code class="docutils literal notranslate"><span class="pre">cleandir</span></code> fixture 将在每个测试方法的执行中被要求，就像你为它们每个都指定了一个 “cleandir” 函数参数。
让我们运行它以验证我们的 fixture 是否被激活，并且测试通过：</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q
<span class=" -Color -Color-Green">..</span>                                                                   <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">2 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
<p>你可以这样指定多个 fixtures:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;cleandir&quot;</span><span class="p">,</span> <span class="s2">&quot;anotherfixture&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span> <span class="o">...</span>
</pre></div>
</div>
<p>你还可以在测试模块级别使用 <a class="reference internal" href="../reference/reference.html#globalvar-3"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytestmark</span></code></a> 指定 fixture 的使用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;cleandir&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>将项目中所有测试所需的 fixtures 放入 ini 文件中也是可行的：</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># pytest.ini 的内容</span>
<span class="k">[pytest]</span>
<span class="na">usefixtures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">cleandir</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>请注意，这个标记在 <strong>fixture 函数</strong> 中没有效果。
例如，这个 <strong>不会按预期工作</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;my_other_fixture&quot;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">my_fixture_that_sadly_wont_use_my_other_fixture</span><span class="p">():</span> <span class="o">...</span>
</pre></div>
</div>
<p>这将生成一个弃用警告，并将在 Pytest 8 中变为错误。</p>
</div>
</div><div aria-labelledby="tab-25-25-1" class="sphinx-tabs-panel" hidden="true" id="panel-25-25-1" name="25-1" role="tabpanel" tabindex="0"><p>Sometimes test functions do not directly need access to a fixture object.
For example, tests may require to operate with an empty directory as the
current working directory but otherwise do not care for the concrete
directory.  Here is how you can use the standard <a class="reference external" href="https://docs.python.org/3/library/tempfile.html#module-tempfile" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tempfile</span></code></a>
and pytest fixtures to
achieve it.  We separate the creation of the fixture into a <code class="file docutils literal notranslate"><span class="pre">conftest.py</span></code>
file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">cleandir</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">newpath</span><span class="p">:</span>
        <span class="n">old_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">newpath</span><span class="p">)</span>
        <span class="k">yield</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">old_cwd</span><span class="p">)</span>
</pre></div>
</div>
<p>and declare its use in a test module via a <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> marker:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_setenv.py</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;cleandir&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestDirectoryInit</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_cwd_starts_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">==</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;myfile&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_cwd_again_starts_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Due to the <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> marker, the <code class="docutils literal notranslate"><span class="pre">cleandir</span></code> fixture
will be required for the execution of each test method, just as if
you specified a “cleandir” function argument to each of them.  Let’s run it
to verify our fixture is activated and the tests pass:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q
<span class=" -Color -Color-Green">..</span>                                                                   <span class=" -Color -Color-Green">[100%]</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">2 passed</span><span class=" -Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
<p>You can specify multiple fixtures like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;cleandir&quot;</span><span class="p">,</span> <span class="s2">&quot;anotherfixture&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span> <span class="o">...</span>
</pre></div>
</div>
<p>and you may specify fixture usage at the test module level using <a class="reference internal" href="../reference/reference.html#globalvar-3"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytestmark</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;cleandir&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>It is also possible to put fixtures required by all tests in your project
into an ini-file:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">usefixtures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">cleandir</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note this mark has no effect in <strong>fixture functions</strong>. For example,
this <strong>will not work as expected</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;my_other_fixture&quot;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">my_fixture_that_sadly_wont_use_my_other_fixture</span><span class="p">():</span> <span class="o">...</span>
</pre></div>
</div>
<p>This generates a deprecation warning, and will become an error in Pytest 8.</p>
</div>
</div></div>
</section>
<section id="override-fixtures">
<span id="id19"></span><h2>覆盖各个级别的fixtures<a class="headerlink" href="#override-fixtures" title="Link to this heading">¶</a></h2>
<p><strong>Overriding fixtures on various levels</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-26-26-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-26-26-0" name="26-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-26-26-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-26-26-1" name="26-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-26-26-0" class="sphinx-tabs-panel" id="panel-26-26-0" name="26-0" role="tabpanel" tabindex="0"><p>在相对较大的测试套件中，您很可能需要用一个 <code class="docutils literal notranslate"><span class="pre">locally</span></code> 定义的 fixture 来 <code class="docutils literal notranslate"><span class="pre">override</span></code> 一个 <code class="docutils literal notranslate"><span class="pre">global</span></code> 或 <code class="docutils literal notranslate"><span class="pre">root</span></code> fixture，以保持测试代码的可读性和可维护性。</p>
</div><div aria-labelledby="tab-26-26-1" class="sphinx-tabs-panel" hidden="true" id="panel-26-26-1" name="26-1" role="tabpanel" tabindex="0"><p>In relatively large test suite, you most likely need to <code class="docutils literal notranslate"><span class="pre">override</span></code> a <code class="docutils literal notranslate"><span class="pre">global</span></code> or <code class="docutils literal notranslate"><span class="pre">root</span></code> fixture with a <code class="docutils literal notranslate"><span class="pre">locally</span></code>
defined one, keeping the test code readable and maintainable.</p>
</div></div>
<section id="conftest-fixture">
<h3>覆盖文件夹（conftest）级别的fixture<a class="headerlink" href="#conftest-fixture" title="Link to this heading">¶</a></h3>
<p><strong>Override a fixture on a folder (conftest) level</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-27-27-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-27-27-0" name="27-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-27-27-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-27-27-1" name="27-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-27-27-0" class="sphinx-tabs-panel" id="panel-27-27-0" name="27-0" role="tabpanel" tabindex="0"><p>给定的测试文件结构为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/conftest.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/test_something.py 的内容</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">subfolder</span><span class="o">/</span>
        <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># tests/subfolder/conftest.py 的内容</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;overridden-&#39;</span> <span class="o">+</span> <span class="n">username</span>

        <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># tests/subfolder/test_something_else.py 的内容</span>
            <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;overridden-username&#39;</span>
</pre></div>
</div>
<p>如您所见，可以在特定的测试文件夹级别覆盖同名的 fixture。
请注意，可以轻松访问 <code class="docutils literal notranslate"><span class="pre">overriding</span></code> fixture 中的 <code class="docutils literal notranslate"><span class="pre">base</span></code> 或 <code class="docutils literal notranslate"><span class="pre">super</span></code> fixture —— 如上例所示。</p>
</div><div aria-labelledby="tab-27-27-1" class="sphinx-tabs-panel" hidden="true" id="panel-27-27-1" name="27-1" role="tabpanel" tabindex="0"><p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">subfolder</span><span class="o">/</span>
        <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subfolder/conftest.py</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;overridden-&#39;</span> <span class="o">+</span> <span class="n">username</span>

        <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subfolder/test_something_else.py</span>
            <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;overridden-username&#39;</span>
</pre></div>
</div>
<p>As you can see, a fixture with the same name can be overridden for certain test folder level.
Note that the <code class="docutils literal notranslate"><span class="pre">base</span></code> or <code class="docutils literal notranslate"><span class="pre">super</span></code> fixture can be accessed from the <code class="docutils literal notranslate"><span class="pre">overriding</span></code>
fixture easily - used in the example above.</p>
</div></div>
</section>
<section id="id20">
<h3>在测试模块级别覆盖一个fixture<a class="headerlink" href="#id20" title="Link to this heading">¶</a></h3>
<p><strong>Override a fixture on a test module level</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-28-28-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-28-28-0" name="28-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-28-28-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-28-28-1" name="28-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-28-28-0" class="sphinx-tabs-panel" id="panel-28-28-0" name="28-0" role="tabpanel" tabindex="0"><p>给定的测试文件结构为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/conftest.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/test_something.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;overridden-&#39;</span> <span class="o">+</span> <span class="n">username</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;overridden-username&#39;</span>

    <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/test_something_else.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;overridden-else-&#39;</span> <span class="o">+</span> <span class="n">username</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;overridden-else-username&#39;</span>
</pre></div>
</div>
<p>在上述示例中，可以在特定测试模块中覆盖同名的 fixture。</p>
</div><div aria-labelledby="tab-28-28-1" class="sphinx-tabs-panel" hidden="true" id="panel-28-28-1" name="28-1" role="tabpanel" tabindex="0"><p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;overridden-&#39;</span> <span class="o">+</span> <span class="n">username</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;overridden-username&#39;</span>

    <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something_else.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;overridden-else-&#39;</span> <span class="o">+</span> <span class="n">username</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;overridden-else-username&#39;</span>
</pre></div>
</div>
<p>In the example above, a fixture with the same name can be overridden for certain test module.</p>
</div></div>
</section>
<section id="id21">
<h3>使用直接测试参数化覆盖一个fixture<a class="headerlink" href="#id21" title="Link to this heading">¶</a></h3>
<p><strong>Override a fixture with direct test parametrization</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-29-29-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-29-29-0" name="29-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-29-29-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-29-29-1" name="29-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-29-29-0" class="sphinx-tabs-panel" id="panel-29-29-0" name="29-0" role="tabpanel" tabindex="0"><p>给定的测试文件结构为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/conftest.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">other_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;other-&#39;</span> <span class="o">+</span> <span class="n">username</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/test_something.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;directly-overridden-username&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;directly-overridden-username&#39;</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;directly-overridden-username-other&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">test_username_other</span><span class="p">(</span><span class="n">other_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">other_username</span> <span class="o">==</span> <span class="s1">&#39;other-directly-overridden-username-other&#39;</span>
</pre></div>
</div>
<p>在上述示例中，fixture 的值被测试参数值覆盖。请注意，即使测试没有直接使用该 fixture（在函数原型中未提及），fixture 的值仍可以通过这种方式被覆盖。</p>
</div><div aria-labelledby="tab-29-29-1" class="sphinx-tabs-panel" hidden="true" id="panel-29-29-1" name="29-1" role="tabpanel" tabindex="0"><p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">other_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;other-&#39;</span> <span class="o">+</span> <span class="n">username</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;directly-overridden-username&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;directly-overridden-username&#39;</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;directly-overridden-username-other&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">test_username_other</span><span class="p">(</span><span class="n">other_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">other_username</span> <span class="o">==</span> <span class="s1">&#39;other-directly-overridden-username-other&#39;</span>
</pre></div>
</div>
<p>In the example above, a fixture value is overridden by the test parameter value. Note that the value of the fixture
can be overridden this way even if the test doesn’t use it directly (doesn’t mention it in the function prototype).</p>
</div></div>
</section>
<section id="fixturefixture">
<h3>使用非参数化的fixture覆盖参数化的fixture，反之亦然<a class="headerlink" href="#fixturefixture" title="Link to this heading">¶</a></h3>
<p><strong>Override a parametrized fixture with non-parametrized one and vice versa</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-30-30-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-30-30-0" name="30-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-30-30-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-30-30-1" name="30-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-30-30-0" class="sphinx-tabs-panel" id="panel-30-30-0" name="30-0" role="tabpanel" tabindex="0"><p>给定的测试文件结构为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/conftest.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">non_parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/test_something.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">parametrized_username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;overridden-username&#39;</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">non_parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">parametrized_username</span> <span class="o">==</span> <span class="s1">&#39;overridden-username&#39;</span>

        <span class="k">def</span> <span class="nf">test_parametrized_username</span><span class="p">(</span><span class="n">non_parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">non_parametrized_username</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">]</span>

    <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/test_something_else.py 的内容</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">parametrized_username</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">non_parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">non_parametrized_username</span> <span class="o">==</span> <span class="s1">&#39;username&#39;</span>
</pre></div>
</div>
<p>在上述示例中，一个参数化的 fixture 被非参数化版本覆盖，
而一个非参数化的 fixture 则在特定测试模块中被参数化版本覆盖。
显然，这同样适用于测试文件夹级别。</p>
</div><div aria-labelledby="tab-30-30-1" class="sphinx-tabs-panel" hidden="true" id="panel-30-30-1" name="30-1" role="tabpanel" tabindex="0"><p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">non_parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;username&#39;</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">parametrized_username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;overridden-username&#39;</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">non_parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">parametrized_username</span> <span class="o">==</span> <span class="s1">&#39;overridden-username&#39;</span>

        <span class="k">def</span> <span class="nf">test_parametrized_username</span><span class="p">(</span><span class="n">non_parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">non_parametrized_username</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">]</span>

    <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something_else.py</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">parametrized_username</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">non_parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">non_parametrized_username</span> <span class="o">==</span> <span class="s1">&#39;username&#39;</span>
</pre></div>
</div>
<p>In the example above, a parametrized fixture is overridden with a non-parametrized version, and
a non-parametrized fixture is overridden with a parametrized version for certain test module.
The same applies for the test folder level obviously.</p>
</div></div>
</section>
</section>
<section id="id22">
<h2>使用其他项目的fixtures<a class="headerlink" href="#id22" title="Link to this heading">¶</a></h2>
<p><strong>Using fixtures from other projects</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-31-31-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-31-31-0" name="31-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-31-31-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-31-31-1" name="31-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-31-31-0" class="sphinx-tabs-panel" id="panel-31-31-0" name="31-0" role="tabpanel" tabindex="0"><p>通常，提供 pytest 支持的项目将使用 <a class="reference internal" href="writing_plugins.html#pip-installable-plugins"><span class="std std-ref">entry points</span></a>，
因此，只需将这些项目安装到环境中，即可使这些 fixtures 可用。</p>
<p>如果您想使用来自不使用 entry points 的项目的 fixtures，您可以在顶层 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件中定义 <a class="reference internal" href="../reference/reference.html#globalvar-2"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytest_plugins</span></code></a>，
以将该模块注册为插件。</p>
<p>假设您在 <code class="docutils literal notranslate"><span class="pre">mylibrary.fixtures</span></code> 中有一些 fixtures，并且想将它们重用到您的 <code class="docutils literal notranslate"><span class="pre">app/tests</span></code> 目录中。</p>
<p>您只需在 <code class="docutils literal notranslate"><span class="pre">app/tests/conftest.py</span></code> 中定义 <a class="reference internal" href="../reference/reference.html#globalvar-2"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytest_plugins</span></code></a> 指向该模块即可。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytest_plugins</span> <span class="o">=</span> <span class="s2">&quot;mylibrary.fixtures&quot;</span>
</pre></div>
</div>
<p>这有效地将 <code class="docutils literal notranslate"><span class="pre">mylibrary.fixtures</span></code> 注册为插件，使其所有的 fixtures 和钩子可用于 <code class="docutils literal notranslate"><span class="pre">app/tests</span></code> 中的测试。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>有时用户会从其他项目 <em>import</em> fixtures 以供使用，但这并不推荐：将 fixtures 导入模块会将它们在 pytest 中注册为 <em>defined</em> 在该模块中。</p>
<p>这会有一些小影响，比如在 <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--help</span></code> 中多次出现，但这并不 <strong>推荐</strong>，因为此行为可能在未来版本中发生变化或停止工作。</p>
</div>
</div><div aria-labelledby="tab-31-31-1" class="sphinx-tabs-panel" hidden="true" id="panel-31-31-1" name="31-1" role="tabpanel" tabindex="0"><p>Usually projects that provide pytest support will use <a class="reference internal" href="writing_plugins.html#pip-installable-plugins"><span class="std std-ref">entry points</span></a>,
so just installing those projects into an environment will make those fixtures available for use.</p>
<p>In case you want to use fixtures from a project that does not use entry points, you can
define <a class="reference internal" href="../reference/reference.html#globalvar-2"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytest_plugins</span></code></a> in your top <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file to register that module
as a plugin.</p>
<p>Suppose you have some fixtures in <code class="docutils literal notranslate"><span class="pre">mylibrary.fixtures</span></code> and you want to reuse them into your
<code class="docutils literal notranslate"><span class="pre">app/tests</span></code> directory.</p>
<p>All you need to do is to define <a class="reference internal" href="../reference/reference.html#globalvar-2"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytest_plugins</span></code></a> in <code class="docutils literal notranslate"><span class="pre">app/tests/conftest.py</span></code>
pointing to that module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytest_plugins</span> <span class="o">=</span> <span class="s2">&quot;mylibrary.fixtures&quot;</span>
</pre></div>
</div>
<p>This effectively registers <code class="docutils literal notranslate"><span class="pre">mylibrary.fixtures</span></code> as a plugin, making all its fixtures and
hooks available to tests in <code class="docutils literal notranslate"><span class="pre">app/tests</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sometimes users will <em>import</em> fixtures from other projects for use, however this is not
recommended: importing fixtures into a module will register them in pytest
as <em>defined</em> in that module.</p>
<p>This has minor consequences, such as appearing multiple times in <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--help</span></code>,
but it is not <strong>recommended</strong> because this behavior might change/stop working
in future versions.</p>
</div>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="mark.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">如何用属性标记测试函数</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="assert.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">如何在测试中编写和报告断言</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2015, holger krekel and pytest-dev team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">如何使用 fixture</a><ul>
<li><a class="reference internal" href="#fixtures">“请求” fixtures</a><ul>
<li><a class="reference internal" href="#id1">快速示例</a></li>
<li><a class="reference internal" href="#fixture-fixture">fixture 可以 <strong>请求</strong> 其他 fixture</a></li>
<li><a class="reference internal" href="#id2">Fixtures 可重复使用</a></li>
<li><a class="reference internal" href="#id3">一个 测试/fixture 可以一次**请求**多个fixture</a></li>
<li><a class="reference internal" href="#id4">fixtures 可以在每个测试中被 <strong>请求</strong> 多次（返回值会被缓存）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fixtures-fixtures">自动使用的 fixtures（不需要显式请求的 fixtures）</a></li>
<li><a class="reference internal" href="#scope-fixture">Scope: 跨类、模块、包或会话共享fixture</a><ul>
<li><a class="reference internal" href="#fixture-scope">Fixture 的 scope</a></li>
<li><a class="reference internal" href="#scope">动态 scope</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cleanup-teardown-fixture">清理(Cleanup)/收尾(Teardown)（即 Fixture 最终化）</a><ul>
<li><a class="reference internal" href="#yield-fixtures">1. <code class="docutils literal notranslate"><span class="pre">yield</span></code> fixtures (推荐方式)</a><ul>
<li><a class="reference internal" href="#yield-fixture">处理 yield fixture 的错误</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">2. 直接添加终结器</a><ul>
<li><a class="reference internal" href="#id7">注意终结器的顺序</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#safe-teardowns">安全的收尾</a><ul>
<li><a class="reference internal" href="#safe-fixture-structure">安全的 fixture 结构</a></li>
</ul>
</li>
<li><a class="reference internal" href="#assert">安全地运行多个 <code class="docutils literal notranslate"><span class="pre">assert</span></code> 语句</a></li>
<li><a class="reference internal" href="#request-context">Fixtures 可以检查请求的测试上下文</a></li>
<li><a class="reference internal" href="#using-markers">使用标记将数据传递给fixture</a></li>
<li><a class="reference internal" href="#fixture-factory">fixture 工厂</a></li>
<li><a class="reference internal" href="#fixture-parametrize">参数化 fixture</a></li>
<li><a class="reference internal" href="#fixture-parametrize-marks">与标记一起的参数化 fixture</a></li>
<li><a class="reference internal" href="#interdependent-fixtures">模块化：使用 Fixture 函数中的 Fixture</a></li>
<li><a class="reference internal" href="#automatic-per-resource-grouping">根据fixture实例自动对测试进行分组</a></li>
<li><a class="reference internal" href="#usefixtures-fixture">在类和模块中通过 <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> 使用 fixture</a></li>
<li><a class="reference internal" href="#override-fixtures">覆盖各个级别的fixtures</a><ul>
<li><a class="reference internal" href="#conftest-fixture">覆盖文件夹（conftest）级别的fixture</a></li>
<li><a class="reference internal" href="#id20">在测试模块级别覆盖一个fixture</a></li>
<li><a class="reference internal" href="#id21">使用直接测试参数化覆盖一个fixture</a></li>
<li><a class="reference internal" href="#fixturefixture">使用非参数化的fixture覆盖参数化的fixture，反之亦然</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id22">使用其他项目的fixtures</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=7c91f8fd"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>