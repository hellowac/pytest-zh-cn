<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../search.html" /><link rel="next" title="如何运行文档测试" href="doctest.html" /><link rel="prev" title="如何在测试中使用临时目录和文件" href="tmp_path.html" />
        <link rel="canonical" href="https://docs.pytest.org/en/stable/how-to/monkeypatch.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>如何使用 猴子补丁/mock 模块和环境 - pytest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments_pytest.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/pytest-custom.css?v=eb7c59a4" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">pytest documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/pytest1.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">入门</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">操作指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 操作指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="usage.html">如何调用 pytest</a></li>
<li class="toctree-l2"><a class="reference internal" href="assert.html">如何在测试中编写和报告断言</a></li>
<li class="toctree-l2"><a class="reference internal" href="fixtures.html">如何使用 fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="mark.html">如何用属性标记测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="parametrize.html">如何参数化fixtures和测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="tmp_path.html">如何在测试中使用临时目录和文件</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">如何使用 猴子补丁/mock 模块和环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="doctest.html">如何运行文档测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="cache.html">如何重新运行失败的测试并在测试运行之间保持状态</a></li>
<li class="toctree-l2"><a class="reference internal" href="failures.html">如何处理测试失败</a></li>
<li class="toctree-l2"><a class="reference internal" href="output.html">管理 pytest 的输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">如何管理日志记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-stdout-stderr.html">如何捕获 stdout/stderr 输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-warnings.html">如何捕获警告</a></li>
<li class="toctree-l2"><a class="reference internal" href="skipping.html">如何使用 skip 和 xfail 处理无法成功的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">如何安装和使用插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_plugins.html">编写插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_hook_functions.html">编写钩子函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="existingtestsuite.html">如何将 pytest 与现有测试套件结合使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="unittest.html">如何在 pytest 中使用基于 unittest 的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="xunit_setup.html">如何实现 xunit 样式的设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="bash-completion.html">如何设置 bash 补全</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">参考指南</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 参考指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/reference.html">API 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/fixtures.html">Fixtures 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/customize.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/exit-codes.html">退出码</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/plugin_list.html">Pytest 插件列表</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../explanation/index.html">解答</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 解答</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanation/anatomy.html">测试剖析</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/fixtures.html">关于 fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/goodpractices.html">良好的集成实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/pythonpath.html">pytest 导入机制和 <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> / <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/ci.html">CI Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/flaky.html">不稳定的测试</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../example/index.html">示例和自定义技巧</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 示例和自定义技巧</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../example/reportingdemo.html">使用 pytest 的 Python 故障报告演示</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/simple.html">基本模式和示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/parametrize.html">参数化测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/markers.html">使用自定义标记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/special.html">可以查看所有收集到的测试的会话fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/pythoncollection.html">改变标准 (Python) 测试的发现机制</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/nonpython.html">使用非 Python 测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/customdirectory.html">使用自定义目录收集器</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">关于项目</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html">向后兼容政策</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#id2">历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#python">Python版本支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sponsor.html">赞助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tidelift.html">pytest 企业版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">许可</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">联系渠道</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">游泳的链接</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/pytest/">pytest @ PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/">pytest @ GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/issues">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://media.readthedocs.org/pdf/pytest/latest/pytest.pdf">PDF Documentation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="mock">
<span id="monkeypatching"></span><h1>如何使用 猴子补丁/mock 模块和环境<a class="headerlink" href="#mock" title="Link to this heading">¶</a></h1>
<p><strong>How to monkeypatch/mock modules and environments</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>有时，测试需要调用依赖于全局设置的功能，或者调用一些无法轻易测试的代码，例如网络访问。 <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> fixture 可以帮助您安全地设置/删除属性、字典项或环境变量，或修改 <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> 以进行导入。</p>
<p><code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> fixture 提供了以下辅助方法，用于在测试中安全地修补和模拟功能：</p>
<ul class="simple">
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr(obj,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delattr" title="pytest.MonkeyPatch.delattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delattr(obj,</span> <span class="pre">name,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setitem" title="pytest.MonkeyPatch.setitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setitem(mapping,</span> <span class="pre">name,</span> <span class="pre">value)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delitem" title="pytest.MonkeyPatch.delitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delitem(obj,</span> <span class="pre">name,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setenv" title="pytest.MonkeyPatch.setenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setenv(name,</span> <span class="pre">value,</span> <span class="pre">prepend=None)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delenv" title="pytest.MonkeyPatch.delenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delenv(name,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.syspath_prepend" title="pytest.MonkeyPatch.syspath_prepend"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.syspath_prepend(path)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.chdir" title="pytest.MonkeyPatch.chdir"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.chdir(path)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.context" title="pytest.MonkeyPatch.context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.context()</span></code></a></p></li>
</ul>
<p>所有修改将在请求的测试函数或fixture 完成后撤销。 <code class="docutils literal notranslate"><span class="pre">raising</span></code> 参数决定如果设置/删除操作的目标不存在时，是否会引发 <code class="docutils literal notranslate"><span class="pre">KeyError</span></code> 或 <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code>。</p>
<p>考虑以下场景：</p>
<ol class="arabic simple">
<li><p>修改函数的行为或类的属性进行测试，例如，您不会为测试进行 API 调用或数据库连接，但您知道预期的输出应该是什么。使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a> 来修补函数或属性以实现您所需的测试行为。这可以包括您自己的函数。使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delattr" title="pytest.MonkeyPatch.delattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delattr</span></code></a> 在测试中删除该函数或属性。</p></li>
<li><p>修改字典的值，例如，您有一个全局配置，希望为某些测试用例进行修改。使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setitem" title="pytest.MonkeyPatch.setitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setitem</span></code></a> 来修补字典以进行测试。可以使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delitem" title="pytest.MonkeyPatch.delitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delitem</span></code></a> 来删除项目。</p></li>
<li><p>修改环境变量进行测试，例如，测试程序行为在缺少某个环境变量时，或者将多个值设置为已知变量。可以使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setenv" title="pytest.MonkeyPatch.setenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setenv</span></code></a> 和 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delenv" title="pytest.MonkeyPatch.delenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delenv</span></code></a> 进行这些修补。</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">monkeypatch.setenv(&quot;PATH&quot;,</span> <span class="pre">value,</span> <span class="pre">prepend=os.pathsep)</span></code> 来修改 <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>，并使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.chdir" title="pytest.MonkeyPatch.chdir"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.chdir</span></code></a> 在测试期间更改当前工作目录的上下文。</p></li>
<li><p>使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.syspath_prepend" title="pytest.MonkeyPatch.syspath_prepend"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.syspath_prepend</span></code></a> 来修改 <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>，这也将调用 <code class="docutils literal notranslate"><span class="pre">pkg_resources.fixup_namespace_packages</span></code> 和 <a class="reference external" href="https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches" title="(in Python v3.13)"><code class="xref py py-func docutils literal notranslate"><span class="pre">importlib.invalidate_caches()</span></code></a>。</p></li>
<li><p>使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.context" title="pytest.MonkeyPatch.context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.context</span></code></a> 仅在特定范围内应用修补，这可以帮助控制复杂fixture 或标准库的修补的拆卸。</p></li>
</ol>
<p>请参见 <a class="reference external" href="https://tetamap.wordpress.com//2009/03/03/monkeypatching-in-unit-tests-done-right/">monkeypatch blog post</a> 以获取一些介绍材料和其动机的讨论。</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>Sometimes tests need to invoke functionality which depends
on global settings or which invokes code which cannot be easily
tested such as network access.  The <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> fixture
helps you to safely set/delete an attribute, dictionary item or
environment variable, or to modify <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> for importing.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> fixture provides these helper methods for safely patching and mocking
functionality in tests:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr(obj,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delattr" title="pytest.MonkeyPatch.delattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delattr(obj,</span> <span class="pre">name,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setitem" title="pytest.MonkeyPatch.setitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setitem(mapping,</span> <span class="pre">name,</span> <span class="pre">value)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delitem" title="pytest.MonkeyPatch.delitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delitem(obj,</span> <span class="pre">name,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setenv" title="pytest.MonkeyPatch.setenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setenv(name,</span> <span class="pre">value,</span> <span class="pre">prepend=None)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delenv" title="pytest.MonkeyPatch.delenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delenv(name,</span> <span class="pre">raising=True)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.syspath_prepend" title="pytest.MonkeyPatch.syspath_prepend"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.syspath_prepend(path)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.chdir" title="pytest.MonkeyPatch.chdir"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.chdir(path)</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.context" title="pytest.MonkeyPatch.context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.context()</span></code></a></p></li>
</ul>
<p>All modifications will be undone after the requesting
test function or fixture has finished. The <code class="docutils literal notranslate"><span class="pre">raising</span></code>
parameter determines if a <code class="docutils literal notranslate"><span class="pre">KeyError</span></code> or <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code>
will be raised if the target of the set/deletion operation does not exist.</p>
<p>Consider the following scenarios:</p>
<p>1. Modifying the behavior of a function or the property of a class for a test e.g.
there is an API call or database connection you will not make for a test but you know
what the expected output should be. Use <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a> to patch the
function or property with your desired testing behavior. This can include your own functions.
Use <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delattr" title="pytest.MonkeyPatch.delattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delattr</span></code></a> to remove the function or property for the test.</p>
<p>2. Modifying the values of dictionaries e.g. you have a global configuration that
you want to modify for certain test cases. Use <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setitem" title="pytest.MonkeyPatch.setitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setitem</span></code></a> to patch the
dictionary for the test. <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delitem" title="pytest.MonkeyPatch.delitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delitem</span></code></a> can be used to remove items.</p>
<p>3. Modifying environment variables for a test e.g. to test program behavior if an
environment variable is missing, or to set multiple values to a known variable.
<a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setenv" title="pytest.MonkeyPatch.setenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setenv</span></code></a> and <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delenv" title="pytest.MonkeyPatch.delenv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delenv</span></code></a> can be used for
these patches.</p>
<p>4. Use <code class="docutils literal notranslate"><span class="pre">monkeypatch.setenv(&quot;PATH&quot;,</span> <span class="pre">value,</span> <span class="pre">prepend=os.pathsep)</span></code> to modify <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>, and
<a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.chdir" title="pytest.MonkeyPatch.chdir"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.chdir</span></code></a> to change the context of the current working directory
during a test.</p>
<p>5. Use <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.syspath_prepend" title="pytest.MonkeyPatch.syspath_prepend"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.syspath_prepend</span></code></a> to modify <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> which will also
call <code class="docutils literal notranslate"><span class="pre">pkg_resources.fixup_namespace_packages</span></code> and <a class="reference external" href="https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches" title="(in Python v3.13)"><code class="xref py py-func docutils literal notranslate"><span class="pre">importlib.invalidate_caches()</span></code></a>.</p>
<p>6. Use <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.context" title="pytest.MonkeyPatch.context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.context</span></code></a> to apply patches only in a specific scope, which can help
control teardown of complex fixtures or patches to the stdlib.</p>
<p>See the <a class="reference external" href="https://tetamap.wordpress.com//2009/03/03/monkeypatching-in-unit-tests-done-right/">monkeypatch blog post</a> for some introduction material
and a discussion of its motivation.</p>
</div></div>
<section id="id1">
<h2>猴子补丁函数<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p><strong>Monkeypatching functions</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>考虑一个场景，您正在处理用户目录。在测试的上下文中，您不希望测试依赖于运行用户。 <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> 可以用来修补依赖于用户的函数，以始终返回一个特定值。</p>
<p>在这个例子中，使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a> 来修补 <code class="docutils literal notranslate"><span class="pre">Path.home</span></code>，使得在运行测试时，总是使用已知的测试路径 <code class="docutils literal notranslate"><span class="pre">Path(&quot;/abc&quot;)</span></code>。这消除了测试目的上对运行用户的任何依赖。必须在将要使用被修补函数的函数被调用之前调用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a>。测试函数完成后，<code class="docutils literal notranslate"><span class="pre">Path.home</span></code> 的修改将被撤销。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_module.py with source code and the test</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">getssh</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;简单函数返回扩展的主目录 ssh 路径。&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.ssh&quot;</span>


<span class="k">def</span> <span class="nf">test_getssh</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># 模拟的返回函数来替换 Path.home</span>
    <span class="c1"># 始终返回 &#39;/abc&#39;</span>
    <span class="k">def</span> <span class="nf">mockreturn</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/abc&quot;</span><span class="p">)</span>

    <span class="c1"># 应用 monkeypatch 来将 Path.home 替换为</span>
    <span class="c1"># 上面定义的 mockreturn 的行为。</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="n">mockreturn</span><span class="p">)</span>

    <span class="c1"># 调用 getssh() 将在此测试中使用 mockreturn</span>
    <span class="c1"># 替代 Path.home。</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">getssh</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/abc/.ssh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>Consider a scenario where you are working with user directories. In the context of
testing, you do not want your test to depend on the running user. <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code>
can be used to patch functions dependent on the user to always return a
specific value.</p>
<p>In this example, <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a> is used to patch <code class="docutils literal notranslate"><span class="pre">Path.home</span></code>
so that the known testing path <code class="docutils literal notranslate"><span class="pre">Path(&quot;/abc&quot;)</span></code> is always used when the test is run.
This removes any dependency on the running user for testing purposes.
<a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a> must be called before the function which will use
the patched function is called.
After the test function finishes the <code class="docutils literal notranslate"><span class="pre">Path.home</span></code> modification will be undone.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_module.py with source code and the test</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">getssh</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple function to return expanded homedir ssh path.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.ssh&quot;</span>


<span class="k">def</span> <span class="nf">test_getssh</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># mocked return function to replace Path.home</span>
    <span class="c1"># always return &#39;/abc&#39;</span>
    <span class="k">def</span> <span class="nf">mockreturn</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/abc&quot;</span><span class="p">)</span>

    <span class="c1"># Application of the monkeypatch to replace Path.home</span>
    <span class="c1"># with the behavior of mockreturn defined above.</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="n">mockreturn</span><span class="p">)</span>

    <span class="c1"># Calling getssh() will use mockreturn in place of Path.home</span>
    <span class="c1"># for this test with the monkeypatch.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">getssh</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/abc/.ssh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id2">
<h2>猴子补丁返回对象: 构建mock类<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p><strong>Monkeypatching returned objects: building mock classes</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a> 可以与类一起使用，以模拟函数返回的对象，而不是值。想象一个简单的函数，它接受一个 API URL 并返回 JSON 响应。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of app.py, a simple API retrieval example</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">get_json</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;接受一个 URL，并返回 JSON。&quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
<p>我们需要模拟 <code class="docutils literal notranslate"><span class="pre">r</span></code>，即返回的响应对象，以便于测试。对 <code class="docutils literal notranslate"><span class="pre">r</span></code> 的模拟需要一个 <code class="docutils literal notranslate"><span class="pre">.json()</span></code> 方法，返回一个字典。这可以在我们的测试文件中通过定义一个类来表示 <code class="docutils literal notranslate"><span class="pre">r</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py, a simple test for our API retrieval</span>
<span class="c1"># 为了进行 monkeypatching 导入 requests</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># 包含 get_json() 函数的 app.py</span>
<span class="c1"># 这是之前代码块的示例</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="c1"># 自定义类作为模拟返回值</span>
<span class="c1"># 将覆盖 requests.get 返回的 requests.Response</span>
<span class="k">class</span> <span class="nc">MockResponse</span><span class="p">:</span>
    <span class="c1"># 模拟的 json() 方法始终返回一个特定的测试字典</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">json</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mock_key&quot;</span><span class="p">:</span> <span class="s2">&quot;mock_response&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">test_get_json</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># 任何参数都可以传入，mock_get() 将始终返回我们的</span>
    <span class="c1"># 模拟对象，该对象仅具有 .json() 方法。</span>
    <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MockResponse</span><span class="p">()</span>

    <span class="c1"># 将 monkeypatch 应用于 requests.get，替换为 mock_get</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="c1"># app.get_json，其中包含 requests.get，使用了 monkeypatch</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="s2">&quot;https://fakeurl&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mock_key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mock_response&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> 用我们的 <code class="docutils literal notranslate"><span class="pre">mock_get</span></code> 函数对 <code class="docutils literal notranslate"><span class="pre">requests.get</span></code> 进行了模拟。
<code class="docutils literal notranslate"><span class="pre">mock_get</span></code> 函数返回 <code class="docutils literal notranslate"><span class="pre">MockResponse</span></code> 类的一个实例，该类定义了一个 <code class="docutils literal notranslate"><span class="pre">json()</span></code> 方法，以返回一个已知的测试字典，并且不需要任何外部 API 连接。</p>
<p>您可以根据要测试的场景构建适当复杂度的 <code class="docutils literal notranslate"><span class="pre">MockResponse</span></code> 类。例如，它可以包含一个始终返回 <code class="docutils literal notranslate"><span class="pre">True</span></code> 的 <code class="docutils literal notranslate"><span class="pre">ok</span></code> 属性，或者根据输入字符串从模拟的 <code class="docutils literal notranslate"><span class="pre">json()</span></code> 方法返回不同的值。</p>
<p>这个模拟可以通过 <code class="docutils literal notranslate"><span class="pre">fixture</span></code> 在多个测试之间共享：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py, a simple test for our API retrieval</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># 包含 get_json() 函数的 app.py</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="c1"># 自定义类作为 requests.get() 的模拟返回值</span>
<span class="k">class</span> <span class="nc">MockResponse</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">json</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mock_key&quot;</span><span class="p">:</span> <span class="s2">&quot;mock_response&quot;</span><span class="p">}</span>


<span class="c1"># monkeypatched 的 requests.get 移动到 fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_response</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Requests.get() 模拟返回 {&#39;mock_key&#39;:&#39;mock_response&#39;}。&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MockResponse</span><span class="p">()</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>


<span class="c1"># 注意我们的测试使用了自定义 fixture，而不是直接使用 monkeypatch</span>
<span class="k">def</span> <span class="nf">test_get_json</span><span class="p">(</span><span class="n">mock_response</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="s2">&quot;https://fakeurl&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mock_key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mock_response&quot;</span>
</pre></div>
</div>
<p>此外，如果模拟被设计为应用于所有测试，则可以将 <code class="docutils literal notranslate"><span class="pre">fixture</span></code> 移动到 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件中，并使用 <code class="docutils literal notranslate"><span class="pre">autouse=True</span></code> 选项。</p>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setattr" title="pytest.MonkeyPatch.setattr"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setattr</span></code></a> can be used in conjunction with classes to mock returned
objects from functions instead of values.
Imagine a simple function to take an API url and return the json response.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of app.py, a simple API retrieval example</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">get_json</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes a URL, and returns the JSON.&quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
<p>We need to mock <code class="docutils literal notranslate"><span class="pre">r</span></code>, the returned response object for testing purposes.
The mock of <code class="docutils literal notranslate"><span class="pre">r</span></code> needs a <code class="docutils literal notranslate"><span class="pre">.json()</span></code> method which returns a dictionary.
This can be done in our test file by defining a class to represent <code class="docutils literal notranslate"><span class="pre">r</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py, a simple test for our API retrieval</span>
<span class="c1"># import requests for the purposes of monkeypatching</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># our app.py that includes the get_json() function</span>
<span class="c1"># this is the previous code block example</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="c1"># custom class to be the mock return value</span>
<span class="c1"># will override the requests.Response returned from requests.get</span>
<span class="k">class</span> <span class="nc">MockResponse</span><span class="p">:</span>
    <span class="c1"># mock json() method always returns a specific testing dictionary</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">json</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mock_key&quot;</span><span class="p">:</span> <span class="s2">&quot;mock_response&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">test_get_json</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># Any arguments may be passed and mock_get() will always return our</span>
    <span class="c1"># mocked object, which only has the .json() method.</span>
    <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MockResponse</span><span class="p">()</span>

    <span class="c1"># apply the monkeypatch for requests.get to mock_get</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="c1"># app.get_json, which contains requests.get, uses the monkeypatch</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="s2">&quot;https://fakeurl&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mock_key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mock_response&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> applies the mock for <code class="docutils literal notranslate"><span class="pre">requests.get</span></code> with our <code class="docutils literal notranslate"><span class="pre">mock_get</span></code> function.
The <code class="docutils literal notranslate"><span class="pre">mock_get</span></code> function returns an instance of the <code class="docutils literal notranslate"><span class="pre">MockResponse</span></code> class, which
has a <code class="docutils literal notranslate"><span class="pre">json()</span></code> method defined to return a known testing dictionary and does not
require any outside API connection.</p>
<p>You can build the <code class="docutils literal notranslate"><span class="pre">MockResponse</span></code> class with the appropriate degree of complexity for
the scenario you are testing. For instance, it could include an <code class="docutils literal notranslate"><span class="pre">ok</span></code> property that
always returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, or return different values from the <code class="docutils literal notranslate"><span class="pre">json()</span></code> mocked method
based on input strings.</p>
<p>This mock can be shared across tests using a <code class="docutils literal notranslate"><span class="pre">fixture</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py, a simple test for our API retrieval</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># app.py that includes the get_json() function</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="c1"># custom class to be the mock return value of requests.get()</span>
<span class="k">class</span> <span class="nc">MockResponse</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">json</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mock_key&quot;</span><span class="p">:</span> <span class="s2">&quot;mock_response&quot;</span><span class="p">}</span>


<span class="c1"># monkeypatched requests.get moved to a fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_response</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Requests.get() mocked to return {&#39;mock_key&#39;:&#39;mock_response&#39;}.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MockResponse</span><span class="p">()</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>


<span class="c1"># notice our test uses the custom fixture instead of monkeypatch directly</span>
<span class="k">def</span> <span class="nf">test_get_json</span><span class="p">(</span><span class="n">mock_response</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="s2">&quot;https://fakeurl&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mock_key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mock_response&quot;</span>
</pre></div>
</div>
<p>Furthermore, if the mock was designed to be applied to all tests, the <code class="docutils literal notranslate"><span class="pre">fixture</span></code> could
be moved to a <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and use the with <code class="docutils literal notranslate"><span class="pre">autouse=True</span></code> option.</p>
</div></div>
</section>
<section id="id3">
<h2>全局补丁示例：阻止远程操作的“请求”<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Global patch example: preventing “requests” from remote operations</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>如果您想防止 “requests” 库在所有测试中执行 HTTP 请求，可以这样做：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of conftest.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">no_requests</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;为所有测试移除 requests.sessions.Session.request。&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delattr</span><span class="p">(</span><span class="s2">&quot;requests.sessions.Session.request&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>这个自动使用的 fixture 将在每个测试函数中执行，它将删除方法 <code class="docutils literal notranslate"><span class="pre">request.session.Session.request</span></code>，因此测试中任何尝试创建 HTTP 请求的操作都将失败。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>请注意，不建议修改内置函数，例如 <code class="docutils literal notranslate"><span class="pre">open</span></code>、<code class="docutils literal notranslate"><span class="pre">compile</span></code> 等，因为这可能会破坏 pytest 的内部功能。如果这是不可避免的，传递 <code class="docutils literal notranslate"><span class="pre">--tb=native</span></code>、<code class="docutils literal notranslate"><span class="pre">--assert=plain</span></code> 和 <code class="docutils literal notranslate"><span class="pre">--capture=no</span></code> 可能会有所帮助，但不能保证有效。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>请注意，修改 <code class="docutils literal notranslate"><span class="pre">stdlib</span></code> 函数和 pytest 使用的一些第三方库可能会破坏 pytest 本身，因此在这些情况下，建议使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.context" title="pytest.MonkeyPatch.context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MonkeyPatch.context()</span></code></a> 将补丁限制在您想要测试的块中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>


<span class="k">def</span> <span class="nf">test_partial</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">functools</span><span class="p">,</span> <span class="s2">&quot;partial&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div>
</div>
<p>有关详细信息，请参见 <a class="reference external" href="https://github.com/pytest-dev/pytest/issues/3290">#3290</a>。</p>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>If you want to prevent the “requests” library from performing http
requests in all your tests, you can do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of conftest.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">no_requests</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove requests.sessions.Session.request for all tests.&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delattr</span><span class="p">(</span><span class="s2">&quot;requests.sessions.Session.request&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This autouse fixture will be executed for each test function and it
will delete the method <code class="docutils literal notranslate"><span class="pre">request.session.Session.request</span></code>
so that any attempts within tests to create http requests will fail.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be advised that it is not recommended to patch builtin functions such as <code class="docutils literal notranslate"><span class="pre">open</span></code>,
<code class="docutils literal notranslate"><span class="pre">compile</span></code>, etc., because it might break pytest’s internals. If that’s
unavoidable, passing <code class="docutils literal notranslate"><span class="pre">--tb=native</span></code>, <code class="docutils literal notranslate"><span class="pre">--assert=plain</span></code> and <code class="docutils literal notranslate"><span class="pre">--capture=no</span></code> might
help although there’s no guarantee.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Mind that patching <code class="docutils literal notranslate"><span class="pre">stdlib</span></code> functions and some third-party libraries used by pytest
might break pytest itself, therefore in those cases it is recommended to use
<a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.context" title="pytest.MonkeyPatch.context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MonkeyPatch.context()</span></code></a> to limit the patching to the block you want tested:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>


<span class="k">def</span> <span class="nf">test_partial</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">functools</span><span class="p">,</span> <span class="s2">&quot;partial&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://github.com/pytest-dev/pytest/issues/3290">#3290</a> for details.</p>
</div>
</div></div>
</section>
<section id="id4">
<h2>猴子补丁环境变量<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p><strong>Monkeypatching environment variables</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>如果您正在处理环境变量，通常需要安全地更改值或从系统中删除它们以进行测试。<code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> 提供了一种机制来实现这一点，使用 <code class="docutils literal notranslate"><span class="pre">setenv</span></code> 和 <code class="docutils literal notranslate"><span class="pre">delenv</span></code> 方法。我们的示例代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of our original code file e.g. code.py</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">get_os_user_lower</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;简单的检索函数。</span>
<span class="sd">    返回小写的 USER，或引发 OSError。&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;USER 环境变量未设置。&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">username</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
<p>这里有两个潜在的路径。首先，<code class="docutils literal notranslate"><span class="pre">USER</span></code> 环境变量被设置为一个值。其次，<code class="docutils literal notranslate"><span class="pre">USER</span></code> 环境变量不存在。使用 <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> 可以安全地测试这两条路径，而不会影响运行环境：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of our test file e.g. test_code.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">test_upper_to_lower</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;设置 USER 环境变量以断言行为。&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;TestingUser&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_os_user_lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;testinguser&quot;</span>


<span class="k">def</span> <span class="nf">test_raise_exception</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;移除 USER 环境变量并断言引发 OSError。&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">get_os_user_lower</span><span class="p">()</span>
</pre></div>
</div>
<p>这种行为可以移动到 <code class="docutils literal notranslate"><span class="pre">fixture</span></code> 结构中，并在测试之间共享：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of our test file e.g. test_code.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_env_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;TestingUser&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_env_missing</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># 注意测试引用了用于模拟的 fixtures</span>
<span class="k">def</span> <span class="nf">test_upper_to_lower</span><span class="p">(</span><span class="n">mock_env_user</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">get_os_user_lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;testinguser&quot;</span>


<span class="k">def</span> <span class="nf">test_raise_exception</span><span class="p">(</span><span class="n">mock_env_missing</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">get_os_user_lower</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>If you are working with environment variables you often need to safely change the values
or delete them from the system for testing purposes. <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> provides a mechanism
to do this using the <code class="docutils literal notranslate"><span class="pre">setenv</span></code> and <code class="docutils literal notranslate"><span class="pre">delenv</span></code> method. Our example code to test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of our original code file e.g. code.py</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">get_os_user_lower</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple retrieval function.</span>
<span class="sd">    Returns lowercase USER or raises OSError.&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;USER environment is not set.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">username</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
<p>There are two potential paths. First, the <code class="docutils literal notranslate"><span class="pre">USER</span></code> environment variable is set to a
value. Second, the <code class="docutils literal notranslate"><span class="pre">USER</span></code> environment variable does not exist. Using <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code>
both paths can be safely tested without impacting the running environment:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of our test file e.g. test_code.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">test_upper_to_lower</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the USER env var to assert the behavior.&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;TestingUser&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_os_user_lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;testinguser&quot;</span>


<span class="k">def</span> <span class="nf">test_raise_exception</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the USER env var and assert OSError is raised.&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">get_os_user_lower</span><span class="p">()</span>
</pre></div>
</div>
<p>This behavior can be moved into <code class="docutils literal notranslate"><span class="pre">fixture</span></code> structures and shared across tests:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of our test file e.g. test_code.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_env_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;TestingUser&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_env_missing</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># notice the tests reference the fixtures for mocks</span>
<span class="k">def</span> <span class="nf">test_upper_to_lower</span><span class="p">(</span><span class="n">mock_env_user</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">get_os_user_lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;testinguser&quot;</span>


<span class="k">def</span> <span class="nf">test_raise_exception</span><span class="p">(</span><span class="n">mock_env_missing</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">get_os_user_lower</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id5">
<h2>猴子补丁参考<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p><strong>Monkeypatching dictionaries</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setitem" title="pytest.MonkeyPatch.setitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setitem</span></code></a> 可以在测试期间安全地设置字典的值为特定值。以下是一个简化的连接字符串示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of app.py to generate a simple connection string</span>
<span class="n">DEFAULT_CONFIG</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;db1&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">create_connection_string</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;根据输入或默认值创建连接字符串。&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">DEFAULT_CONFIG</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;User Id=</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">; Location=</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;&quot;</span>
</pre></div>
</div>
<p>出于测试目的，我们可以将 <code class="docutils literal notranslate"><span class="pre">DEFAULT_CONFIG</span></code> 字典打补丁，设置为特定值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py</span>
<span class="c1"># app.py with the connection string function (prior code block)</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="k">def</span> <span class="nf">test_connection</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># 将 DEFAULT_CONFIG 的值打补丁为特定的</span>
    <span class="c1"># 测试值，仅在此测试中有效。</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;test_user&quot;</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;test_db&quot;</span><span class="p">)</span>

    <span class="c1"># 基于模拟的预期结果</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;User Id=test_user; Location=test_db;&quot;</span>

    <span class="c1"># 测试使用了猴子补丁的字典设置</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>
</div>
<p>您可以使用 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delitem" title="pytest.MonkeyPatch.delitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delitem</span></code></a> 来删除值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># app.py with the connection string function</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="k">def</span> <span class="nf">test_missing_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># 打补丁使 DEFAULT_CONFIG 缺少 &#39;user&#39; 键</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># 预期引发 KeyError，因为未传递配置，且</span>
    <span class="c1"># 默认值现在缺少 &#39;user&#39; 条目。</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
</pre></div>
</div>
<p>fixture 的模块化为您提供了定义
每个潜在模拟的独立 fixture 的灵活性，并在所需的测试中引用它们。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># app.py with the connection string function</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="c1"># 所有模拟均移入独立的 fixture 中</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_test_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;将 DEFAULT_CONFIG 的用户设置为 test_user。&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;test_user&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_test_database</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;将 DEFAULT_CONFIG 的数据库设置为 test_db。&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;test_db&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_missing_default_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;从 DEFAULT_CONFIG 中移除用户键。&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># 测试仅引用所需的 fixture 模拟</span>
<span class="k">def</span> <span class="nf">test_connection</span><span class="p">(</span><span class="n">mock_test_user</span><span class="p">,</span> <span class="n">mock_test_database</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;User Id=test_user; Location=test_db;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">def</span> <span class="nf">test_missing_user</span><span class="p">(</span><span class="n">mock_missing_default_user</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p><a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.setitem" title="pytest.MonkeyPatch.setitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.setitem</span></code></a> can be used to safely set the values of dictionaries
to specific values during tests. Take this simplified connection string example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of app.py to generate a simple connection string</span>
<span class="n">DEFAULT_CONFIG</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;db1&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">create_connection_string</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a connection string from input or defaults.&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">DEFAULT_CONFIG</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;User Id=</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">; Location=</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;&quot;</span>
</pre></div>
</div>
<p>For testing purposes we can patch the <code class="docutils literal notranslate"><span class="pre">DEFAULT_CONFIG</span></code> dictionary to specific values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py</span>
<span class="c1"># app.py with the connection string function (prior code block)</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="k">def</span> <span class="nf">test_connection</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># Patch the values of DEFAULT_CONFIG to specific</span>
    <span class="c1"># testing values only for this test.</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;test_user&quot;</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;test_db&quot;</span><span class="p">)</span>

    <span class="c1"># expected result based on the mocks</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;User Id=test_user; Location=test_db;&quot;</span>

    <span class="c1"># the test uses the monkeypatched dictionary settings</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>
</div>
<p>You can use the <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch.delitem" title="pytest.MonkeyPatch.delitem"><code class="xref py py-meth docutils literal notranslate"><span class="pre">monkeypatch.delitem</span></code></a> to remove values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># app.py with the connection string function</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="k">def</span> <span class="nf">test_missing_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># patch the DEFAULT_CONFIG t be missing the &#39;user&#39; key</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Key error expected because a config is not passed, and the</span>
    <span class="c1"># default is now missing the &#39;user&#39; entry.</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
</pre></div>
</div>
<p>The modularity of fixtures gives you the flexibility to define
separate fixtures for each potential mock and reference them in the needed tests.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_app.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># app.py with the connection string function</span>
<span class="kn">import</span> <span class="nn">app</span>


<span class="c1"># all of the mocks are moved into separated fixtures</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_test_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the DEFAULT_CONFIG user to test_user.&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;test_user&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_test_database</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the DEFAULT_CONFIG database to test_db.&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;test_db&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_missing_default_user</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the user key from DEFAULT_CONFIG&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">delitem</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">raising</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># tests reference only the fixture mocks that are needed</span>
<span class="k">def</span> <span class="nf">test_connection</span><span class="p">(</span><span class="n">mock_test_user</span><span class="p">,</span> <span class="n">mock_test_database</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;User Id=test_user; Location=test_db;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">def</span> <span class="nf">test_missing_user</span><span class="p">(</span><span class="n">mock_missing_default_user</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">create_connection_string</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
</section>
<section id="api">
<h2>API 参考<a class="headerlink" href="#api" title="Link to this heading">¶</a></h2>
<p><strong>API Reference</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p>查阅 <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch" title="pytest.MonkeyPatch"><code class="xref py py-class docutils literal notranslate"><span class="pre">MonkeyPatch</span></code></a> 类的文档。</p>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>Consult the docs for the <a class="reference internal" href="../reference/reference.html#pytest.MonkeyPatch" title="pytest.MonkeyPatch"><code class="xref py py-class docutils literal notranslate"><span class="pre">MonkeyPatch</span></code></a> class.</p>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="doctest.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">如何运行文档测试</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="tmp_path.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">如何在测试中使用临时目录和文件</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2015, holger krekel and pytest-dev team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">如何使用 猴子补丁/mock 模块和环境</a><ul>
<li><a class="reference internal" href="#id1">猴子补丁函数</a></li>
<li><a class="reference internal" href="#id2">猴子补丁返回对象: 构建mock类</a></li>
<li><a class="reference internal" href="#id3">全局补丁示例：阻止远程操作的“请求”</a></li>
<li><a class="reference internal" href="#id4">猴子补丁环境变量</a></li>
<li><a class="reference internal" href="#id5">猴子补丁参考</a></li>
<li><a class="reference internal" href="#api">API 参考</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=7c91f8fd"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>