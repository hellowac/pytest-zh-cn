<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../search.html" /><link rel="next" title="如何将 pytest 与现有测试套件结合使用" href="existingtestsuite.html" /><link rel="prev" title="编写插件" href="writing_plugins.html" />
        <link rel="canonical" href="https://docs.pytest.org/en/stable/how-to/writing_hook_functions.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>编写钩子函数 - pytest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments_pytest.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/pytest-custom.css?v=eb7c59a4" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">pytest documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/pytest1.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">入门</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">操作指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 操作指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="usage.html">如何调用 pytest</a></li>
<li class="toctree-l2"><a class="reference internal" href="assert.html">如何在测试中编写和报告断言</a></li>
<li class="toctree-l2"><a class="reference internal" href="fixtures.html">如何使用 fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="mark.html">如何用属性标记测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="parametrize.html">如何参数化fixtures和测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="tmp_path.html">如何在测试中使用临时目录和文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="monkeypatch.html">如何使用 猴子补丁/mock 模块和环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="doctest.html">如何运行文档测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="cache.html">如何重新运行失败的测试并在测试运行之间保持状态</a></li>
<li class="toctree-l2"><a class="reference internal" href="failures.html">如何处理测试失败</a></li>
<li class="toctree-l2"><a class="reference internal" href="output.html">管理 pytest 的输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">如何管理日志记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-stdout-stderr.html">如何捕获 stdout/stderr 输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-warnings.html">如何捕获警告</a></li>
<li class="toctree-l2"><a class="reference internal" href="skipping.html">如何使用 skip 和 xfail 处理无法成功的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">如何安装和使用插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_plugins.html">编写插件</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">编写钩子函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="existingtestsuite.html">如何将 pytest 与现有测试套件结合使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="unittest.html">如何在 pytest 中使用基于 unittest 的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="xunit_setup.html">如何实现 xunit 样式的设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="bash-completion.html">如何设置 bash 补全</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">参考指南</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 参考指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/reference.html">API 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/fixtures.html">Fixtures 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/customize.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/exit-codes.html">退出码</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/plugin_list.html">Pytest 插件列表</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../explanation/index.html">解答</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 解答</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanation/anatomy.html">测试剖析</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/fixtures.html">关于 fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/goodpractices.html">良好的集成实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/pythonpath.html">pytest 导入机制和 <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> / <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/ci.html">CI Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/flaky.html">不稳定的测试</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../example/index.html">示例和自定义技巧</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 示例和自定义技巧</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../example/reportingdemo.html">使用 pytest 的 Python 故障报告演示</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/simple.html">基本模式和示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/parametrize.html">参数化测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/markers.html">使用自定义标记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/special.html">可以查看所有收集到的测试的会话fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/pythoncollection.html">改变标准 (Python) 测试的发现机制</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/nonpython.html">使用非 Python 测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/customdirectory.html">使用自定义目录收集器</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">关于项目</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html">向后兼容政策</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#id2">历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#python">Python版本支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sponsor.html">赞助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tidelift.html">pytest 企业版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">许可</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">联系渠道</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">游泳的链接</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/pytest/">pytest @ PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/">pytest @ GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/issues">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://media.readthedocs.org/pdf/pytest/latest/pytest.pdf">PDF Documentation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="writinghooks">
<span id="id1"></span><h1>编写钩子函数<a class="headerlink" href="#writinghooks" title="Link to this heading">¶</a></h1>
<p><strong>Writing hook functions</strong></p>
<section id="validation">
<span id="id2"></span><h2>钩子函数验证和执行<a class="headerlink" href="#validation" title="Link to this heading">¶</a></h2>
<p><strong>hook function validation and execution</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>pytest 会根据给定的钩子规范调用注册插件中的钩子函数。让我们看看一个典型的钩子函数 <code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems(session,</span> <span class="pre">config,</span> <span class="pre">items)</span></code> ，pytest 会在所有测试项收集完成后调用它。</p>
<p>当我们在插件中实现 <code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems</span></code> 函数时，pytest 会在注册过程中验证您使用的参数名称是否与规范匹配，如果不匹配则会退出。</p>
<p>让我们看看一个可能的实现：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="c1"># 收集完成后调用</span>
    <span class="c1"># 您可以修改 ``items`` 列表</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>在这里， <code class="docutils literal notranslate"><span class="pre">pytest</span></code> 会传入 <code class="docutils literal notranslate"><span class="pre">config</span></code> （pytest 配置对象）和 <code class="docutils literal notranslate"><span class="pre">items</span></code> （收集到的测试项列表），但不会传入 <code class="docutils literal notranslate"><span class="pre">session</span></code> 参数，因为我们没有在函数签名中列出它。这种动态的“修剪”参数的方式使得 <code class="docutils literal notranslate"><span class="pre">pytest</span></code> 可以保持“未来兼容性”：我们可以引入新的钩子命名参数，而不会破坏现有钩子实现的签名。这是 pytest 插件具有长期兼容性的一大原因。</p>
<p>请注意，除了 <code class="docutils literal notranslate"><span class="pre">pytest_runtest_*</span></code> 以外的钩子函数不允许抛出异常。这样做将会中断 pytest 的运行。</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>pytest calls hook functions from registered plugins for any
given hook specification.  Let’s look at a typical hook function
for the <code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems(session,</span> <span class="pre">config,</span>
<span class="pre">items)</span></code> hook which pytest calls after collection of all test items is
completed.</p>
<p>When we implement a <code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems</span></code> function in our plugin
pytest will during registration verify that you use argument
names which match the specification and bail out if not.</p>
<p>Let’s look at a possible implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="c1"># called after collection is completed</span>
    <span class="c1"># you can modify the ``items`` list</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">pytest</span></code> will pass in <code class="docutils literal notranslate"><span class="pre">config</span></code> (the pytest config object)
and <code class="docutils literal notranslate"><span class="pre">items</span></code> (the list of collected test items) but will not pass
in the <code class="docutils literal notranslate"><span class="pre">session</span></code> argument because we didn’t list it in the function
signature.  This dynamic “pruning” of arguments allows <code class="docutils literal notranslate"><span class="pre">pytest</span></code> to
be “future-compatible”: we can introduce new hook named parameters without
breaking the signatures of existing hook implementations.  It is one of
the reasons for the general long-lived compatibility of pytest plugins.</p>
<p>Note that hook functions other than <code class="docutils literal notranslate"><span class="pre">pytest_runtest_*</span></code> are not
allowed to raise exceptions.  Doing so will break the pytest run.</p>
</div></div>
</section>
<section id="firstresult-none">
<span id="firstresult"></span><h2>firstresult: 在第一个非 None 结果处停止<a class="headerlink" href="#firstresult-none" title="Link to this heading">¶</a></h2>
<p><strong>firstresult: stop at first non-None result</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>对 <code class="docutils literal notranslate"><span class="pre">pytest</span></code> 钩子的绝大多数调用会返回一个 <strong>结果列表</strong>，该列表包含所有被调用的钩子函数的非 None 结果。</p>
<p>一些钩子规范使用了 <code class="docutils literal notranslate"><span class="pre">firstresult=True</span></code> 选项，这样钩子调用只会执行到 N 个注册函数中第一个返回非 None 结果的函数，此结果将被视为整体钩子调用的结果。在这种情况下，剩余的钩子函数将不会被调用。</p>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>Most calls to <code class="docutils literal notranslate"><span class="pre">pytest</span></code> hooks result in a <strong>list of results</strong> which contains
all non-None results of the called hook functions.</p>
<p>Some hook specifications use the <code class="docutils literal notranslate"><span class="pre">firstresult=True</span></code> option so that the hook
call only executes until the first of N registered functions returns a
non-None result which is then taken as result of the overall hook call.
The remaining hook functions will not be called in this case.</p>
</div></div>
</section>
<section id="hookwrapper">
<span id="id3"></span><h2>钩子包装器：围绕其他钩子执行<a class="headerlink" href="#hookwrapper" title="Link to this heading">¶</a></h2>
<p><strong>hook wrappers: executing around other hooks</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>pytest 插件可以实现钩子包装器，这些包装器包裹其他钩子实现的执行。钩子包装器是一个生成器函数，它会精确地产生一次。当 pytest 调用钩子时，它会首先执行钩子包装器，并将与常规钩子相同的参数传递给它们。</p>
<p>在钩子包装器的 yield 点，pytest 会执行下一个钩子实现并将它们的结果返回到 yield 点，或者如果它们引发了异常，则传播该异常。</p>
<p>以下是钩子包装器的示例定义：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="p">):</span>
    <span class="n">do_something_before_next_hook_executes</span><span class="p">()</span>

    <span class="c1"># 如果结果是异常，将引发该异常。</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span>

    <span class="n">new_res</span> <span class="o">=</span> <span class="n">post_process_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># 将返回值覆盖到插件系统。</span>
    <span class="k">return</span> <span class="n">new_res</span>
</pre></div>
</div>
<p>钩子包装器需要返回钩子的结果，或者引发异常。</p>
<p>在许多情况下，包装器只需要在实际的钩子实现周围执行跟踪或其他副作用，在这种情况下，它可以返回 <code class="docutils literal notranslate"><span class="pre">yield</span></code> 的结果值。最简单（尽管无用）的钩子包装器是 <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">(yield)</span></code>。</p>
<p>在其他情况下，包装器希望调整或适应结果，在这种情况下它可以返回一个新值。如果底层钩子的结果是一个可变对象，包装器可以修改该结果，但最好避免这样做。</p>
<p>如果钩子实现由于异常而失败，包装器可以使用 <code class="docutils literal notranslate"><span class="pre">try-catch-finally</span></code> 包裹 <code class="docutils literal notranslate"><span class="pre">yield</span></code> 来处理该异常，可以选择传播它、抑制它，或者引发一个完全不同的异常。</p>
<p>有关更多信息，请参阅 <a class="reference external" href="https://pluggy.readthedocs.io/en/stable/index.html#hookwrappers" title="(in pluggy v0.1)"><span class="xref std std-ref">pluggy 文档中的钩子包装器</span></a>。</p>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>pytest plugins can implement hook wrappers which wrap the execution
of other hook implementations.  A hook wrapper is a generator function
which yields exactly once. When pytest invokes hooks it first executes
hook wrappers and passes the same arguments as to the regular hooks.</p>
<p>At the yield point of the hook wrapper pytest will execute the next hook
implementations and return their result to the yield point, or will
propagate an exception if they raised.</p>
<p>Here is an example definition of a hook wrapper:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="p">):</span>
    <span class="n">do_something_before_next_hook_executes</span><span class="p">()</span>

    <span class="c1"># If the outcome is an exception, will raise the exception.</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span>

    <span class="n">new_res</span> <span class="o">=</span> <span class="n">post_process_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># Override the return value to the plugin system.</span>
    <span class="k">return</span> <span class="n">new_res</span>
</pre></div>
</div>
<p>The hook wrapper needs to return a result for the hook, or raise an exception.</p>
<p>In many cases, the wrapper only needs to perform tracing or other side effects
around the actual hook implementations, in which case it can return the result
value of the <code class="docutils literal notranslate"><span class="pre">yield</span></code>. The simplest (though useless) hook wrapper is
<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">(yield)</span></code>.</p>
<p>In other cases, the wrapper wants the adjust or adapt the result, in which case
it can return a new value. If the result of the underlying hook is a mutable
object, the wrapper may modify that result, but it’s probably better to avoid it.</p>
<p>If the hook implementation failed with an exception, the wrapper can handle that
exception using a <code class="docutils literal notranslate"><span class="pre">try-catch-finally</span></code> around the <code class="docutils literal notranslate"><span class="pre">yield</span></code>, by propagating it,
suppressing it, or raising a different exception entirely.</p>
<p>For more information, consult the
<a class="reference external" href="https://pluggy.readthedocs.io/en/stable/index.html#hookwrappers" title="(in pluggy v0.1)"><span class="xref std std-ref">pluggy documentation about hook wrappers</span></a>.</p>
</div></div>
</section>
<section id="plugin-hookorder">
<span id="id4"></span><h2>钩子函数排序/调用示例<a class="headerlink" href="#plugin-hookorder" title="Link to this heading">¶</a></h2>
<p><strong>Hook function ordering / call example</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>对于任何给定的钩子规范，可能有多个实现，因此我们通常将 <code class="docutils literal notranslate"><span class="pre">hook</span></code> 执行视为 <code class="docutils literal notranslate"><span class="pre">1:N</span></code> 函数调用，其中 <code class="docutils literal notranslate"><span class="pre">N</span></code> 是注册函数的数量。有多种方法可以影响钩子实现的执行顺序，即在 <code class="docutils literal notranslate"><span class="pre">N</span></code> 大小的函数列表中的位置：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 插件 1</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># 尽可能早地执行</span>
    <span class="o">...</span>


<span class="c1"># 插件 2</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># 尽可能晚地执行</span>
    <span class="o">...</span>


<span class="c1"># 插件 3</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># 甚至会在上面的 tryfirst 之前执行！</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># 在所有非包装器执行后执行</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>以下是执行顺序：</p>
<ol class="arabic simple">
<li><p>插件 3 的 pytest_collection_modifyitems 被调用直到 yield 点，因为它是一个钩子包装器。</p></li>
<li><p>插件 1 的 pytest_collection_modifyitems 被调用，因为它被标记为 <code class="docutils literal notranslate"><span class="pre">tryfirst=True</span></code>。</p></li>
<li><p>插件 2 的 pytest_collection_modifyitems 被调用，因为它被标记为 <code class="docutils literal notranslate"><span class="pre">trylast=True</span></code> （即使没有这个标记，它也会在插件 1 之后执行）。</p></li>
<li><p>插件 3 的 pytest_collection_modifyitems 然后执行 yield 点后的代码。yield 接收来自调用非包装器的结果，或者如果非包装器引发异常，则引发该异常。</p></li>
</ol>
<p>也可以在钩子包装器上使用 <code class="docutils literal notranslate"><span class="pre">tryfirst</span></code> 和 <code class="docutils literal notranslate"><span class="pre">trylast</span></code>，在这种情况下，它将影响钩子包装器之间的排序。</p>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>For any given hook specification there may be more than one
implementation and we thus generally view <code class="docutils literal notranslate"><span class="pre">hook</span></code> execution as a
<code class="docutils literal notranslate"><span class="pre">1:N</span></code> function call where <code class="docutils literal notranslate"><span class="pre">N</span></code> is the number of registered functions.
There are ways to influence if a hook implementation comes before or
after others, i.e.  the position in the <code class="docutils literal notranslate"><span class="pre">N</span></code>-sized list of functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plugin 1</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># will execute as early as possible</span>
    <span class="o">...</span>


<span class="c1"># Plugin 2</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># will execute as late as possible</span>
    <span class="o">...</span>


<span class="c1"># Plugin 3</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># will execute even before the tryfirst one above!</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># will execute after all non-wrappers executed</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Here is the order of execution:</p>
<p>1. Plugin3’s pytest_collection_modifyitems called until the yield point
because it is a hook wrapper.</p>
<p>2. Plugin1’s pytest_collection_modifyitems is called because it is marked
with <code class="docutils literal notranslate"><span class="pre">tryfirst=True</span></code>.</p>
<p>3. Plugin2’s pytest_collection_modifyitems is called because it is marked
with <code class="docutils literal notranslate"><span class="pre">trylast=True</span></code> (but even without this mark it would come after
Plugin1).</p>
<p>4. Plugin3’s pytest_collection_modifyitems then executing the code after the yield
point.  The yield receives the result from calling the non-wrappers, or raises
an exception if the non-wrappers raised.</p>
<p>It’s possible to use <code class="docutils literal notranslate"><span class="pre">tryfirst</span></code> and <code class="docutils literal notranslate"><span class="pre">trylast</span></code> also on hook wrappers
in which case it will influence the ordering of hook wrappers among each other.</p>
</div></div>
</section>
<section id="declaringhooks">
<span id="id5"></span><h2>声明新钩子<a class="headerlink" href="#declaringhooks" title="Link to this heading">¶</a></h2>
<p><strong>Declaring new hooks</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><div class="admonition note">
<p class="admonition-title">Note</p>
<p>这是关于如何添加新钩子以及它们一般工作原理的快速概述，但更完整的概述可以在 <a class="reference external" href="https://pluggy.readthedocs.io/en/latest/">pluggy 文档</a> 中找到。</p>
</div>
<p>插件和 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件可以声明新的钩子，这些钩子可以由其他插件实现，以改变行为或与新插件交互：</p>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">pytest_addhooks</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pluginmanager</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/_pytest/hookspec.html#pytest_addhooks"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Called at plugin registration time to allow adding new hooks via a call to
<a class="reference internal" href="../reference/reference.html#pytest.PytestPluginManager.add_hookspecs" title="pytest.PytestPluginManager.add_hookspecs"><code class="xref py py-func docutils literal notranslate"><span class="pre">pluginmanager.add_hookspecs(module_or_class,</span> <span class="pre">prefix)</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>pluginmanager</strong> (<a class="reference internal" href="../reference/reference.html#pytest.PytestPluginManager" title="pytest.PytestPluginManager"><em>PytestPluginManager</em></a>) – The pytest plugin manager.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This hook is incompatible with hook wrappers.</p>
</div>
<section id="use-in-conftest-plugins">
<h3>Use in conftest plugins<a class="headerlink" href="#use-in-conftest-plugins" title="Link to this heading">¶</a></h3>
<p>If a conftest plugin implements this hook, it will be called immediately
when the conftest is registered.</p>
</section>
</dd></dl>

<p>钩子通常声明为不执行任何操作的函数，仅包含文档描述钩子何时被调用以及预期返回值是什么。函数的名称必须以 <code class="docutils literal notranslate"><span class="pre">pytest_</span></code> 开头，否则 pytest 将无法识别它们。</p>
<p>以下是一个示例。假设此代码位于 <code class="docutils literal notranslate"><span class="pre">sample_hook.py</span></code> 模块中。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_my_hook</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    接收 pytest 配置并对其进行处理</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>要将钩子注册到 pytest，它们需要在自己的模块或类中进行结构化。然后可以使用 <code class="docutils literal notranslate"><span class="pre">pytest_addhooks</span></code> 函数（它本身是 pytest 暴露的钩子）将此类或模块传递给 <code class="docutils literal notranslate"><span class="pre">pluginmanager</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_addhooks</span><span class="p">(</span><span class="n">pluginmanager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;这个示例假设钩子被分组在 &#39;sample_hook&#39; 模块中。&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">my_app.tests</span> <span class="kn">import</span> <span class="n">sample_hook</span>

    <span class="n">pluginmanager</span><span class="o">.</span><span class="n">add_hookspecs</span><span class="p">(</span><span class="n">sample_hook</span><span class="p">)</span>
</pre></div>
</div>
<p>有关现实世界示例，请参见来自 <a class="reference external" href="https://github.com/pytest-dev/pytest-xdist">xdist</a> 的 <a class="reference external" href="https://github.com/pytest-dev/pytest-xdist/blob/974bd566c599dc6a9ea291838c6f226197208b46/xdist/newhooks.py">newhooks.py</a>。</p>
<p>钩子可以从夹具或其他钩子中调用。在这两种情况下，钩子都是通过 <code class="docutils literal notranslate"><span class="pre">config</span></code> 对象中可用的 <code class="docutils literal notranslate"><span class="pre">hook</span></code> 对象调用的。大多数钩子直接接收 <code class="docutils literal notranslate"><span class="pre">config</span></code> 对象，而夹具可以使用提供相同对象的 <code class="docutils literal notranslate"><span class="pre">pytestconfig</span></code> 夹具。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_fixture</span><span class="p">(</span><span class="n">pytestconfig</span><span class="p">):</span>
    <span class="c1"># 调用名为 &quot;pytest_my_hook&quot; 的钩子</span>
    <span class="c1"># &#39;result&#39; 将是所有注册函数的返回值列表。</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pytestconfig</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_my_hook</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">pytestconfig</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>钩子仅使用关键字参数接收参数。</p>
</div>
<p>现在您的钩子已准备好使用。要在钩子处注册函数，其他插件或用户现在只需在其 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 中定义具有正确签名的函数 <code class="docutils literal notranslate"><span class="pre">pytest_my_hook</span></code>。</p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_my_hook</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    将所有活动钩子打印到屏幕上。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hook</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a quick overview on how to add new hooks and how they work in general, but a more complete
overview can be found in <a class="reference external" href="https://pluggy.readthedocs.io/en/latest/">the pluggy documentation</a>.</p>
</div>
<p>Plugins and <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> files may declare new hooks that can then be
implemented by other plugins in order to alter behaviour or interact with
the new plugin:</p>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">pytest_addhooks</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pluginmanager</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/_pytest/hookspec.html#pytest_addhooks"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Called at plugin registration time to allow adding new hooks via a call to
<a class="reference internal" href="../reference/reference.html#pytest.PytestPluginManager.add_hookspecs" title="pytest.PytestPluginManager.add_hookspecs"><code class="xref py py-func docutils literal notranslate"><span class="pre">pluginmanager.add_hookspecs(module_or_class,</span> <span class="pre">prefix)</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>pluginmanager</strong> (<a class="reference internal" href="../reference/reference.html#pytest.PytestPluginManager" title="pytest.PytestPluginManager"><em>PytestPluginManager</em></a>) – The pytest plugin manager.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This hook is incompatible with hook wrappers.</p>
</div>
<section id="id6">
<h3>Use in conftest plugins<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<p>If a conftest plugin implements this hook, it will be called immediately
when the conftest is registered.</p>
</section>
</dd></dl>

<p>Hooks are usually declared as do-nothing functions that contain only
documentation describing when the hook will be called and what return values
are expected. The names of the functions must start with <code class="docutils literal notranslate"><span class="pre">pytest_</span></code> otherwise pytest won’t recognize them.</p>
<p>Here’s an example. Let’s assume this code is in the <code class="docutils literal notranslate"><span class="pre">sample_hook.py</span></code> module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_my_hook</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receives the pytest config and does things with it</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>To register the hooks with pytest they need to be structured in their own module or class. This
class or module can then be passed to the <code class="docutils literal notranslate"><span class="pre">pluginmanager</span></code> using the <code class="docutils literal notranslate"><span class="pre">pytest_addhooks</span></code> function
(which itself is a hook exposed by pytest).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_addhooks</span><span class="p">(</span><span class="n">pluginmanager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This example assumes the hooks are grouped in the &#39;sample_hook&#39; module.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">my_app.tests</span> <span class="kn">import</span> <span class="n">sample_hook</span>

    <span class="n">pluginmanager</span><span class="o">.</span><span class="n">add_hookspecs</span><span class="p">(</span><span class="n">sample_hook</span><span class="p">)</span>
</pre></div>
</div>
<p>For a real world example, see <a class="reference external" href="https://github.com/pytest-dev/pytest-xdist/blob/974bd566c599dc6a9ea291838c6f226197208b46/xdist/newhooks.py">newhooks.py</a> from <a class="reference external" href="https://github.com/pytest-dev/pytest-xdist">xdist</a>.</p>
<p>Hooks may be called both from fixtures or from other hooks. In both cases, hooks are called
through the <code class="docutils literal notranslate"><span class="pre">hook</span></code> object, available in the <code class="docutils literal notranslate"><span class="pre">config</span></code> object. Most hooks receive a
<code class="docutils literal notranslate"><span class="pre">config</span></code> object directly, while fixtures may use the <code class="docutils literal notranslate"><span class="pre">pytestconfig</span></code> fixture which provides the same object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_fixture</span><span class="p">(</span><span class="n">pytestconfig</span><span class="p">):</span>
    <span class="c1"># call the hook called &quot;pytest_my_hook&quot;</span>
    <span class="c1"># &#39;result&#39; will be a list of return values from all registered functions.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pytestconfig</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_my_hook</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">pytestconfig</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Hooks receive parameters using only keyword arguments.</p>
</div>
<p>Now your hook is ready to be used. To register a function at the hook, other plugins or users must
now simply define the function <code class="docutils literal notranslate"><span class="pre">pytest_my_hook</span></code> with the correct signature in their <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_my_hook</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print all active hooks to the screen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hook</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="pytest-addoption">
<span id="addoptionhooks"></span><h2>在 pytest_addoption 中使用钩子<a class="headerlink" href="#pytest-addoption" title="Link to this heading">¶</a></h2>
<p><strong>Using hooks in pytest_addoption</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>偶尔，需要根据另一个插件中的钩子更改一个插件定义命令行选项的方式。例如，一个插件可能会暴露一个命令行选项，而另一个插件需要为该选项定义默认值。可以使用 pluginmanager 来安装和使用钩子来实现这一点。插件将定义和添加钩子，并使用 pytest_addoption，如下所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># hooks.py 的内容</span>


<span class="c1"># 使用 firstresult=True，因为我们只希望一个插件定义这个</span>
<span class="c1"># 默认值</span>
<span class="nd">@hookspec</span><span class="p">(</span><span class="n">firstresult</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_config_file_default_value</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;返回配置文件命令行选项的默认值.&quot;&quot;&quot;</span>


<span class="c1"># myplugin.py 的内容</span>


<span class="k">def</span> <span class="nf">pytest_addhooks</span><span class="p">(</span><span class="n">pluginmanager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;这个示例假设钩子被分组在 &#39;hooks&#39; 模块中。&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">hooks</span>

    <span class="n">pluginmanager</span><span class="o">.</span><span class="n">add_hookspecs</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">pluginmanager</span><span class="p">):</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="n">pluginmanager</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_config_file_default_value</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--config-file&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;要使用的配置文件，默认值为 </span><span class="si">%(default)s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_value</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>使用 myplugin 的 conftest.py 只需简单地定义钩子，如下所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_config_file_default_value</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;config.yaml&quot;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>Occasionally, it is necessary to change the way in which command line options
are defined by one plugin based on hooks in another plugin. For example,
a plugin may expose a command line option for which another plugin needs
to define the default value. The pluginmanager can be used to install and
use hooks to accomplish this. The plugin would define and add the hooks
and use pytest_addoption as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<p># contents of hooks.py</p>
<p># Use firstresult=True because we only want one plugin to define this
# default value
&#64;hookspec(firstresult=True)
def pytest_config_file_default_value():</p>
<blockquote>
<div><p>“””Return the default value for the config file command line option.”””</p>
</div></blockquote>
<p># contents of myplugin.py</p>
<dl>
<dt>def pytest_addhooks(pluginmanager):</dt><dd><p>“””This example assumes the hooks are grouped in the ‘hooks’ module.”””
from . import hooks</p>
<p>pluginmanager.add_hookspecs(hooks)</p>
</dd>
<dt>def pytest_addoption(parser, pluginmanager):</dt><dd><p>default_value = pluginmanager.hook.pytest_config_file_default_value()
parser.addoption(</p>
<blockquote>
<div><p>“–config-file”,
help=”Config file to use, defaults to %(default)s”,
default=default_value,</p>
</div></blockquote>
<p>)</p>
</dd>
</dl>
<p>The conftest.py that is using myplugin would simply define the hook as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_config_file_default_value</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;config.yaml&quot;</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id9">
<h2>可选择使用来自第三方插件的钩子<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h2>
<p><strong>Optionally using hooks from 3rd party plugins</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p>如上所述，使用插件的新钩子可能会有点棘手，因为标准的 <a class="reference internal" href="#validation"><span class="std std-ref">验证机制</span></a>：如果您依赖于未安装的插件，验证将失败，错误消息对您的用户来说并没有多大意义。</p>
<p>一种方法是将钩子实现推迟到一个新插件，而不是直接在您的插件模块中声明钩子函数，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># myplugin.py 的内容</span>


<span class="k">class</span> <span class="nc">DeferPlugin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;简单插件，用于推迟 pytest-xdist 钩子函数。&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">pytest_testnodedown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;标准 xdist 钩子函数。&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">hasplugin</span><span class="p">(</span><span class="s2">&quot;xdist&quot;</span><span class="p">):</span>
        <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">DeferPlugin</span><span class="p">())</span>
</pre></div>
</div>
<p>这样做的额外好处是允许您根据安装的插件有条件地安装钩子。</p>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>Using new hooks from plugins as explained above might be a little tricky
because of the standard <a class="reference internal" href="#validation"><span class="std std-ref">validation mechanism</span></a>:
if you depend on a plugin that is not installed, validation will fail and
the error message will not make much sense to your users.</p>
<p>One approach is to defer the hook implementation to a new plugin instead of
declaring the hook functions directly in your plugin module, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of myplugin.py</span>


<span class="k">class</span> <span class="nc">DeferPlugin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple plugin to defer pytest-xdist hook functions.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">pytest_testnodedown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;standard xdist hook function.&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">hasplugin</span><span class="p">(</span><span class="s2">&quot;xdist&quot;</span><span class="p">):</span>
        <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">DeferPlugin</span><span class="p">())</span>
</pre></div>
</div>
<p>This has the added benefit of allowing you to conditionally install hooks
depending on which plugins are installed.</p>
</div></div>
</section>
<section id="plugin-stash">
<span id="id10"></span><h2>跨钩子函数存储项目数据<a class="headerlink" href="#plugin-stash" title="Link to this heading">¶</a></h2>
<p><strong>Storing data on items across hook functions</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><p>插件通常需要在一个钩子实现中存储有关 <a class="reference internal" href="../reference/reference.html#pytest.Item" title="pytest.Item"><code class="xref py py-class docutils literal notranslate"><span class="pre">Item</span></code></a> 的数据，并在另一个钩子实现中访问这些数据。一种常见的解决方案是直接在项上分配某个私有属性，但类型检查器如 mypy 对此表示反对，这也可能导致与其他插件的冲突。因此，pytest 提供了一种更好的方法来实现这个功能，即 <a class="reference internal" href="../reference/reference.html#pytest.nodes.Node.stash" title="_pytest.nodes.Node.stash"><code class="xref py py-attr docutils literal notranslate"><span class="pre">item.stash</span></code></a> 。</p>
<p>要在您的插件中使用“stash”，首先在插件的顶层创建“stash keys”：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">been_there_key</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">StashKey</span><span class="p">[</span><span class="nb">bool</span><span class="p">]()</span>
<span class="n">done_that_key</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">StashKey</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
</pre></div>
</div>
<p>然后在某个时刻使用这些键来存储您的数据：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_runtest_setup</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">pytest</span><span class="o">.</span><span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">been_there_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">done_that_key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
</pre></div>
</div>
<p>在另一个时刻检索它们：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_runtest_teardown</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">pytest</span><span class="o">.</span><span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">been_there_key</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;哦？&quot;</span><span class="p">)</span>
    <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">done_that_key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yes!&quot;</span>
</pre></div>
</div>
<p>如果需要，所有节点类型（如 <a class="reference internal" href="../reference/reference.html#pytest.Class" title="pytest.Class"><code class="xref py py-class docutils literal notranslate"><span class="pre">Class</span></code></a> 、<a class="reference internal" href="../reference/reference.html#pytest.Session" title="pytest.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>）以及 <a class="reference internal" href="../reference/reference.html#pytest.Config" title="pytest.Config"><code class="xref py py-class docutils literal notranslate"><span class="pre">Config</span></code></a> 上都可以使用 stash。</p>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><p>Plugins often need to store data on <a class="reference internal" href="../reference/reference.html#pytest.Item" title="pytest.Item"><code class="xref py py-class docutils literal notranslate"><span class="pre">Item</span></code></a>s in one hook
implementation, and access it in another. One common solution is to just
assign some private attribute directly on the item, but type-checkers like
mypy frown upon this, and it may also cause conflicts with other plugins.
So pytest offers a better way to do this, <a class="reference internal" href="../reference/reference.html#pytest.nodes.Node.stash" title="_pytest.nodes.Node.stash"><code class="xref py py-attr docutils literal notranslate"><span class="pre">item.stash</span></code></a>.</p>
<p>To use the “stash” in your plugins, first create “stash keys” somewhere at the
top level of your plugin:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">been_there_key</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">StashKey</span><span class="p">[</span><span class="nb">bool</span><span class="p">]()</span>
<span class="n">done_that_key</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">StashKey</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
</pre></div>
</div>
<p>then use the keys to stash your data at some point:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_runtest_setup</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">pytest</span><span class="o">.</span><span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">been_there_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">done_that_key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
</pre></div>
</div>
<p>and retrieve them at another point:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_runtest_teardown</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">pytest</span><span class="o">.</span><span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">been_there_key</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Oh?&quot;</span><span class="p">)</span>
    <span class="n">item</span><span class="o">.</span><span class="n">stash</span><span class="p">[</span><span class="n">done_that_key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yes!&quot;</span>
</pre></div>
</div>
<p>Stashes are available on all node types (like <a class="reference internal" href="../reference/reference.html#pytest.Class" title="pytest.Class"><code class="xref py py-class docutils literal notranslate"><span class="pre">Class</span></code></a>,
<a class="reference internal" href="../reference/reference.html#pytest.Session" title="pytest.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>) and also on <a class="reference internal" href="../reference/reference.html#pytest.Config" title="pytest.Config"><code class="xref py py-class docutils literal notranslate"><span class="pre">Config</span></code></a>, if needed.</p>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="existingtestsuite.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">如何将 pytest 与现有测试套件结合使用</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="writing_plugins.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">编写插件</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2015, holger krekel and pytest-dev team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">编写钩子函数</a><ul>
<li><a class="reference internal" href="#validation">钩子函数验证和执行</a></li>
<li><a class="reference internal" href="#firstresult-none">firstresult: 在第一个非 None 结果处停止</a></li>
<li><a class="reference internal" href="#hookwrapper">钩子包装器：围绕其他钩子执行</a></li>
<li><a class="reference internal" href="#plugin-hookorder">钩子函数排序/调用示例</a></li>
<li><a class="reference internal" href="#declaringhooks">声明新钩子</a></li>
<li><a class="reference internal" href="#pytest-addoption">在 pytest_addoption 中使用钩子</a></li>
<li><a class="reference internal" href="#id9">可选择使用来自第三方插件的钩子</a></li>
<li><a class="reference internal" href="#plugin-stash">跨钩子函数存储项目数据</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=7c91f8fd"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>