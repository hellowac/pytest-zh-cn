<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../search.html" /><link rel="next" title="配置" href="customize.html" /><link rel="prev" title="API 参考" href="reference.html" />
        <link rel="canonical" href="https://docs.pytest.org/en/stable/reference/fixtures.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Fixtures 参考 - pytest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments_pytest.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/pytest-custom.css?v=eb7c59a4" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">pytest documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/pytest1.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">入门</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../how-to/index.html">操作指南</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 操作指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../how-to/usage.html">如何调用 pytest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/assert.html">如何在测试中编写和报告断言</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/fixtures.html">如何使用 fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/mark.html">如何用属性标记测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/parametrize.html">如何参数化fixtures和测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/tmp_path.html">如何在测试中使用临时目录和文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/monkeypatch.html">如何使用 猴子补丁/mock 模块和环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/doctest.html">如何运行文档测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/cache.html">如何重新运行失败的测试并在测试运行之间保持状态</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/failures.html">如何处理测试失败</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/output.html">管理 pytest 的输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/logging.html">如何管理日志记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/capture-stdout-stderr.html">如何捕获 stdout/stderr 输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/capture-warnings.html">如何捕获警告</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/skipping.html">如何使用 skip 和 xfail 处理无法成功的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/plugins.html">如何安装和使用插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/writing_plugins.html">编写插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/writing_hook_functions.html">编写钩子函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/existingtestsuite.html">如何将 pytest 与现有测试套件结合使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/unittest.html">如何在 pytest 中使用基于 unittest 的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/xunit_setup.html">如何实现 xunit 样式的设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/bash-completion.html">如何设置 bash 补全</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">参考指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 参考指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="reference.html">API 参考</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Fixtures 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="customize.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="exit-codes.html">退出码</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin_list.html">Pytest 插件列表</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../explanation/index.html">解答</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 解答</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanation/anatomy.html">测试剖析</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/fixtures.html">关于 fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/goodpractices.html">良好的集成实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/pythonpath.html">pytest 导入机制和 <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> / <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/ci.html">CI Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/flaky.html">不稳定的测试</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../example/index.html">示例和自定义技巧</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 示例和自定义技巧</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../example/reportingdemo.html">使用 pytest 的 Python 故障报告演示</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/simple.html">基本模式和示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/parametrize.html">参数化测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/markers.html">使用自定义标记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/special.html">可以查看所有收集到的测试的会话fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/pythoncollection.html">改变标准 (Python) 测试的发现机制</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/nonpython.html">使用非 Python 测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example/customdirectory.html">使用自定义目录收集器</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">关于项目</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html">向后兼容政策</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#id2">历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backwards-compatibility.html#python">Python版本支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sponsor.html">赞助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tidelift.html">pytest 企业版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">许可</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">联系渠道</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">游泳的链接</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/pytest/">pytest @ PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/">pytest @ GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/issues">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://media.readthedocs.org/pdf/pytest/latest/pytest.pdf">PDF Documentation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="id1">
<span id="pytest-fixture"></span><span id="fixtures"></span><span id="fixture"></span><span id="reference-fixtures"></span><span id="id2"></span><h1>Fixtures 参考<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p><strong>Fixtures reference</strong></p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../explanation/fixtures.html#about-fixtures"><span class="std std-ref">关于 fixtures</span></a></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../how-to/fixtures.html#how-to-fixtures"><span class="std std-ref">如何使用 fixture</span></a></p>
</div>
<section id="id3">
<h2>内置 fixtures<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Built-in fixtures</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p><a class="reference internal" href="reference.html#fixtures-api"><span class="std std-ref">Fixtures</span></a> 使用 <a class="reference internal" href="reference.html#pytest-fixture-api"><span class="std std-ref">&#64;pytest.fixture</span></a> 装饰器定义。Pytest 有几个有用的内置 fixtures ：</p>
<dl class="simple">
<dt><a class="reference internal" href="reference.html#std-fixture-capfd"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capfd</span></code></a></dt><dd><p>捕获文件描述符 <code class="docutils literal notranslate"><span class="pre">1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">2</span></code> 的文本输出。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-capfdbinary"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capfdbinary</span></code></a></dt><dd><p>捕获文件描述符 <code class="docutils literal notranslate"><span class="pre">1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">2</span></code> 的字节输出。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-caplog"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">caplog</span></code></a></dt><dd><p>控制日志记录并访问日志条目。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-capsys"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capsys</span></code></a></dt><dd><p>捕获 <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> 的文本输出。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-capsysbinary"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capsysbinary</span></code></a></dt><dd><p>捕获 <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> 的字节输出。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-cache"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">cache</span></code></a></dt><dd><p>在 pytest 运行之间存储和检索值。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-0"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">doctest_namespace</span></code></a></dt><dd><p>提供注入到 doctests 命名空间的字典。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-monkeypatch"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">monkeypatch</span></code></a></dt><dd><p>临时修改类、函数、字典、
<code class="docutils literal notranslate"><span class="pre">os.environ</span></code> 和其他对象。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-pytestconfig"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">pytestconfig</span></code></a></dt><dd><p>访问配置值、插件管理器和插件钩子。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-1"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">record_property</span></code></a></dt><dd><p>向测试添加额外属性。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-record_testsuite_property"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">record_testsuite_property</span></code></a></dt><dd><p>向测试套件添加额外属性。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-recwarn"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">recwarn</span></code></a></dt><dd><p>记录测试函数发出的警告。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-request"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">request</span></code></a></dt><dd><p>提供正在执行的测试函数的信息。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-2"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">testdir</span></code></a></dt><dd><p>提供一个临时测试目录，以帮助运行和
测试 pytest 插件。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-3"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path</span></code></a></dt><dd><p>提供一个 <a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a> 对象，指向一个临时目录
该目录对每个测试函数都是唯一的。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-tmp_path_factory"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path_factory</span></code></a></dt><dd><p>创建会话范围的临时目录并返回
<a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a> 对象。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-tmpdir"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmpdir</span></code></a></dt><dd><p>提供一个 <a class="reference external" href="https://py.readthedocs.io/en/latest/path.html">py.path.local</a> 对象，指向一个临时
目录，该目录对每个测试函数都是唯一的；
被 <a class="reference internal" href="reference.html#std:fixture-3"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path</span></code></a> 替代。</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-tmpdir_factory"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmpdir_factory</span></code></a></dt><dd><p>创建会话范围的临时目录并返回
<code class="docutils literal notranslate"><span class="pre">py.path.local</span></code> 对象；
被 <a class="reference internal" href="reference.html#std-fixture-tmp_path_factory"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path_factory</span></code></a> 替代。</p>
</dd>
</dl>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p><a class="reference internal" href="reference.html#fixtures-api"><span class="std std-ref">Fixtures</span></a> are defined using the <a class="reference internal" href="reference.html#pytest-fixture-api"><span class="std std-ref">&#64;pytest.fixture</span></a> decorator. Pytest has several useful built-in fixtures:</p>
<blockquote>
<div><dl class="simple">
<dt><a class="reference internal" href="reference.html#std-fixture-capfd"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capfd</span></code></a></dt><dd><p>Capture, as text, output to file descriptors <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-capfdbinary"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capfdbinary</span></code></a></dt><dd><p>Capture, as bytes, output to file descriptors <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-caplog"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">caplog</span></code></a></dt><dd><p>Control logging and access log entries.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-capsys"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capsys</span></code></a></dt><dd><p>Capture, as text, output to <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code>.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-capsysbinary"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">capsysbinary</span></code></a></dt><dd><p>Capture, as bytes, output to <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code>.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-cache"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">cache</span></code></a></dt><dd><p>Store and retrieve values across pytest runs.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-0"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">doctest_namespace</span></code></a></dt><dd><p>Provide a dict injected into the doctests namespace.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-monkeypatch"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">monkeypatch</span></code></a></dt><dd><p>Temporarily modify classes, functions, dictionaries,
<code class="docutils literal notranslate"><span class="pre">os.environ</span></code>, and other objects.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-pytestconfig"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">pytestconfig</span></code></a></dt><dd><p>Access to configuration values, pluginmanager and plugin hooks.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-1"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">record_property</span></code></a></dt><dd><p>Add extra properties to the test.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-record_testsuite_property"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">record_testsuite_property</span></code></a></dt><dd><p>Add extra properties to the test suite.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-recwarn"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">recwarn</span></code></a></dt><dd><p>Record warnings emitted by test functions.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-request"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">request</span></code></a></dt><dd><p>Provide information on the executing test function.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-2"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">testdir</span></code></a></dt><dd><p>Provide a temporary test directory to aid in running, and
testing, pytest plugins.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std:fixture-3"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path</span></code></a></dt><dd><p>Provide a <a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a> object to a temporary directory
which is unique to each test function.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-tmp_path_factory"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path_factory</span></code></a></dt><dd><p>Make session-scoped temporary directories and return
<a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a> objects.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-tmpdir"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmpdir</span></code></a></dt><dd><p>Provide a <a class="reference external" href="https://py.readthedocs.io/en/latest/path.html">py.path.local</a> object to a temporary
directory which is unique to each test function;
replaced by <a class="reference internal" href="reference.html#std:fixture-3"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path</span></code></a>.</p>
</dd>
<dt><a class="reference internal" href="reference.html#std-fixture-tmpdir_factory"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmpdir_factory</span></code></a></dt><dd><p>Make session-scoped temporary directories and return
<code class="docutils literal notranslate"><span class="pre">py.path.local</span></code> objects;
replaced by <a class="reference internal" href="reference.html#std-fixture-tmp_path_factory"><code class="xref std std-fixture docutils literal notranslate"><span class="pre">tmp_path_factory</span></code></a>.</p>
</dd>
</dl>
</div></blockquote>
</div></div>
</section>
<section id="conftest">
<span id="conftest-py"></span><span id="id5"></span><h2>Fixture 可用性<a class="headerlink" href="#conftest" title="Link to this heading">¶</a></h2>
<p><strong>Fixture availability</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><blockquote>
<div><p>fixtures 的可用性是从测试的角度来决定的。只有在定义该 fixtures 的作用域内，测试才能请求一个 fixtures 。如果一个 fixtures 是在一个类内部定义的，它只能被该类中的测试请求。但如果一个 fixtures 是在模块的全局作用域内定义的，那么该模块中的每个测试，即使它是在一个类内部定义的，也可以请求这个 fixtures 。</p>
</div></blockquote>
<p>类似地，只有当测试在同一个作用域内时，它才能受到autouse fixtures 的影响（见 <a class="reference internal" href="#autouse-order"><span class="std std-ref">Autouse Fixture 在其范围内首先执行</span></a> ）。</p>
<p>一个 fixtures 也可以请求任何其他 fixtures ，无论它在哪里定义，只要请求它们的测试可以看到所有涉及的 fixtures 。</p>
<p>例如，这里有一个测试文件，其中一个 fixtures （ <code class="docutils literal notranslate"><span class="pre">outer</span></code> ）请求了一个在不同作用域内定义的 fixtures （ <code class="docutils literal notranslate"><span class="pre">inner</span></code> ）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">outer</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">inner</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestOne</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">outer</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;outer&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TestTwo</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;two&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">outer</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;outer&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>从测试的角度来看，它们没有问题看到每个它们依赖的 fixtures ：</p>
<blockquote>
<div><img alt="../_images/test_fixtures_request_different_scope.svg" class="align-center" src="../_images/test_fixtures_request_different_scope.svg" />
</div></blockquote>
<p>因此，当它们运行时，<code class="docutils literal notranslate"><span class="pre">outer</span></code> 将毫无问题地找到 <code class="docutils literal notranslate"><span class="pre">inner</span></code>，因为 pytest 是从测试的角度进行搜索的。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>fixtures 的定义作用域对其实例化顺序没有影响：顺序由 <a class="reference internal" href="#fixture-order"><span class="std std-ref">here</span></a> 中描述的逻辑决定。</p>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>Fixture availability is determined from the perspective of the test. A fixture
is only available for tests to request if they are in the scope that fixture is
defined in. If a fixture is defined inside a class, it can only be requested by
tests inside that class. But if a fixture is defined inside the global scope of
the module, then every test in that module, even if it’s defined inside a class,
can request it.</p>
<p>Similarly, a test can also only be affected by an autouse fixture if that test
is in the same scope that autouse fixture is defined in (see
<a class="reference internal" href="#autouse-order"><span class="std std-ref">Autouse Fixture 在其范围内首先执行</span></a>).</p>
<p>A fixture can also request any other fixture, no matter where it’s defined, so
long as the test requesting them can see all fixtures involved.</p>
<p>For example, here’s a test file with a fixture (<code class="docutils literal notranslate"><span class="pre">outer</span></code>) that requests a
fixture (<code class="docutils literal notranslate"><span class="pre">inner</span></code>) from a scope it wasn’t defined in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">outer</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">inner</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestOne</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">outer</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;outer&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TestTwo</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;two&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">outer</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;outer&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>From the tests’ perspectives, they have no problem seeing each of the fixtures
they’re dependent on:</p>
<blockquote>
<div><img alt="../_images/test_fixtures_request_different_scope.svg" class="align-center" src="../_images/test_fixtures_request_different_scope.svg" />
</div></blockquote>
<p>So when they run, <code class="docutils literal notranslate"><span class="pre">outer</span></code> will have no problem finding <code class="docutils literal notranslate"><span class="pre">inner</span></code>, because
pytest searched from the tests’ perspectives.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The scope a fixture is defined in has no bearing on the order it will be
instantiated in: the order is mandated by the logic described
<a class="reference internal" href="#fixture-order"><span class="std std-ref">here</span></a>.</p>
</div>
</div></div>
<section id="conftest-py-fixtures">
<h3><code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>: 跨多个文件分享 fixtures<a class="headerlink" href="#conftest-py-fixtures" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>: <strong>sharing fixtures across multiple files</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p><code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件用于为整个目录提供 fixtures 。在 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 中定义的 fixtures 可以被该包中的任何测试使用，而无需显式导入（pytest 会自动发现它们）。</p>
<p>你可以拥有多个嵌套的目录/包来包含测试，每个目录可以有自己的 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 及其 fixtures ，这些 fixtures 将附加到父目录中的 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件提供的 fixtures 上。</p>
<p>例如，给定以下测试文件结构：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/conftest.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">top</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">innermost</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>

    <span class="n">test_top</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/test_top.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">innermost</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;innermost top&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;innermost top&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">]</span>

    <span class="n">subpackage</span><span class="o">/</span>
        <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

        <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># tests/subpackage/conftest.py 的内容</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">mid</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mid subpackage&quot;</span><span class="p">)</span>

        <span class="n">test_subpackage</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># tests/subpackage/test_subpackage.py 的内容</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">innermost</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">mid</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;innermost subpackage&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;mid subpackage&quot;</span><span class="p">,</span> <span class="s2">&quot;innermost subpackage&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>作用域的边界可以如下可视化：</p>
<img alt="../_images/fixture_availability.svg" class="align-center" src="../_images/fixture_availability.svg" />
<p>目录成为它们自己的一种作用域，其中在该目录的 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件中定义的 fixtures 对整个作用域可用。</p>
<p>测试可以向上搜索（跨出一个圆圈）以找到 fixtures ，但不能向下搜索（进入一个圆圈）以继续查找。因此，<code class="docutils literal notranslate"><span class="pre">tests/subpackage/test_subpackage.py::test_order</span></code> 能够找到在 <code class="docutils literal notranslate"><span class="pre">tests/subpackage/test_subpackage.py</span></code> 中定义的 <code class="docutils literal notranslate"><span class="pre">innermost</span></code>  fixtures ，但在 <code class="docutils literal notranslate"><span class="pre">tests/test_top.py</span></code> 中定义的 fixtures 对它不可用，因为它必须下探一个层级（进入一个圆圈）才能找到它。</p>
<p>测试找到的第一个 fixtures 将被使用，因此 :ref:` fixtures 可以被重写 &lt;override fixtures&gt;` 如果你需要更改或扩展特定作用域的 fixtures 功能。</p>
<p>你还可以使用 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件实现 <a class="reference internal" href="../how-to/writing_plugins.html#conftest-py-plugins"><span class="std std-ref">每目录本地插件</span></a>。</p>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>The <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file serves as a means of providing fixtures for an entire
directory. Fixtures defined in a <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> can be used by any test
in that package without needing to import them (pytest will automatically
discover them).</p>
<p>You can have multiple nested directories/packages containing your tests, and
each directory can have its own <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> with its own fixtures, adding on
to the ones provided by the <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> files in parent directories.</p>
<p>For example, given a test file structure like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">top</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">innermost</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>

    <span class="n">test_top</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_top.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">innermost</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;innermost top&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;innermost top&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">]</span>

    <span class="n">subpackage</span><span class="o">/</span>
        <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

        <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subpackage/conftest.py</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">mid</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mid subpackage&quot;</span><span class="p">)</span>

        <span class="n">test_subpackage</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subpackage/test_subpackage.py</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">innermost</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">mid</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;innermost subpackage&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;mid subpackage&quot;</span><span class="p">,</span> <span class="s2">&quot;innermost subpackage&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The boundaries of the scopes can be visualized like this:</p>
<img alt="../_images/fixture_availability.svg" class="align-center" src="../_images/fixture_availability.svg" />
<p>The directories become their own sort of scope where fixtures that are defined
in a <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file in that directory become available for that whole
scope.</p>
<p>Tests are allowed to search upward (stepping outside a circle) for fixtures, but
can never go down (stepping inside a circle) to continue their search. So
<code class="docutils literal notranslate"><span class="pre">tests/subpackage/test_subpackage.py::test_order</span></code> would be able to find the
<code class="docutils literal notranslate"><span class="pre">innermost</span></code> fixture defined in <code class="docutils literal notranslate"><span class="pre">tests/subpackage/test_subpackage.py</span></code>, but
the one defined in <code class="docutils literal notranslate"><span class="pre">tests/test_top.py</span></code> would be unavailable to it because it
would have to step down a level (step inside a circle) to find it.</p>
<p>The first fixture the test finds is the one that will be used, so
<a class="reference internal" href="../how-to/fixtures.html#override-fixtures"><span class="std std-ref">fixtures can be overridden</span></a> if you need to change or
extend what one does for a particular scope.</p>
<p>You can also use the <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file to implement
<a class="reference internal" href="../how-to/writing_plugins.html#conftest-py-plugins"><span class="std std-ref">local per-directory plugins</span></a>.</p>
</div></div>
</section>
<section id="id6">
<h3>来自第三方插件的 fixtures<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<p><strong>Fixtures from third-party plugins</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><blockquote>
<div><p>fixtures 不一定需要在这个结构中定义才能对测试可用。它们也可以由安装的第三方插件提供，这就是许多 pytest 插件的工作方式。只要这些插件已安装，它们提供的 fixtures 就可以在测试套件的任何地方请求。</p>
</div></blockquote>
<p>由于它们是从测试套件结构之外提供的，第三方插件并不像 <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> 文件和测试套件中的目录那样提供作用域。因此，pytest 会按照之前解释的方式在作用域之间搜索 fixtures ，只有在最后才会找到在插件中定义的 fixtures 。</p>
<p>例如，给定以下文件结构：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># tests/conftest.py 的内容</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="n">subpackage</span><span class="o">/</span>
        <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

        <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># tests/subpackage/conftest.py 的内容</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">mid</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">b_fix</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mid subpackage&quot;</span><span class="p">)</span>

        <span class="n">test_subpackage</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># tests/subpackage/test_subpackage.py 的内容</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">a_fix</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;inner subpackage&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">inner</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;b_fix&quot;</span><span class="p">,</span> <span class="s2">&quot;mid subpackage&quot;</span><span class="p">,</span> <span class="s2">&quot;a_fix&quot;</span><span class="p">,</span> <span class="s2">&quot;inner subpackage&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>如果 <code class="docutils literal notranslate"><span class="pre">plugin_a</span></code> 已安装并提供 fixtures  <code class="docutils literal notranslate"><span class="pre">a_fix</span></code>，而 <code class="docutils literal notranslate"><span class="pre">plugin_b</span></code> 已安装并提供 fixtures  <code class="docutils literal notranslate"><span class="pre">b_fix</span></code>，那么测试查找 fixtures 的过程如下：</p>
<img alt="../_images/fixture_availability_plugins.svg" class="align-center" src="../_images/fixture_availability_plugins.svg" />
<p>pytest 只会在插件中搜索 <code class="docutils literal notranslate"><span class="pre">a_fix</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b_fix</span></code>，在此之前会先在 <code class="docutils literal notranslate"><span class="pre">tests/</span></code> 内的作用域中查找。</p>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>Fixtures don’t have to be defined in this structure to be available for tests,
though. They can also be provided by third-party plugins that are installed, and
this is how many pytest plugins operate. As long as those plugins are installed,
the fixtures they provide can be requested from anywhere in your test suite.</p>
<p>Because they’re provided from outside the structure of your test suite,
third-party plugins don’t really provide a scope like <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> files and
the directories in your test suite do. As a result, pytest will search for
fixtures stepping out through scopes as explained previously, only reaching
fixtures defined in plugins <em>last</em>.</p>
<p>For example, given the following file structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="n">subpackage</span><span class="o">/</span>
        <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>

        <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subpackage/conftest.py</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">mid</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">b_fix</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mid subpackage&quot;</span><span class="p">)</span>

        <span class="n">test_subpackage</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subpackage/test_subpackage.py</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">a_fix</span><span class="p">):</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;inner subpackage&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">inner</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;b_fix&quot;</span><span class="p">,</span> <span class="s2">&quot;mid subpackage&quot;</span><span class="p">,</span> <span class="s2">&quot;a_fix&quot;</span><span class="p">,</span> <span class="s2">&quot;inner subpackage&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">plugin_a</span></code> is installed and provides the fixture <code class="docutils literal notranslate"><span class="pre">a_fix</span></code>, and
<code class="docutils literal notranslate"><span class="pre">plugin_b</span></code> is installed and provides the fixture <code class="docutils literal notranslate"><span class="pre">b_fix</span></code>, then this is what
the test’s search for fixtures would look like:</p>
<img alt="../_images/fixture_availability_plugins.svg" class="align-center" src="../_images/fixture_availability_plugins.svg" />
<p>pytest will only search for <code class="docutils literal notranslate"><span class="pre">a_fix</span></code> and <code class="docutils literal notranslate"><span class="pre">b_fix</span></code> in the plugins after
searching for them first in the scopes inside <code class="docutils literal notranslate"><span class="pre">tests/</span></code>.</p>
</div></div>
</section>
</section>
<section id="fixture-order">
<span id="id7"></span><h2>Fixture 实例顺序<a class="headerlink" href="#fixture-order" title="Link to this heading">¶</a></h2>
<p><strong>Fixture instantiation order</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>当 pytest 想要执行一个测试时，一旦它知道将要执行哪些 fixtures ，就必须确定它们的执行顺序。为此，它考虑了三个因素：</p>
<ol class="arabic simple">
<li><p>作用域</p></li>
<li><p>依赖关系</p></li>
<li><p>自动使用（autouse）</p></li>
</ol>
<blockquote>
<div><p>fixtures 或测试的名称、它们的定义位置、定义顺序以及请求 fixtures 的顺序在执行顺序上没有其他影响，仅仅是巧合。虽然 pytest 会尽量确保这些巧合在每次运行中保持一致，但这并不是应该依赖的因素。如果你想控制执行顺序，最安全的做法是依赖这三个因素，并确保依赖关系明确。</p>
</div></blockquote>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>When pytest wants to execute a test, once it knows what fixtures will be
executed, it has to figure out the order they’ll be executed in. To do this, it
considers 3 factors:</p>
<ol class="arabic simple">
<li><p>scope</p></li>
<li><p>dependencies</p></li>
<li><p>autouse</p></li>
</ol>
<p>Names of fixtures or tests, where they’re defined, the order they’re defined in,
and the order fixtures are requested in have no bearing on execution order
beyond coincidence. While pytest will try to make sure coincidences like these
stay consistent from run to run, it’s not something that should be depended on.
If you want to control the order, it’s safest to rely on these 3 things and make
sure dependencies are clearly established.</p>
</div></div>
<section id="id8">
<h3>更高范围的 fixtures 将首先执行<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<p><strong>Higher-scoped fixtures are executed first</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>在对 fixtures 的函数请求中，较高作用域的 fixtures （例如 <code class="docutils literal notranslate"><span class="pre">session</span></code>）会在较低作用域的 fixtures （例如 <code class="docutils literal notranslate"><span class="pre">function</span></code> 或 <code class="docutils literal notranslate"><span class="pre">class</span></code>）之前执行。</p>
<p>以下是一个示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mod</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;package&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;package&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sess</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">pack</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="s2">&quot;package&quot;</span><span class="p">,</span> <span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>测试将会通过，因为较大作用域的 fixtures 优先执行。</p>
<p>执行顺序如下：</p>
<img alt="../_images/test_fixtures_order_scope.svg" class="align-center" src="../_images/test_fixtures_order_scope.svg" />
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>Within a function request for fixtures, those of higher-scopes (such as
<code class="docutils literal notranslate"><span class="pre">session</span></code>) are executed before lower-scoped fixtures (such as <code class="docutils literal notranslate"><span class="pre">function</span></code> or
<code class="docutils literal notranslate"><span class="pre">class</span></code>).</p>
<p>Here’s an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mod</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;package&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;package&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sess</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">pack</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="s2">&quot;package&quot;</span><span class="p">,</span> <span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The test will pass because the larger scoped fixtures are executing first.</p>
<p>The order breaks down to this:</p>
<img alt="../_images/test_fixtures_order_scope.svg" class="align-center" src="../_images/test_fixtures_order_scope.svg" />
</div></div>
</section>
<section id="id9">
<h3>相同顺序的 Fixture 根据依赖关系执行<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<p><strong>Fixtures of the same order execute based on dependencies</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p>当一个 fixtures 请求另一个 fixtures 时，另一个 fixtures 会首先执行。因此，如果 fixtures  <code class="docutils literal notranslate"><span class="pre">a</span></code> 请求 fixtures  <code class="docutils literal notranslate"><span class="pre">b</span></code>， fixtures  <code class="docutils literal notranslate"><span class="pre">b</span></code> 将首先执行，因为 <code class="docutils literal notranslate"><span class="pre">a</span></code> 依赖于 <code class="docutils literal notranslate"><span class="pre">b</span></code>，而无法在没有它的情况下运行。即使 <code class="docutils literal notranslate"><span class="pre">a</span></code> 不需要 <code class="docutils literal notranslate"><span class="pre">b</span></code> 的结果，如果它需要确保在 <code class="docutils literal notranslate"><span class="pre">b</span></code> 之后执行，仍然可以请求 <code class="docutils literal notranslate"><span class="pre">b</span></code>。</p>
<p>例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>如果我们绘制出依赖关系，结果看起来如下：</p>
<img alt="../_images/test_fixtures_order_dependencies.svg" class="align-center" src="../_images/test_fixtures_order_dependencies.svg" />
<p>每个 fixtures 所提供的规则（即每个 fixtures 必须在什么 fixtures 之后执行）是足够全面的，可以简化为：</p>
<img alt="../_images/test_fixtures_order_dependencies_flat.svg" class="align-center" src="../_images/test_fixtures_order_dependencies_flat.svg" />
<p>必须通过这些请求提供足够的信息，以便 pytest 能够确定一个清晰的线性依赖链，从而为给定测试确定操作顺序。如果存在任何模糊性，且操作顺序可以有多种解释，则应假定 pytest 可以在任何时刻选择这些解释中的任何一种。</p>
<p>例如，如果 <code class="docutils literal notranslate"><span class="pre">d</span></code> 没有请求 <code class="docutils literal notranslate"><span class="pre">c</span></code>，即图形将如下所示：</p>
<img alt="../_images/test_fixtures_order_dependencies_unclear.svg" class="align-center" src="../_images/test_fixtures_order_dependencies_unclear.svg" />
<p>因为除了 <code class="docutils literal notranslate"><span class="pre">g</span></code> 之外，没有任何东西请求 <code class="docutils literal notranslate"><span class="pre">c</span></code>，而 <code class="docutils literal notranslate"><span class="pre">g</span></code> 也请求 <code class="docutils literal notranslate"><span class="pre">f</span></code>，因此现在不清楚 <code class="docutils literal notranslate"><span class="pre">c</span></code> 应该在 <code class="docutils literal notranslate"><span class="pre">f</span></code>、<code class="docutils literal notranslate"><span class="pre">e</span></code> 还是 <code class="docutils literal notranslate"><span class="pre">d</span></code> 之前/之后执行。对 <code class="docutils literal notranslate"><span class="pre">c</span></code> 的唯一规则是它必须在 <code class="docutils literal notranslate"><span class="pre">b</span></code> 之后和 <code class="docutils literal notranslate"><span class="pre">g</span></code> 之前执行。</p>
<p>在这种情况下，pytest 不知道 <code class="docutils literal notranslate"><span class="pre">c</span></code> 应该放在什么地方，因此应假设它可以在 <code class="docutils literal notranslate"><span class="pre">g</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b</span></code> 之间的任何位置。</p>
<p>这并不一定是坏事，但值得注意。如果它们的执行顺序可能影响测试所针对的行为，或可能以其他方式影响测试结果，则应以允许 pytest 线性化/”扁平化” 该顺序的方式明确定义顺序。</p>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>When a fixture requests another fixture, the other fixture is executed first.
So if fixture <code class="docutils literal notranslate"><span class="pre">a</span></code> requests fixture <code class="docutils literal notranslate"><span class="pre">b</span></code>, fixture <code class="docutils literal notranslate"><span class="pre">b</span></code> will execute first,
because <code class="docutils literal notranslate"><span class="pre">a</span></code> depends on <code class="docutils literal notranslate"><span class="pre">b</span></code> and can’t operate without it. Even if <code class="docutils literal notranslate"><span class="pre">a</span></code>
doesn’t need the result of <code class="docutils literal notranslate"><span class="pre">b</span></code>, it can still request <code class="docutils literal notranslate"><span class="pre">b</span></code> if it needs to make
sure it is executed after <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>If we map out what depends on what, we get something that looks like this:</p>
<img alt="../_images/test_fixtures_order_dependencies.svg" class="align-center" src="../_images/test_fixtures_order_dependencies.svg" />
<p>The rules provided by each fixture (as to what fixture(s) each one has to come
after) are comprehensive enough that it can be flattened to this:</p>
<img alt="../_images/test_fixtures_order_dependencies_flat.svg" class="align-center" src="../_images/test_fixtures_order_dependencies_flat.svg" />
<p>Enough information has to be provided through these requests in order for pytest
to be able to figure out a clear, linear chain of dependencies, and as a result,
an order of operations for a given test. If there’s any ambiguity, and the order
of operations can be interpreted more than one way, you should assume pytest
could go with any one of those interpretations at any point.</p>
<p>For example, if <code class="docutils literal notranslate"><span class="pre">d</span></code> didn’t request <code class="docutils literal notranslate"><span class="pre">c</span></code>, i.e.the graph would look like this:</p>
<img alt="../_images/test_fixtures_order_dependencies_unclear.svg" class="align-center" src="../_images/test_fixtures_order_dependencies_unclear.svg" />
<p>Because nothing requested <code class="docutils literal notranslate"><span class="pre">c</span></code> other than <code class="docutils literal notranslate"><span class="pre">g</span></code>, and <code class="docutils literal notranslate"><span class="pre">g</span></code> also requests <code class="docutils literal notranslate"><span class="pre">f</span></code>,
it’s now unclear if <code class="docutils literal notranslate"><span class="pre">c</span></code> should go before/after <code class="docutils literal notranslate"><span class="pre">f</span></code>, <code class="docutils literal notranslate"><span class="pre">e</span></code>, or <code class="docutils literal notranslate"><span class="pre">d</span></code>. The
only rules that were set for <code class="docutils literal notranslate"><span class="pre">c</span></code> is that it must execute after <code class="docutils literal notranslate"><span class="pre">b</span></code> and
before <code class="docutils literal notranslate"><span class="pre">g</span></code>.</p>
<p>pytest doesn’t know where <code class="docutils literal notranslate"><span class="pre">c</span></code> should go in the case, so it should be assumed
that it could go anywhere between <code class="docutils literal notranslate"><span class="pre">g</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p>
<p>This isn’t necessarily bad, but it’s something to keep in mind. If the order
they execute in could affect the behavior a test is targeting, or could
otherwise influence the result of a test, then the order should be defined
explicitly in a way that allows pytest to linearize/”flatten” that order.</p>
</div></div>
</section>
<section id="autouse-fixture">
<span id="autouse-order"></span><h3>Autouse Fixture 在其范围内首先执行<a class="headerlink" href="#autouse-fixture" title="Link to this heading">¶</a></h3>
<p><strong>Autouse fixtures are executed first within their scope</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><p>autouse fixtures 假定适用于可以引用它们的每个测试，因此它们会在该范围内的其他 fixtures 之前执行。被 autouse fixtures 请求的 fixtures 在实际上也会成为适用于真实 autouse fixtures 所应用测试的 autouse fixtures 。</p>
<p>所以，如果 fixtures  <code class="docutils literal notranslate"><span class="pre">a</span></code> 是自动使用的，而 fixtures  <code class="docutils literal notranslate"><span class="pre">b</span></code> 不是，但 fixtures  <code class="docutils literal notranslate"><span class="pre">a</span></code> 请求了 fixtures  <code class="docutils literal notranslate"><span class="pre">b</span></code>，那么 fixtures  <code class="docutils literal notranslate"><span class="pre">b</span></code> 在实际上也将成为 autouse fixtures ，但仅适用于 <code class="docutils literal notranslate"><span class="pre">a</span></code> 适用的测试。</p>
<p>在最后一个例子中，如果 <code class="docutils literal notranslate"><span class="pre">d</span></code> 没有请求 <code class="docutils literal notranslate"><span class="pre">c</span></code>，图形会变得不清晰。但如果 <code class="docutils literal notranslate"><span class="pre">c</span></code> 是自动使用的，那么 <code class="docutils literal notranslate"><span class="pre">b</span></code> 和 <code class="docutils literal notranslate"><span class="pre">a</span></code> 实际上也将是自动使用的，因为 <code class="docutils literal notranslate"><span class="pre">c</span></code> 依赖于它们。因此，它们都将被提升到该范围内的非 autouse fixtures 之上。</p>
<p>所以如果测试文件看起来像这样：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_order_and_g</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>图形将如下所示：</p>
<img alt="../_images/test_fixtures_order_autouse.svg" class="align-center" src="../_images/test_fixtures_order_autouse.svg" />
<p>因为 <code class="docutils literal notranslate"><span class="pre">c</span></code> 现在可以放在 <code class="docutils literal notranslate"><span class="pre">d</span></code> 之上，pytest 可以再次将图形线性化为：</p>
<img alt="../_images/test_fixtures_order_autouse_flat.svg" class="align-center" src="../_images/test_fixtures_order_autouse_flat.svg" />
<p>在这个例子中，<code class="docutils literal notranslate"><span class="pre">c</span></code> 使得 <code class="docutils literal notranslate"><span class="pre">b</span></code> 和 <code class="docutils literal notranslate"><span class="pre">a</span></code> 也有效地成为 autouse fixtures 。</p>
<p>不过，请小心使用 autouse fixtures ，因为 autouse fixtures 将自动为每个能够到达它的测试执行，即使这些测试没有请求它。例如，考虑这个文件：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c1&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c2</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c2&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c3</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c3&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestClassWithC1Request</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TestClassWithoutC1Request</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>即使 <code class="docutils literal notranslate"><span class="pre">TestClassWithoutC1Request</span></code> 中没有请求 <code class="docutils literal notranslate"><span class="pre">c1</span></code>，它仍然会在其中的测试中执行：</p>
<img alt="../_images/test_fixtures_order_autouse_multiple_scopes.svg" class="align-center" src="../_images/test_fixtures_order_autouse_multiple_scopes.svg" />
<p>但仅仅因为一个 autouse fixtures 请求了一个非 autouse fixtures ，并不意味着这个非 autouse fixtures 会在所有适用的上下文中变为 autouse fixtures 。它仅在真实的 autouse fixtures （请求非 autouse fixtures 的那个）所能应用的上下文中有效地变为 autouse fixtures 。</p>
<p>例如，看看这个测试文件：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c1&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">c2</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c2&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestClassWithAutouse</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">c3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c3&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">,</span> <span class="s2">&quot;c1&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_no_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TestClassWithoutAutouse</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_no_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div>
</div>
<p>它将分解为如下内容：</p>
<img alt="../_images/test_fixtures_order_autouse_temp_effects.svg" class="align-center" src="../_images/test_fixtures_order_autouse_temp_effects.svg" />
<p>对于 <code class="docutils literal notranslate"><span class="pre">TestClassWithAutouse</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">test_req</span></code> 和 <code class="docutils literal notranslate"><span class="pre">test_no_req</span></code>，<code class="docutils literal notranslate"><span class="pre">c3</span></code> 有效地使 <code class="docutils literal notranslate"><span class="pre">c2</span></code> 成为 autouse fixtures ，这就是为什么 <code class="docutils literal notranslate"><span class="pre">c2</span></code> 和 <code class="docutils literal notranslate"><span class="pre">c3</span></code> 会在两个测试中执行，尽管没有被请求，以及为什么 <code class="docutils literal notranslate"><span class="pre">c2</span></code> 和 <code class="docutils literal notranslate"><span class="pre">c3</span></code> 会在 <code class="docutils literal notranslate"><span class="pre">test_req</span></code> 的 <code class="docutils literal notranslate"><span class="pre">c1</span></code> 之前执行。</p>
<p>如果这使得 <code class="docutils literal notranslate"><span class="pre">c2</span></code> 成为一个 <em>实际</em> 的 autouse fixtures ，那么 <code class="docutils literal notranslate"><span class="pre">c2</span></code> 也会为 <code class="docutils literal notranslate"><span class="pre">TestClassWithoutAutouse</span></code> 中的测试执行，因为它们如果想的话可以引用 <code class="docutils literal notranslate"><span class="pre">c2</span></code>。但它不会，因为从 <code class="docutils literal notranslate"><span class="pre">TestClassWithoutAutouse</span></code> 测试的角度看，<code class="docutils literal notranslate"><span class="pre">c2</span></code> 不是一个 autouse fixtures ，因为它们无法看到 <code class="docutils literal notranslate"><span class="pre">c3</span></code>。</p>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><p>Autouse fixtures are assumed to apply to every test that could reference them,
so they are executed before other fixtures in that scope. Fixtures that are
requested by autouse fixtures effectively become autouse fixtures themselves for
the tests that the real autouse fixture applies to.</p>
<p>So if fixture <code class="docutils literal notranslate"><span class="pre">a</span></code> is autouse and fixture <code class="docutils literal notranslate"><span class="pre">b</span></code> is not, but fixture <code class="docutils literal notranslate"><span class="pre">a</span></code>
requests fixture <code class="docutils literal notranslate"><span class="pre">b</span></code>, then fixture <code class="docutils literal notranslate"><span class="pre">b</span></code> will effectively be an autouse
fixture as well, but only for the tests that <code class="docutils literal notranslate"><span class="pre">a</span></code> applies to.</p>
<p>In the last example, the graph became unclear if <code class="docutils literal notranslate"><span class="pre">d</span></code> didn’t request <code class="docutils literal notranslate"><span class="pre">c</span></code>. But
if <code class="docutils literal notranslate"><span class="pre">c</span></code> was autouse, then <code class="docutils literal notranslate"><span class="pre">b</span></code> and <code class="docutils literal notranslate"><span class="pre">a</span></code> would effectively also be autouse
because <code class="docutils literal notranslate"><span class="pre">c</span></code> depends on them. As a result, they would all be shifted above
non-autouse fixtures within that scope.</p>
<p>So if the test file looked like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_order_and_g</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>the graph would look like this:</p>
<img alt="../_images/test_fixtures_order_autouse.svg" class="align-center" src="../_images/test_fixtures_order_autouse.svg" />
<p>Because <code class="docutils literal notranslate"><span class="pre">c</span></code> can now be put above <code class="docutils literal notranslate"><span class="pre">d</span></code> in the graph, pytest can once again
linearize the graph to this:</p>
<img alt="../_images/test_fixtures_order_autouse_flat.svg" class="align-center" src="../_images/test_fixtures_order_autouse_flat.svg" />
<p>In this example, <code class="docutils literal notranslate"><span class="pre">c</span></code> makes <code class="docutils literal notranslate"><span class="pre">b</span></code> and <code class="docutils literal notranslate"><span class="pre">a</span></code> effectively autouse fixtures as
well.</p>
<p>Be careful with autouse, though, as an autouse fixture will automatically
execute for every test that can reach it, even if they don’t request it. For
example, consider this file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c1&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c2</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c2&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">c3</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c3&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestClassWithC1Request</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TestClassWithoutC1Request</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Even though nothing in <code class="docutils literal notranslate"><span class="pre">TestClassWithoutC1Request</span></code> is requesting <code class="docutils literal notranslate"><span class="pre">c1</span></code>, it still
is executed for the tests inside it anyway:</p>
<img alt="../_images/test_fixtures_order_autouse_multiple_scopes.svg" class="align-center" src="../_images/test_fixtures_order_autouse_multiple_scopes.svg" />
<p>But just because one autouse fixture requested a non-autouse fixture, that
doesn’t mean the non-autouse fixture becomes an autouse fixture for all contexts
that it can apply to. It only effectively becomes an autouse fixture for the
contexts the real autouse fixture (the one that requested the non-autouse
fixture) can apply to.</p>
<p>For example, take a look at this test file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c1&quot;</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">c2</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c2&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestClassWithAutouse</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">c3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;c3&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">,</span> <span class="s2">&quot;c1&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_no_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TestClassWithoutAutouse</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_no_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div>
</div>
<p>It would break down to something like this:</p>
<img alt="../_images/test_fixtures_order_autouse_temp_effects.svg" class="align-center" src="../_images/test_fixtures_order_autouse_temp_effects.svg" />
<p>For <code class="docutils literal notranslate"><span class="pre">test_req</span></code> and <code class="docutils literal notranslate"><span class="pre">test_no_req</span></code> inside <code class="docutils literal notranslate"><span class="pre">TestClassWithAutouse</span></code>, <code class="docutils literal notranslate"><span class="pre">c3</span></code>
effectively makes <code class="docutils literal notranslate"><span class="pre">c2</span></code> an autouse fixture, which is why <code class="docutils literal notranslate"><span class="pre">c2</span></code> and <code class="docutils literal notranslate"><span class="pre">c3</span></code> are
executed for both tests, despite not being requested, and why <code class="docutils literal notranslate"><span class="pre">c2</span></code> and <code class="docutils literal notranslate"><span class="pre">c3</span></code>
are executed before <code class="docutils literal notranslate"><span class="pre">c1</span></code> for <code class="docutils literal notranslate"><span class="pre">test_req</span></code>.</p>
<p>If this made <code class="docutils literal notranslate"><span class="pre">c2</span></code> an <em>actual</em> autouse fixture, then <code class="docutils literal notranslate"><span class="pre">c2</span></code> would also execute
for the tests inside <code class="docutils literal notranslate"><span class="pre">TestClassWithoutAutouse</span></code>, since they can reference
<code class="docutils literal notranslate"><span class="pre">c2</span></code> if they wanted to. But it doesn’t, because from the perspective of the
<code class="docutils literal notranslate"><span class="pre">TestClassWithoutAutouse</span></code> tests, <code class="docutils literal notranslate"><span class="pre">c2</span></code> isn’t an autouse fixture, since they
can’t see <code class="docutils literal notranslate"><span class="pre">c3</span></code>.</p>
</div></div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="customize.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">配置</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="reference.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">API 参考</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2015, holger krekel and pytest-dev team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Fixtures 参考</a><ul>
<li><a class="reference internal" href="#id3">内置 fixtures</a></li>
<li><a class="reference internal" href="#conftest">Fixture 可用性</a><ul>
<li><a class="reference internal" href="#conftest-py-fixtures"><code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>: 跨多个文件分享 fixtures</a></li>
<li><a class="reference internal" href="#id6">来自第三方插件的 fixtures</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fixture-order">Fixture 实例顺序</a><ul>
<li><a class="reference internal" href="#id8">更高范围的 fixtures 将首先执行</a></li>
<li><a class="reference internal" href="#id9">相同顺序的 Fixture 根据依赖关系执行</a></li>
<li><a class="reference internal" href="#autouse-fixture">Autouse Fixture 在其范围内首先执行</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=7c91f8fd"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>