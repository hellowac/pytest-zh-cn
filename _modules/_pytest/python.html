<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="search" title="Search" href="../../search.html" />
        <link rel="canonical" href="https://docs.pytest.org/en/stable/_modules/_pytest/python.html" />

    <link rel="shortcut icon" href="../../_static/favicon.png"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>_pytest.python - pytest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments_pytest.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/pytest-custom.css?v=eb7c59a4" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">pytest documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/pytest1.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">入门</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../how-to/index.html">操作指南</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 操作指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/usage.html">如何调用 pytest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/assert.html">如何在测试中编写和报告断言</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/fixtures.html">如何使用 fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/mark.html">如何用属性标记测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/parametrize.html">如何参数化fixtures和测试函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/tmp_path.html">如何在测试中使用临时目录和文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/monkeypatch.html">如何使用 猴子补丁/mock 模块和环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/doctest.html">如何运行文档测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/cache.html">如何重新运行失败的测试并在测试运行之间保持状态</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/failures.html">如何处理测试失败</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/output.html">管理 pytest 的输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/logging.html">如何管理日志记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/capture-stdout-stderr.html">如何捕获 stdout/stderr 输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/capture-warnings.html">如何捕获警告</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/skipping.html">如何使用 skip 和 xfail 处理无法成功的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/plugins.html">如何安装和使用插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/writing_plugins.html">编写插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/writing_hook_functions.html">编写钩子函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/existingtestsuite.html">如何将 pytest 与现有测试套件结合使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/unittest.html">如何在 pytest 中使用基于 unittest 的测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/xunit_setup.html">如何实现 xunit 样式的设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/bash-completion.html">如何设置 bash 补全</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../reference/index.html">参考指南</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 参考指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/reference.html">API 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/fixtures.html">Fixtures 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/customize.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/exit-codes.html">退出码</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/plugin_list.html">Pytest 插件列表</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../explanation/index.html">解答</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 解答</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../explanation/anatomy.html">测试剖析</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explanation/fixtures.html">关于 fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explanation/goodpractices.html">良好的集成实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explanation/pythonpath.html">pytest 导入机制和 <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> / <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explanation/ci.html">CI Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explanation/flaky.html">不稳定的测试</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../example/index.html">示例和自定义技巧</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 示例和自定义技巧</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../example/reportingdemo.html">使用 pytest 的 Python 故障报告演示</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example/simple.html">基本模式和示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example/parametrize.html">参数化测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example/markers.html">使用自定义标记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example/special.html">可以查看所有收集到的测试的会话fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example/pythoncollection.html">改变标准 (Python) 测试的发现机制</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example/nonpython.html">使用非 Python 测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example/customdirectory.html">使用自定义目录收集器</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">关于项目</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">更改日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backwards-compatibility.html">向后兼容政策</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backwards-compatibility.html#id2">历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backwards-compatibility.html#python">Python版本支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sponsor.html">赞助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tidelift.html">pytest 企业版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">许可</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">联系渠道</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">游泳的链接</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/pytest/">pytest @ PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/">pytest @ GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytest-dev/pytest/issues">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://media.readthedocs.org/pdf/pytest/latest/pytest.pdf">PDF Documentation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for _pytest.python</h1><div class="highlight"><pre>
<span></span><span class="c1"># mypy: allow-untyped-defs</span>
<span class="sd">&quot;&quot;&quot;Python test discovery, setup and run of test functions.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">final</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Pattern</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">_pytest</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">fixtures</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">_pytest._code</span> <span class="kn">import</span> <span class="n">filter_traceback</span>
<span class="kn">from</span> <span class="nn">_pytest._code</span> <span class="kn">import</span> <span class="n">getfslineno</span>
<span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">ExceptionInfo</span>
<span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">TerminalRepr</span>
<span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">Traceback</span>
<span class="kn">from</span> <span class="nn">_pytest._io.saferepr</span> <span class="kn">import</span> <span class="n">saferepr</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">ascii_escaped</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_default_arg_names</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_real_func</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getimfunc</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">is_async_function</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">is_generator</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">LEGACY_PATH</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">NOTSET</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_getattr</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_isclass</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">hookimpl</span>
<span class="kn">from</span> <span class="nn">_pytest.config.argparsing</span> <span class="kn">import</span> <span class="n">Parser</span>
<span class="kn">from</span> <span class="nn">_pytest.deprecated</span> <span class="kn">import</span> <span class="n">check_ispytest</span>
<span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">FixtureDef</span>
<span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">FixtureRequest</span>
<span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">FuncFixtureInfo</span>
<span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">get_scope_node</span>
<span class="kn">from</span> <span class="nn">_pytest.main</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">_pytest.mark</span> <span class="kn">import</span> <span class="n">MARK_GEN</span>
<span class="kn">from</span> <span class="nn">_pytest.mark</span> <span class="kn">import</span> <span class="n">ParameterSet</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">get_unpacked_marks</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">Mark</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">MarkDecorator</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">normalize_mark_list</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">fail</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">skip</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">fnmatch_ex</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">import_path</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">ImportPathMismatchError</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">scandir</span>
<span class="kn">from</span> <span class="nn">_pytest.scope</span> <span class="kn">import</span> <span class="n">_ScopeName</span>
<span class="kn">from</span> <span class="nn">_pytest.scope</span> <span class="kn">import</span> <span class="n">Scope</span>
<span class="kn">from</span> <span class="nn">_pytest.stash</span> <span class="kn">import</span> <span class="n">StashKey</span>
<span class="kn">from</span> <span class="nn">_pytest.warning_types</span> <span class="kn">import</span> <span class="n">PytestCollectionWarning</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Self</span>


<span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">Parser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_files&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="c1"># NOTE: default is also used in AssertionRewritingHook.</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test_*.py&quot;</span><span class="p">,</span> <span class="s2">&quot;*_test.py&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Glob-style file patterns for Python test module discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_classes&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Test&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Prefixes or glob names for Python test class discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_functions&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Prefixes or glob names for Python test function and method discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;disable_test_id_escaping_and_forfeit_all_rights_to_community_support&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable string escape non-ASCII characters, might cause unwanted &quot;</span>
        <span class="s2">&quot;side effects(use at your own risk)&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">:</span> <span class="n">Metafunc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">iter_markers</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;parametrize&quot;</span><span class="p">):</span>
        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="o">*</span><span class="n">marker</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">marker</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">_param_mark</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
        <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parametrize(argnames, argvalues): call a test function multiple &quot;</span>
        <span class="s2">&quot;times passing in different arguments in turn. argvalues generally &quot;</span>
        <span class="s2">&quot;needs to be a list of values if argnames specifies only one name &quot;</span>
        <span class="s2">&quot;or a list of tuples of values if argnames specifies multiple names. &quot;</span>
        <span class="s2">&quot;Example: @parametrize(&#39;arg1&#39;, [1,2]) would lead to two calls of the &quot;</span>
        <span class="s2">&quot;decorated test function, one with arg1=1 and another with arg1=2.&quot;</span>
        <span class="s2">&quot;see https://docs.pytest.org/en/stable/how-to/parametrize.html for more info &quot;</span>
        <span class="s2">&quot;and examples.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
        <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;usefixtures(fixturename1, fixturename2, ...): mark tests as needing &quot;</span>
        <span class="s2">&quot;all of the specified fixtures. see &quot;</span>
        <span class="s2">&quot;https://docs.pytest.org/en/stable/explanation/fixtures.html#usefixtures &quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">async_fail</span><span class="p">(</span><span class="n">nodeid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;async def functions are not natively supported.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;You need to install a suitable plugin for your async framework, for example:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  - anyio</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  - pytest-asyncio</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  - pytest-tornasync</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  - pytest-trio</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  - pytest-twisted&quot;</span>
    <span class="p">)</span>
    <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="p">:</span> <span class="n">Function</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">testfunction</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">obj</span>
    <span class="k">if</span> <span class="n">is_async_function</span><span class="p">(</span><span class="n">testfunction</span><span class="p">):</span>
        <span class="n">async_fail</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>
    <span class="n">funcargs</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">funcargs</span>
    <span class="n">testargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">arg</span><span class="p">:</span> <span class="n">funcargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">_fixtureinfo</span><span class="o">.</span><span class="n">argnames</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">testfunction</span><span class="p">(</span><span class="o">**</span><span class="n">testargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;__await__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;__aiter__&quot;</span><span class="p">):</span>
        <span class="n">async_fail</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected None, but test returned </span><span class="si">{</span><span class="n">result</span><span class="si">!r}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Did you mean to use `assert` instead of `return`?&quot;</span>
            <span class="p">),</span>
            <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">pytest_collect_directory</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">pkginit</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;__init__.py&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">has_pkginit</span> <span class="o">=</span> <span class="n">pkginit</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
        <span class="c1"># See https://github.com/pytest-dev/pytest/issues/12120#issuecomment-2106349096.</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">has_pkginit</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Package</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">pytest_collect_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.py&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path_matches_patterns</span><span class="p">(</span>
                <span class="n">file_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;python_files&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">module</span><span class="p">:</span> <span class="n">Module</span> <span class="o">=</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pycollect_makemodule</span><span class="p">(</span>
            <span class="n">module_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">module</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">path_matches_patterns</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return whether path matches any of the patterns in the list of globs given.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">fnmatch_ex</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_pycollect_makemodule</span><span class="p">(</span><span class="n">module_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Module</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">module_path</span><span class="p">)</span>


<span class="nd">@hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pycollect_makeitem</span><span class="p">(</span>
    <span class="n">collector</span><span class="p">:</span> <span class="n">Module</span> <span class="o">|</span> <span class="n">Class</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">Module</span><span class="p">)),</span> <span class="nb">type</span><span class="p">(</span><span class="n">collector</span><span class="p">)</span>
    <span class="c1"># Nothing was collected elsewhere, let&#39;s do it here.</span>
    <span class="k">if</span> <span class="n">safe_isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collector</span><span class="o">.</span><span class="n">istestclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Class</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">collector</span><span class="o">.</span><span class="n">istestfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># mock seems to store unbound methods (issue473), normalize it.</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="c1"># We need to try and unwrap the function if it&#39;s a functools.partial</span>
        <span class="c1"># or a functools.wrapped.</span>
        <span class="c1"># We mustn&#39;t if it&#39;s been wrapped with mock.patch (python 2 only).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">get_real_func</span><span class="p">(</span><span class="n">obj</span><span class="p">))):</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn_explicit</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">PytestCollectionWarning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;cannot collect </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> because it is not a function.&quot;</span>
                <span class="p">),</span>
                <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_generator</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">Function</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;yield tests were removed in pytest 4.0 - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> will be ignored&quot;</span>
                <span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">MARK_GEN</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">))</span>
                <span class="n">res</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">PytestCollectionWarning</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">_genfunctions</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">PyobjMixin</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;this mix-in inherits from Node to carry over the typing information</span>

<span class="sd">    as its intended to always mix in before a node</span>
<span class="sd">    its position in the mro is unaffected&quot;&quot;&quot;</span>

    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Python module object this node was collected from (can be None).&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Python class object this node was collected from (can be None).&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Python instance object the function is bound to.</span>

<span class="sd">        Returns None if not a test method, e.g. for a standalone test function,</span>
<span class="sd">        a class or a module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Overridden by Function.</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">obj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Underlying Python object.&quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_obj&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getobj</span><span class="p">()</span>
            <span class="c1"># XXX evil hack</span>
            <span class="c1"># used to avoid Function marker duplication</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALLOW_MARKERS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_unpacked_marks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
                <span class="c1"># This assumes that `obj` is called before there is a chance</span>
                <span class="c1"># to add custom keys to `self.keywords`, so no fear of overriding.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">mark</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span> <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@obj</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the underlying Python object. May be overwritten by subclasses.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Improve the type of `parent` such that assert/ignore aren&#39;t needed.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getmodpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stopatmodule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">includemodule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Python path relative to the containing module.&quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_parents</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Module</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stopatmodule</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">includemodule</span><span class="p">:</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reportinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># XXX caching?</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">modpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmodpath</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">modpath</span>


<span class="c1"># As an optimization, these builtin attribute names are pre-ignored when</span>
<span class="c1"># iterating over an object during collection -- the pytest_pycollect_makeitem</span>
<span class="c1"># hook is not called for them.</span>
<span class="c1"># fmt: off</span>
<span class="k">class</span> <span class="nc">_EmptyClass</span><span class="p">:</span> <span class="k">pass</span>  <span class="c1"># noqa: E701</span>
<span class="n">IGNORED_ATTRIBUTES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
    <span class="nb">frozenset</span><span class="p">(),</span>
    <span class="c1"># Module.</span>
    <span class="nb">dir</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="s2">&quot;empty_module&quot;</span><span class="p">)),</span>
    <span class="c1"># Some extra module attributes the above doesn&#39;t catch.</span>
    <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">,</span> <span class="s2">&quot;__cached__&quot;</span><span class="p">},</span>
    <span class="c1"># Class.</span>
    <span class="nb">dir</span><span class="p">(</span><span class="n">_EmptyClass</span><span class="p">),</span>
    <span class="c1"># Instance.</span>
    <span class="nb">dir</span><span class="p">(</span><span class="n">_EmptyClass</span><span class="p">()),</span>
<span class="p">)</span>
<span class="k">del</span> <span class="n">_EmptyClass</span>
<span class="c1"># fmt: on</span>


<span class="k">class</span> <span class="nc">PyCollector</span><span class="p">(</span><span class="n">PyobjMixin</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">funcnamefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="s2">&quot;python_functions&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isnosetest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look for the __test__ attribute, which is applied by the</span>
<span class="sd">        @nose.tools.istest decorator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We explicitly check for &quot;is True&quot; here to not mistakenly treat</span>
        <span class="c1"># classes with a custom __getattr__ returning something truthy (like a</span>
        <span class="c1"># function) as test classes.</span>
        <span class="k">return</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">classnamefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="s2">&quot;python_classes&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">istestfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcnamefilter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnosetest</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">staticmethod</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">)):</span>
                <span class="c1"># staticmethods and classmethods need to be unwrapped.</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">getfixturemarker</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">istestclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classnamefilter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnosetest</span><span class="p">(</span><span class="n">obj</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isabstract</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the given name matches the prefix or glob-pattern defined</span>
<span class="sd">        in ini configuration.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="n">option_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">option</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># Check that name looks like a glob-string before calling fnmatch</span>
            <span class="c1"># because this is called for every name in each collected module,</span>
            <span class="c1"># and fnmatch is somewhat expensive to call.</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">or</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">or</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">option</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Avoid random getattrs and peek in the __dict__ instead.</span>
        <span class="n">dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="p">{})]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">basecls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
                <span class="n">dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basecls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="c1"># In each class, nodes should be definition ordered.</span>
        <span class="c1"># __dict__ is definition ordered.</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">dict_values</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span>
        <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">:</span>
            <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Note: seems like the dict can change during iteration -</span>
            <span class="c1"># be careful not to remove the list() without consideration.</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">IGNORED_ATTRIBUTES</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pycollect_makeitem</span><span class="p">(</span>
                    <span class="n">collector</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">dict_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Between classes in the class hierarchy, reverse-MRO order -- nodes</span>
        <span class="c1"># inherited from base classes should come before subclasses.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">dict_values</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_genfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">funcobj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Function</span><span class="p">]:</span>
        <span class="n">modulecol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Module</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">modulecol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">modulecol</span><span class="o">.</span><span class="n">obj</span>
        <span class="n">clscol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">clscol</span> <span class="ow">and</span> <span class="n">clscol</span><span class="o">.</span><span class="n">obj</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">FunctionDefinition</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">callobj</span><span class="o">=</span><span class="n">funcobj</span><span class="p">)</span>
        <span class="n">fixtureinfo</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">_fixtureinfo</span>

        <span class="c1"># pytest_generate_tests impls call metafunc.parametrize() which fills</span>
        <span class="c1"># metafunc._calls, the outcome of the hook.</span>
        <span class="n">metafunc</span> <span class="o">=</span> <span class="n">Metafunc</span><span class="p">(</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">fixtureinfo</span><span class="o">=</span><span class="n">fixtureinfo</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span>
            <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span>
            <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;pytest_generate_tests&quot;</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;pytest_generate_tests&quot;</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="o">.</span><span class="n">call_extra</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metafunc</span><span class="o">=</span><span class="n">metafunc</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Function</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fixtureinfo</span><span class="o">=</span><span class="n">fixtureinfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metafunc</span><span class="o">.</span><span class="n">_recompute_direct_params_indices</span><span class="p">()</span>
            <span class="c1"># Direct parametrizations taking place in module/class-specific</span>
            <span class="c1"># `metafunc.parametrize` calls may have shadowed some fixtures, so make sure</span>
            <span class="c1"># we update what the function really needs a.k.a its fixture closure. Note that</span>
            <span class="c1"># direct parametrizations using `@pytest.mark.parametrize` have already been considered</span>
            <span class="c1"># into making the closure using `ignore_args` arg to `getfixtureclosure`.</span>
            <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">prune_dependency_tree</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
                <span class="n">subname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">callspec</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">yield</span> <span class="n">Function</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">subname</span><span class="p">,</span>
                    <span class="n">callspec</span><span class="o">=</span><span class="n">callspec</span><span class="p">,</span>
                    <span class="n">fixtureinfo</span><span class="o">=</span><span class="n">fixtureinfo</span><span class="p">,</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="n">callspec</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                    <span class="n">originalname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>


<span class="k">def</span> <span class="nf">importtestmodule</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># We assume we are only called once per module.</span>
    <span class="n">importmode</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;--import-mode&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">import_path</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">importmode</span><span class="p">,</span>
            <span class="n">root</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">rootpath</span><span class="p">,</span>
            <span class="n">consider_namespace_packages</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;consider_namespace_packages&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
            <span class="n">ExceptionInfo</span><span class="o">.</span><span class="n">from_current</span><span class="p">()</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">except</span> <span class="n">ImportPathMismatchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
            <span class="s2">&quot;import file mismatch:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;imported module </span><span class="si">{!r}</span><span class="s2"> has this __file__ attribute:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;which is not the same as the test file we want to collect:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;HINT: remove __pycache__ / .pyc files and/or use a &quot;</span>
            <span class="s2">&quot;unique basename for your test file modules&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">exc_info</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="o">.</span><span class="n">from_current</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_verbosity</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_traceback</span><span class="p">)</span>
        <span class="n">exc_repr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">exc_info</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span>
            <span class="k">else</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">exconly</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">formatted_tb</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_repr</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ImportError while importing test module &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Hint: make sure your test modules/packages have valid Python names.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Traceback:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">formatted_tb</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">except</span> <span class="n">skip</span><span class="o">.</span><span class="n">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">allow_module_level</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
            <span class="s2">&quot;Using pytest.skip outside of a test will skip the entire module. &quot;</span>
            <span class="s2">&quot;If that&#39;s your intention, pass `allow_module_level=True`. &quot;</span>
            <span class="s2">&quot;If you want to skip a specific test or an entire class, &quot;</span>
            <span class="s2">&quot;use the @pytest.mark.skip or @pytest.mark.skipif decorators.&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_module</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mod</span>


<div class="viewcode-block" id="Module">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Module">[docs]</a>
<span class="k">class</span> <span class="nc">Module</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">PyCollector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collector for test classes and functions in a Python module.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">importtestmodule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="Module.collect">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Module.collect">[docs]</a>
    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_setup_module_fixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_setup_function_fixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">parsefactories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_register_setup_module_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register an autouse, module-scoped fixture for the collected module object</span>
<span class="sd">        that invokes setUpModule/tearDownModule if either or both are available.</span>

<span class="sd">        Using a fixture to invoke this methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setUpModule&quot;</span><span class="p">,</span> <span class="s2">&quot;setup_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">teardown_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;tearDownModule&quot;</span><span class="p">,</span> <span class="s2">&quot;teardown_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">xunit_setup_module_fixture</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">module</span>
            <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">setup_module</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">teardown_module</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">_register_fixture</span><span class="p">(</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_xunit_setup_module_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="n">xunit_setup_module_fixture</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">,</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_setup_function_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register an autouse, function-scoped fixture for the collected module object</span>
<span class="sd">        that invokes setup_function/teardown_function if either or both are available.</span>

<span class="sd">        Using a fixture to invoke this methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_function</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setup_function&quot;</span><span class="p">,))</span>
        <span class="n">teardown_function</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;teardown_function&quot;</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_function</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">xunit_setup_function_fixture</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># in this case we are bound to an instance, so we need to let</span>
                <span class="c1"># setup_method handle this</span>
                <span class="k">yield</span>
                <span class="k">return</span>
            <span class="n">function</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">function</span>
            <span class="k">if</span> <span class="n">setup_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">setup_function</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">teardown_function</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">_register_fixture</span><span class="p">(</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_xunit_setup_function_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="n">xunit_setup_function_fixture</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="Package">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Package">[docs]</a>
<span class="k">class</span> <span class="nc">Package</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collector for files and directories in a Python packages -- directories</span>
<span class="sd">    with an `__init__.py` file.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Directories without an `__init__.py` file are instead collected by</span>
<span class="sd">        :class:`~pytest.Dir` by default. Both are :class:`~pytest.Directory`</span>
<span class="sd">        collectors.</span>

<span class="sd">    .. versionchanged:: 8.0</span>

<span class="sd">        Now inherits from :class:`~pytest.Directory`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fspath</span><span class="p">:</span> <span class="n">LEGACY_PATH</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">,</span>
        <span class="c1"># NOTE: following args are unused:</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nodeid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># NOTE: Could be just the following, but kept as-is for compat.</span>
        <span class="c1"># super().__init__(self, fspath, parent=parent)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">fspath</span><span class="o">=</span><span class="n">fspath</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_mod</span> <span class="o">=</span> <span class="n">importtestmodule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Not using fixtures to call setup_module here because autouse fixtures</span>
        <span class="c1"># from packages are not called automatically (#4085).</span>
        <span class="n">setup_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="n">init_mod</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setUpModule&quot;</span><span class="p">,</span> <span class="s2">&quot;setup_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">setup_module</span><span class="p">,</span> <span class="n">init_mod</span><span class="p">)</span>

        <span class="n">teardown_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="n">init_mod</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;tearDownModule&quot;</span><span class="p">,</span> <span class="s2">&quot;teardown_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_call_with_optional_argument</span><span class="p">,</span> <span class="n">teardown_module</span><span class="p">,</span> <span class="n">init_mod</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<div class="viewcode-block" id="Package.collect">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Package.collect">[docs]</a>
    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]:</span>
        <span class="c1"># Always collect __init__.py first.</span>
        <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="n">entry</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">DirEntry</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">col</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="n">cols</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span>
        <span class="k">for</span> <span class="n">direntry</span> <span class="ow">in</span> <span class="n">scandir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">sort_key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">direntry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">direntry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">with_parents</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_ignore_collect</span><span class="p">(</span><span class="n">collection_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">):</span>
                        <span class="k">continue</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_collect_directory</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">col</span>

            <span class="k">elif</span> <span class="n">direntry</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">direntry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_ignore_collect</span><span class="p">(</span><span class="n">collection_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">):</span>
                        <span class="k">continue</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_collect_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">yield from</span> <span class="n">cols</span></div>
</div>



<span class="k">def</span> <span class="nf">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call the given function with the given argument if func accepts one argument, otherwise</span>
<span class="sd">    calls func without arguments.&quot;&quot;&quot;</span>
    <span class="n">arg_count</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">arg_count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">arg_count</span><span class="p">:</span>
        <span class="n">func</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_first_non_fixture_func</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the attribute from the given object to be used as a setup/teardown</span>
<span class="sd">    xunit-style function, but only if not marked as a fixture to avoid calling it twice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">meth</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">getfixturemarker</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meth</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="Class">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Class">[docs]</a>
<span class="k">class</span> <span class="nc">Class</span><span class="p">(</span><span class="n">PyCollector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collector for test methods (and nested classes) in a Python class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Class.from_parent">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Class.from_parent">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_parent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>  <span class="c1"># type: ignore[override]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The public constructor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">newinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>

<div class="viewcode-block" id="Class.collect">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Class.collect">[docs]</a>
    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span> <span class="o">|</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">hasinit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">PytestCollectionWarning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;cannot collect test class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> because it has a &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;__init__ constructor (from: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">nodeid</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">hasnew</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">PytestCollectionWarning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;cannot collect test class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> because it has a &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;__new__ constructor (from: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">nodeid</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_register_setup_class_fixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_setup_method_fixture</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">parsefactories</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newinstance</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_register_setup_class_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register an autouse, class scoped fixture into the collected class object</span>
<span class="sd">        that invokes setup_class/teardown_class if either or both are available.</span>

<span class="sd">        Using a fixture to invoke this methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_class</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setup_class&quot;</span><span class="p">,))</span>
        <span class="n">teardown_class</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;teardown_class&quot;</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">setup_class</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">xunit_setup_class_fixture</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cls</span>
            <span class="k">if</span> <span class="n">setup_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">getimfunc</span><span class="p">(</span><span class="n">setup_class</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">getimfunc</span><span class="p">(</span><span class="n">teardown_class</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">_register_fixture</span><span class="p">(</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_xunit_setup_class_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="n">xunit_setup_class_fixture</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_setup_method_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register an autouse, function scoped fixture into the collected class object</span>
<span class="sd">        that invokes setup_method/teardown_method if either or both are available.</span>

<span class="sd">        Using a fixture to invoke these methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_name</span> <span class="o">=</span> <span class="s2">&quot;setup_method&quot;</span>
        <span class="n">setup_method</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">setup_name</span><span class="p">,))</span>
        <span class="n">teardown_name</span> <span class="o">=</span> <span class="s2">&quot;teardown_method&quot;</span>
        <span class="n">teardown_method</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">teardown_name</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">setup_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">xunit_setup_method_fixture</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">instance</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">function</span>
            <span class="k">if</span> <span class="n">setup_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">setup_name</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">teardown_name</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">_register_fixture</span><span class="p">(</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_xunit_setup_method_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="n">xunit_setup_method_fixture</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">hasinit</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">init</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">init</span> <span class="o">!=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">hasnew</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">new</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new</span> <span class="o">!=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@final</span>
<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">IdMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make IDs for a parametrization.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;argnames&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parametersets&quot;</span><span class="p">,</span>
        <span class="s2">&quot;idfn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ids&quot;</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nodeid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;func_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># The argnames of the parametrization.</span>
    <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="c1"># The ParameterSets of the parametrization.</span>
    <span class="n">parametersets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParameterSet</span><span class="p">]</span>
    <span class="c1"># Optionally, a user-provided callable to make IDs for parameters in a</span>
    <span class="c1"># ParameterSet.</span>
    <span class="n">idfn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="c1"># Optionally, explicit IDs for ParameterSets by index.</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="c1"># Optionally, the pytest config.</span>
    <span class="c1"># Used for controlling ASCII escaping, and for calling the</span>
    <span class="c1"># :hook:`pytest_make_parametrize_id` hook.</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="c1"># Optionally, the ID of the node being parametrized.</span>
    <span class="c1"># Used only for clearer error messages.</span>
    <span class="n">nodeid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="c1"># Optionally, the ID of the function being parametrized.</span>
    <span class="c1"># Used only for clearer error messages.</span>
    <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">make_unique_parameterset_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a unique identifier for each ParameterSet, that may be used to</span>
<span class="sd">        identify the parametrization in a node ID.</span>

<span class="sd">        Format is &lt;prm_1_token&gt;-...-&lt;prm_n_token&gt;[counter], where prm_x_token is</span>
<span class="sd">        - user-provided id, if given</span>
<span class="sd">        - else an id derived from the value, applicable for certain types</span>
<span class="sd">        - else &lt;argname&gt;&lt;parameterset index&gt;</span>
<span class="sd">        The counter suffix is appended only in case a string wouldn&#39;t be unique</span>
<span class="sd">        otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolve_ids</span><span class="p">())</span>
        <span class="c1"># All IDs must be unique!</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">)):</span>
            <span class="c1"># Record the number of occurrences of each ID.</span>
            <span class="n">id_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">)</span>
            <span class="c1"># Map the ID to its next suffix.</span>
            <span class="n">id_suffixes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># Suffix non-unique IDs to make them unique.</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">id_counts</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="nb">id</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span>
                    <span class="n">new_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">id</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}{</span><span class="n">id_suffixes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">while</span> <span class="n">new_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">):</span>
                        <span class="n">id_suffixes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">new_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">id</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}{</span><span class="n">id_suffixes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">resolved_ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_id</span>
                    <span class="n">id_suffixes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">)</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Internal error: </span><span class="si">{</span><span class="n">resolved_ids</span><span class="si">=}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">resolved_ids</span>

    <span class="k">def</span> <span class="nf">_resolve_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve IDs for all ParameterSets (may contain duplicates).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">parameterset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parametersets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">parameterset</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># ID provided directly - pytest.param(..., id=&quot;...&quot;)</span>
                <span class="k">yield</span> <span class="n">_ascii_escaped_by_config</span><span class="p">(</span><span class="n">parameterset</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># ID provided in the IDs list - parametrize(..., ids=[...]).</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idval_from_value_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ID not provided - generate it.</span>
                <span class="k">yield</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">argname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameterset</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">argnames</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_idval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">argname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make an ID for a parameter in a ParameterSet.&quot;&quot;&quot;</span>
        <span class="n">idval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idval_from_function</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idval</span>
        <span class="n">idval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idval_from_hook</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idval</span>
        <span class="n">idval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idval_from_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idval</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idval_from_argname</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_idval_from_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">argname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to make an ID for a parameter in a ParameterSet using the</span>
<span class="sd">        user-provided id callable, if given.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idfn</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;error raised while trying to determine id of parameter &#39;</span><span class="si">{}</span><span class="s2">&#39; at position </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idval_from_value</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_idval_from_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">argname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to make an ID for a parameter in a ParameterSet by calling the</span>
<span class="sd">        :hook:`pytest_make_parametrize_id` hook.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_make_parametrize_id</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="n">argname</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nb">id</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_idval_from_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to make an ID for a parameter in a ParameterSet from its value,</span>
<span class="sd">        if the value type is supported.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">_ascii_escaped_by_config</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="c1"># Fallback to default. Note that NOTSET is an enum.Enum.</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Name of a class, function, module, etc.</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_idval_from_value_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Like _idval_from_value(), but fails if the type is not supported.&quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idval_from_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span>

        <span class="c1"># Fail.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="si">}</span><span class="s2">: &quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="si">}</span><span class="s2">: &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ids contains unsupported value </span><span class="si">{</span><span class="n">saferepr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2"> (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">!r}</span><span class="s2">) at index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;Supported types are: str, bytes, int, float, complex, bool, enum, regex or anything with a __name__.&quot;</span>
        <span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_idval_from_argname</span><span class="p">(</span><span class="n">argname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make an ID for a parameter in a ParameterSet from the argument name</span>
<span class="sd">        and the index of the ParameterSet.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>


<span class="nd">@final</span>
<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CallSpec2</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A planned parameterized invocation of a test function.</span>

<span class="sd">    Calculated during collection for a given test function&#39;s Metafunc.</span>
<span class="sd">    Once collection is over, each callspec is turned into a single Item</span>
<span class="sd">    and stored in item.callspec.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># arg name -&gt; arg value which will be passed to a fixture or pseudo-fixture</span>
    <span class="c1"># of the same name. (indirect or direct parametrization respectively)</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># arg name -&gt; arg index.</span>
    <span class="n">indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Used for sorting parametrized resources.</span>
    <span class="n">_arg2scope</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Scope</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Parts which will be added to the item&#39;s name in `[..]` separated by &quot;-&quot;.</span>
    <span class="n">_idlist</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="c1"># Marks which will be applied to the item.</span>
    <span class="n">marks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Mark</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setmulti</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">valset</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">marks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Mark</span> <span class="o">|</span> <span class="n">MarkDecorator</span><span class="p">],</span>
        <span class="n">scope</span><span class="p">:</span> <span class="n">Scope</span><span class="p">,</span>
        <span class="n">param_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CallSpec2</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">arg2scope</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arg2scope</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">valset</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;duplicate parametrization of </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_index</span>
            <span class="n">arg2scope</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope</span>
        <span class="k">return</span> <span class="n">CallSpec2</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
            <span class="n">_arg2scope</span><span class="o">=</span><span class="n">arg2scope</span><span class="p">,</span>
            <span class="n">_idlist</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span>
            <span class="n">marks</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">,</span> <span class="o">*</span><span class="n">normalize_mark_list</span><span class="p">(</span><span class="n">marks</span><span class="p">)],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">getparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_direct_param_fixture_func</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">FixtureRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="c1"># Used for storing pseudo fixturedefs for direct parametrization.</span>
<span class="n">name2pseudofixturedef_key</span> <span class="o">=</span> <span class="n">StashKey</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FixtureDef</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]()</span>


<div class="viewcode-block" id="Metafunc">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Metafunc">[docs]</a>
<span class="nd">@final</span>
<span class="k">class</span> <span class="nc">Metafunc</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Objects passed to the :hook:`pytest_generate_tests` hook.</span>

<span class="sd">    They help to inspect a test function and to generate tests according to</span>
<span class="sd">    test configuration or values specified in the class or module where a</span>
<span class="sd">    test function is defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">definition</span><span class="p">:</span> <span class="n">FunctionDefinition</span><span class="p">,</span>
        <span class="n">fixtureinfo</span><span class="p">:</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">FuncFixtureInfo</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span>
        <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_ispytest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_ispytest</span><span class="p">(</span><span class="n">_ispytest</span><span class="p">)</span>

        <span class="c1">#: Access to the underlying :class:`_pytest.python.FunctionDefinition`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span>

        <span class="c1">#: Access to the :class:`pytest.Config` object for the test session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1">#: The module object where the test function is defined in.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>

        <span class="c1">#: Underlying Python test function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">obj</span>

        <span class="c1">#: Set of fixture names required by the test function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">names_closure</span>

        <span class="c1">#: Class object where the test function is defined in or ``None``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">name2fixturedefs</span>

        <span class="c1"># Result of parametrize().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CallSpec2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_params_directness</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Metafunc.parametrize">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Metafunc.parametrize">[docs]</a>
    <span class="k">def</span> <span class="nf">parametrize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">argvalues</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ParameterSet</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">indirect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scope</span><span class="p">:</span> <span class="n">_ScopeName</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_param_mark</span><span class="p">:</span> <span class="n">Mark</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add new invocations to the underlying test function using the list</span>
<span class="sd">        of argvalues for the given argnames. Parametrization is performed</span>
<span class="sd">        during the collection phase. If you need to setup expensive resources</span>
<span class="sd">        see about setting indirect to do it rather than at test setup time.</span>

<span class="sd">        Can be called multiple times per test function (but only on different</span>
<span class="sd">        argument names), in which case each call parametrizes all previous</span>
<span class="sd">        parametrizations, e.g.</span>

<span class="sd">        ::</span>

<span class="sd">            unparametrized:         t</span>
<span class="sd">            parametrize [&quot;x&quot;, &quot;y&quot;]: t[x], t[y]</span>
<span class="sd">            parametrize [1, 2]:     t[x-1], t[x-2], t[y-1], t[y-2]</span>

<span class="sd">        :param argnames:</span>
<span class="sd">            A comma-separated string denoting one or more argument names, or</span>
<span class="sd">            a list/tuple of argument strings.</span>

<span class="sd">        :param argvalues:</span>
<span class="sd">            The list of argvalues determines how often a test is invoked with</span>
<span class="sd">            different argument values.</span>

<span class="sd">            If only one argname was specified argvalues is a list of values.</span>
<span class="sd">            If N argnames were specified, argvalues must be a list of</span>
<span class="sd">            N-tuples, where each tuple-element specifies a value for its</span>
<span class="sd">            respective argname.</span>
<span class="sd">        :type argvalues: Iterable[_pytest.mark.structures.ParameterSet | Sequence[object] | object]</span>
<span class="sd">        :param indirect:</span>
<span class="sd">            A list of arguments&#39; names (subset of argnames) or a boolean.</span>
<span class="sd">            If True the list contains all names from the argnames. Each</span>
<span class="sd">            argvalue corresponding to an argname in this list will</span>
<span class="sd">            be passed as request.param to its respective argname fixture</span>
<span class="sd">            function so that it can perform more expensive setups during the</span>
<span class="sd">            setup phase of a test rather than at collection time.</span>

<span class="sd">        :param ids:</span>
<span class="sd">            Sequence of (or generator for) ids for ``argvalues``,</span>
<span class="sd">            or a callable to return part of the id for each argvalue.</span>

<span class="sd">            With sequences (and generators like ``itertools.count()``) the</span>
<span class="sd">            returned ids should be of type ``string``, ``int``, ``float``,</span>
<span class="sd">            ``bool``, or ``None``.</span>
<span class="sd">            They are mapped to the corresponding index in ``argvalues``.</span>
<span class="sd">            ``None`` means to use the auto-generated id.</span>

<span class="sd">            If it is a callable it will be called for each entry in</span>
<span class="sd">            ``argvalues``, and the return value is used as part of the</span>
<span class="sd">            auto-generated id for the whole set (where parts are joined with</span>
<span class="sd">            dashes (&quot;-&quot;)).</span>
<span class="sd">            This is useful to provide more specific ids for certain items, e.g.</span>
<span class="sd">            dates.  Returning ``None`` will use an auto-generated id.</span>

<span class="sd">            If no ids are provided they will be generated automatically from</span>
<span class="sd">            the argvalues.</span>

<span class="sd">        :param scope:</span>
<span class="sd">            If specified it denotes the scope of the parameters.</span>
<span class="sd">            The scope is used for grouping tests by parameter instances.</span>
<span class="sd">            It will also override any fixture-function defined scope, allowing</span>
<span class="sd">            to set a dynamic scope using test context or configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argnames</span><span class="p">,</span> <span class="n">parametersets</span> <span class="o">=</span> <span class="n">ParameterSet</span><span class="o">.</span><span class="n">_for_parametrize</span><span class="p">(</span>
            <span class="n">argnames</span><span class="p">,</span>
            <span class="n">argvalues</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">argvalues</span>

        <span class="k">if</span> <span class="s2">&quot;request&quot;</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
            <span class="n">fail</span><span class="p">(</span>
                <span class="s2">&quot;&#39;request&#39; is a reserved name and cannot be used in @pytest.mark.parametrize&quot;</span><span class="p">,</span>
                <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scope_</span> <span class="o">=</span> <span class="n">Scope</span><span class="o">.</span><span class="n">from_user</span><span class="p">(</span>
                <span class="n">scope</span><span class="p">,</span> <span class="n">descr</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;parametrize() call in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scope_</span> <span class="o">=</span> <span class="n">_find_parametrized_scope</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_if_using_arg_names</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="c1"># Use any already (possibly) generated ids with parametrize Marks.</span>
        <span class="k">if</span> <span class="n">_param_mark</span> <span class="ow">and</span> <span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span><span class="p">:</span>
            <span class="n">generated_ids</span> <span class="o">=</span> <span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span><span class="o">.</span><span class="n">_param_ids_generated</span>
            <span class="k">if</span> <span class="n">generated_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">generated_ids</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_parameter_set_ids</span><span class="p">(</span>
            <span class="n">argnames</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">parametersets</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">nodeid</span>
        <span class="p">)</span>

        <span class="c1"># Store used (possibly generated) ids with parametrize Marks.</span>
        <span class="k">if</span> <span class="n">_param_mark</span> <span class="ow">and</span> <span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span> <span class="ow">and</span> <span class="n">generated_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span><span class="p">,</span> <span class="s2">&quot;_param_ids_generated&quot;</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

        <span class="c1"># Add funcargs as fixturedefs to fixtureinfo.arg2fixturedefs by registering</span>
        <span class="c1"># artificial &quot;pseudo&quot; FixtureDef&#39;s so that later at test execution time we can</span>
        <span class="c1"># rely on a proper FixtureDef to exist for fixture setup.</span>
        <span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># If we have a scope that is higher than function, we need</span>
        <span class="c1"># to make sure we only ever create an according fixturedef on</span>
        <span class="c1"># a per-scope basis. We thus store and cache the fixturedef on the</span>
        <span class="c1"># node related to the scope.</span>
        <span class="k">if</span> <span class="n">scope_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Scope</span><span class="o">.</span><span class="n">Function</span><span class="p">:</span>
            <span class="n">collector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">assert</span> <span class="n">collector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">get_scope_node</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">scope_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If used class scope and there is no class, use module-level</span>
                <span class="c1"># collector (for now).</span>
                <span class="k">if</span> <span class="n">scope_</span> <span class="ow">is</span> <span class="n">Scope</span><span class="o">.</span><span class="n">Class</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">Module</span><span class="p">)</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">collector</span>
                <span class="c1"># If used package scope and there is no package, use session</span>
                <span class="c1"># (for now).</span>
                <span class="k">elif</span> <span class="n">scope_</span> <span class="ow">is</span> <span class="n">Scope</span><span class="o">.</span><span class="n">Package</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">session</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unhandled missing scope: </span><span class="si">{</span><span class="n">scope</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name2pseudofixturedef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FixtureDef</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">name2pseudofixturedef</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">stash</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="n">name2pseudofixturedef_key</span><span class="p">,</span> <span class="n">default</span>
            <span class="p">)</span>
        <span class="n">arg_directness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_args_directness</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params_directness</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg_directness</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg_directness</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;indirect&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name2pseudofixturedef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">name2pseudofixturedef</span><span class="p">:</span>
                <span class="n">fixturedef</span> <span class="o">=</span> <span class="n">name2pseudofixturedef</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixturedef</span> <span class="o">=</span> <span class="n">FixtureDef</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">baseid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">argname</span><span class="o">=</span><span class="n">argname</span><span class="p">,</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">get_direct_param_fixture_func</span><span class="p">,</span>
                    <span class="n">scope</span><span class="o">=</span><span class="n">scope_</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">name2pseudofixturedef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name2pseudofixturedef</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixturedef</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fixturedef</span><span class="p">]</span>

        <span class="c1"># Create the new calls: if we are parametrize() multiple times (by applying the decorator</span>
        <span class="c1"># more than once) then we accumulate those calls generating the cartesian product</span>
        <span class="c1"># of all calls.</span>
        <span class="n">newcalls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="ow">or</span> <span class="p">[</span><span class="n">CallSpec2</span><span class="p">()]:</span>
            <span class="k">for</span> <span class="n">param_index</span><span class="p">,</span> <span class="p">(</span><span class="n">param_id</span><span class="p">,</span> <span class="n">param_set</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">parametersets</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">newcallspec</span> <span class="o">=</span> <span class="n">callspec</span><span class="o">.</span><span class="n">setmulti</span><span class="p">(</span>
                    <span class="n">argnames</span><span class="o">=</span><span class="n">argnames</span><span class="p">,</span>
                    <span class="n">valset</span><span class="o">=</span><span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">param_id</span><span class="p">,</span>
                    <span class="n">marks</span><span class="o">=</span><span class="n">param_set</span><span class="o">.</span><span class="n">marks</span><span class="p">,</span>
                    <span class="n">scope</span><span class="o">=</span><span class="n">scope_</span><span class="p">,</span>
                    <span class="n">param_index</span><span class="o">=</span><span class="n">param_index</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">newcalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newcallspec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="o">=</span> <span class="n">newcalls</span></div>


    <span class="k">def</span> <span class="nf">_resolve_parameter_set_ids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parametersets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParameterSet</span><span class="p">],</span>
        <span class="n">nodeid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve the actual ids for the given parameter sets.</span>

<span class="sd">        :param argnames:</span>
<span class="sd">            Argument names passed to ``parametrize()``.</span>
<span class="sd">        :param ids:</span>
<span class="sd">            The `ids` parameter of the ``parametrize()`` call (see docs).</span>
<span class="sd">        :param parametersets:</span>
<span class="sd">            The parameter sets, each containing a set of values corresponding</span>
<span class="sd">            to ``argnames``.</span>
<span class="sd">        :param nodeid str:</span>
<span class="sd">            The nodeid of the definition item that generated this</span>
<span class="sd">            parametrization.</span>
<span class="sd">        :returns:</span>
<span class="sd">            List with ids for each parameter set given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idfn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ids_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">idfn</span> <span class="o">=</span> <span class="n">ids</span>
            <span class="n">ids_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idfn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ids_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_ids</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">parametersets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">id_maker</span> <span class="o">=</span> <span class="n">IdMaker</span><span class="p">(</span>
            <span class="n">argnames</span><span class="p">,</span>
            <span class="n">parametersets</span><span class="p">,</span>
            <span class="n">idfn</span><span class="p">,</span>
            <span class="n">ids_</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span><span class="p">,</span>
            <span class="n">func_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">id_maker</span><span class="o">.</span><span class="n">make_unique_parameterset_ids</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_validate_ids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">parametersets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParameterSet</span><span class="p">],</span>
        <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">iter</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ids must be a callable or an iterable&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="n">num_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parametersets</span><span class="p">)</span>

        <span class="c1"># num_ids == 0 is a special case: https://github.com/pytest-dev/pytest/issues/1849</span>
        <span class="k">if</span> <span class="n">num_ids</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parametersets</span><span class="p">)</span> <span class="ow">and</span> <span class="n">num_ids</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> parameter sets specified, with different number of ids: </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">parametersets</span><span class="p">),</span> <span class="n">num_ids</span><span class="p">),</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">num_ids</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_resolve_args_directness</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">indirect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve if each parametrized argument must be considered an indirect</span>
<span class="sd">        parameter to a fixture of the same name, or a direct parameter to the</span>
<span class="sd">        parametrized function, based on the ``indirect`` parameter of the</span>
<span class="sd">        parametrized() call.</span>

<span class="sd">        :param argnames:</span>
<span class="sd">            List of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param indirect:</span>
<span class="sd">            Same as the ``indirect`` parameter of ``parametrize()``.</span>
<span class="sd">        :returns</span>
<span class="sd">            A dict mapping each arg name to either &quot;indirect&quot; or &quot;direct&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arg_directness</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">arg_directness</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                <span class="n">argnames</span><span class="p">,</span> <span class="s2">&quot;indirect&quot;</span> <span class="k">if</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;direct&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="n">arg_directness</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">indirect</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: indirect fixture &#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&#39; doesn&#39;t exist&quot;</span><span class="p">,</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">arg_directness</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: expected Sequence or boolean&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; for indirect, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">arg_directness</span>

    <span class="k">def</span> <span class="nf">_validate_if_using_arg_names</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">indirect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if all argnames are being used, by default values, or directly/indirectly.</span>

<span class="sd">        :param List[str] argnames: List of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param indirect: Same as the ``indirect`` parameter of ``parametrize()``.</span>
<span class="sd">        :raises ValueError: If validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_arg_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_default_arg_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">))</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arg_names</span><span class="p">:</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">: function already takes an argument &#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&#39; with a default value&quot;</span><span class="p">,</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fixture&quot;</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;argument&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fixture&quot;</span> <span class="k">if</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;argument&quot;</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">: function uses no </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_direct_params_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">param_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params_directness</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">):</span>
                    <span class="n">callspec</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span></div>



<span class="k">def</span> <span class="nf">_find_parametrized_scope</span><span class="p">(</span>
    <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">arg2fixturedefs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">fixtures</span><span class="o">.</span><span class="n">FixtureDef</span><span class="p">[</span><span class="nb">object</span><span class="p">]]],</span>
    <span class="n">indirect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Scope</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the most appropriate scope for a parametrized call based on its arguments.</span>

<span class="sd">    When there&#39;s at least one direct argument, always use &quot;function&quot; scope.</span>

<span class="sd">    When a test function is parametrized and all its arguments are indirect</span>
<span class="sd">    (e.g. fixtures), return the most narrow scope based on the fixtures used.</span>

<span class="sd">    Related to issue #1832, based on code posted by @Kingdread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
        <span class="n">all_arguments_are_fixtures</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_arguments_are_fixtures</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_arguments_are_fixtures</span><span class="p">:</span>
        <span class="n">fixturedefs</span> <span class="o">=</span> <span class="n">arg2fixturedefs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">used_scopes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fixturedef</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_scope</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">argnames</span>
        <span class="p">]</span>
        <span class="c1"># Takes the most narrow scope from used fixtures.</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">used_scopes</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Scope</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Scope</span><span class="o">.</span><span class="n">Function</span>


<span class="k">def</span> <span class="nf">_ascii_escaped_by_config</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">escape_option</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">escape_option</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span>
            <span class="s2">&quot;disable_test_id_escaping_and_forfeit_all_rights_to_community_support&quot;</span>
        <span class="p">)</span>
    <span class="c1"># TODO: If escaping is turned off and the user passes bytes,</span>
    <span class="c1">#       will return a bytes. For now we ignore this but the</span>
    <span class="c1">#       code *probably* doesn&#39;t handle this case.</span>
    <span class="k">return</span> <span class="n">val</span> <span class="k">if</span> <span class="n">escape_option</span> <span class="k">else</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<div class="viewcode-block" id="Function">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Function">[docs]</a>
<span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="n">PyobjMixin</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Item responsible for setting up and executing a Python test function.</span>

<span class="sd">    :param name:</span>
<span class="sd">        The full function name, including any decorations like those</span>
<span class="sd">        added by parametrization (``my_func[my_param]``).</span>
<span class="sd">    :param parent:</span>
<span class="sd">        The parent Node.</span>
<span class="sd">    :param config:</span>
<span class="sd">        The pytest Config object.</span>
<span class="sd">    :param callspec:</span>
<span class="sd">        If given, this function has been parametrized and the callspec contains</span>
<span class="sd">        meta information about the parametrization.</span>
<span class="sd">    :param callobj:</span>
<span class="sd">        If given, the object which will be called when the Function is invoked,</span>
<span class="sd">        otherwise the callobj will be obtained from ``parent`` using ``originalname``.</span>
<span class="sd">    :param keywords:</span>
<span class="sd">        Keywords bound to the function object for &quot;-k&quot; matching.</span>
<span class="sd">    :param session:</span>
<span class="sd">        The pytest Session object.</span>
<span class="sd">    :param fixtureinfo:</span>
<span class="sd">        Fixture information already resolved at this fixture node..</span>
<span class="sd">    :param originalname:</span>
<span class="sd">        The attribute name to use for accessing the underlying function object.</span>
<span class="sd">        Defaults to ``name``. Set this if name is different from the original name,</span>
<span class="sd">        for example when it contains decorations like those added by parametrization</span>
<span class="sd">        (``my_func[my_param]``).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Disable since functions handle it themselves.</span>
    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callspec</span><span class="p">:</span> <span class="n">CallSpec2</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callobj</span><span class="o">=</span><span class="n">NOTSET</span><span class="p">,</span>
        <span class="n">keywords</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fixtureinfo</span><span class="p">:</span> <span class="n">FuncFixtureInfo</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">originalname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">callobj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callobj</span><span class="p">,</span> <span class="s2">&quot;__self__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1">#: Original function name, without any decorations (for example</span>
        <span class="c1">#: parametrization adds a ``&quot;[...]&quot;`` suffix to function names), used to access</span>
        <span class="c1">#: the underlying function object from ``parent`` (in case ``callobj`` is not given</span>
        <span class="c1">#: explicitly).</span>
        <span class="c1">#:</span>
        <span class="c1">#: .. versionadded:: 3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalname</span> <span class="o">=</span> <span class="n">originalname</span> <span class="ow">or</span> <span class="n">name</span>

        <span class="c1"># Note: when FunctionDefinition is introduced, we should change ``originalname``</span>
        <span class="c1"># to a readonly property that returns FunctionDefinition.name.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_unpacked_marks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">callspec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callspec</span> <span class="o">=</span> <span class="n">callspec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">callspec</span><span class="o">.</span><span class="n">marks</span><span class="p">)</span>

        <span class="c1"># todo: this is a hell of a hack</span>
        <span class="c1"># https://github.com/pytest-dev/pytest/issues/4569</span>
        <span class="c1"># Note: the order of the updates is important here; indicates what</span>
        <span class="c1"># takes priority (ctor argument over function attributes over markers).</span>
        <span class="c1"># Take own_markers only; NodeKeywords handles parent traversal on its own.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">mark</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span> <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fixtureinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>
            <span class="n">fixtureinfo</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getfixtureinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixtureinfo</span><span class="p">:</span> <span class="n">FuncFixtureInfo</span> <span class="o">=</span> <span class="n">fixtureinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">names_closure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initrequest</span><span class="p">()</span>

    <span class="c1"># todo: determine sound type limitations</span>
<div class="viewcode-block" id="Function.from_parent">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Function.from_parent">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_parent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The public constructor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_initrequest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">TopRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Underlying python &#39;function&#39; object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">getimfunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Class</span><span class="p">):</span>
                <span class="c1"># Each Function gets a fresh class instance.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getinstance</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span>

    <span class="k">def</span> <span class="nf">_getinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Class</span><span class="p">):</span>
            <span class="c1"># Each Function gets a fresh class instance.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">newinstance</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent_obj</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">parent_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">originalname</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_pyfuncitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(compatonly) for code expecting pytest-2.2 style request objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Function.runtest">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Function.runtest">[docs]</a>
    <span class="k">def</span> <span class="nf">runtest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the underlying test function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_fillfixtures</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_traceback_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">:</span> <span class="n">ExceptionInfo</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Traceback</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_obj&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;fulltrace&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">_code</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span><span class="n">get_real_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">firstlineno</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">firstlineno</span>
            <span class="n">traceback</span> <span class="o">=</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span>
            <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">firstlineno</span><span class="o">=</span><span class="n">firstlineno</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ntraceback</span> <span class="o">==</span> <span class="n">traceback</span><span class="p">:</span>
                <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ntraceback</span> <span class="o">==</span> <span class="n">traceback</span><span class="p">:</span>
                    <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_traceback</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ntraceback</span><span class="p">:</span>
                        <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">traceback</span>
            <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">excinfo</span><span class="p">)</span>

            <span class="c1"># issue364: mark all but first and last frames to</span>
            <span class="c1"># only show a single-line message for each frame.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;tbstyle&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ntraceback</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">Traceback</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">ntraceback</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">with_repr_style</span><span class="p">(</span><span class="s2">&quot;short&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ntraceback</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">ntraceback</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">return</span> <span class="n">ntraceback</span>
        <span class="k">return</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span>

    <span class="c1"># TODO: Type ignored -- breaks Liskov Substitution.</span>
<div class="viewcode-block" id="Function.repr_failure">
<a class="viewcode-back" href="../../reference/reference.html#pytest.Function.repr_failure">[docs]</a>
    <span class="k">def</span> <span class="nf">repr_failure</span><span class="p">(</span>  <span class="c1"># type: ignore[override]</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">excinfo</span><span class="p">:</span> <span class="n">ExceptionInfo</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">TerminalRepr</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;tbstyle&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;long&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_failure_py</span><span class="p">(</span><span class="n">excinfo</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="FunctionDefinition">
<a class="viewcode-back" href="../../reference/reference.html#pytest.FunctionDefinition">[docs]</a>
<span class="k">class</span> <span class="nc">FunctionDefinition</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class is a stop gap solution until we evolve to have actual function</span>
<span class="sd">    definition nodes and manage to get rid of ``metafunc``.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FunctionDefinition.runtest">
<a class="viewcode-back" href="../../reference/reference.html#pytest.FunctionDefinition.runtest">[docs]</a>
    <span class="k">def</span> <span class="nf">runtest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;function definitions are not supposed to be run as tests&quot;</span><span class="p">)</span></div>


    <span class="n">setup</span> <span class="o">=</span> <span class="n">runtest</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2015, holger krekel and pytest-dev team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=7c91f8fd"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>